
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.4">
    
    
      
        <title>Astrobee - pyastrobee</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.80dcb947.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue-grey" data-md-color-accent="pink">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-pyastrobeecoreastrobee" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="pyastrobee" class="md-header__button md-logo" aria-label="pyastrobee" data-md-component="logo">
      
  <img src="../../../../images/favicon_large.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pyastrobee
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Astrobee
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/danielpmorton/pyastrobee" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    pyastrobee
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="pyastrobee" class="md-nav__button md-logo" aria-label="pyastrobee" data-md-component="logo">
      
  <img src="../../../../images/favicon_large.png" alt="logo">

    </a>
    pyastrobee
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/danielpmorton/pyastrobee" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    pyastrobee
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/additional_installs/" class="md-nav__link">
        Additional Installs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/bag_dynamics/" class="md-nav__link">
        Bag Dynamics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/getting_started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/loading_iss_meshes/" class="md-nav__link">
        Loading Iss Meshes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/meshing/" class="md-nav__link">
        Meshing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/nasa_sim/" class="md-nav__link">
        Nasa Sim
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/pybullet_tips/" class="md-nav__link">
        Pybullet Tips
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/retexturing/" class="md-nav__link">
        Retexturing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/tet_meshing/" class="md-nav__link">
        Tet Meshing
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13" type="checkbox" id="__nav_13" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_13">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1" type="checkbox" id="__nav_13_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1">
          Pyastrobee
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pyastrobee" data-md-level="2">
        <label class="md-nav__title" for="__nav_13_1">
          <span class="md-nav__icon md-icon"></span>
          Pyastrobee
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1_2" type="checkbox" id="__nav_13_1_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1_2">
          Config
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Config" data-md-level="3">
        <label class="md-nav__title" for="__nav_13_1_2">
          <span class="md-nav__icon md-icon"></span>
          Config
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/astrobee_geom/" class="md-nav__link">
        Astrobee Geom
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/astrobee_motion/" class="md-nav__link">
        Astrobee Motion
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/astrobee_transforms/" class="md-nav__link">
        Astrobee Transforms
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/bag_properties/" class="md-nav__link">
        Bag Properties
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/iss_paths/" class="md-nav__link">
        Iss Paths
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/iss_safe_boxes/" class="md-nav__link">
        Iss Safe Boxes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1_3" type="checkbox" id="__nav_13_1_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1_3">
          Control
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Control" data-md-level="3">
        <label class="md-nav__title" for="__nav_13_1_3">
          <span class="md-nav__icon md-icon"></span>
          Control
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/constraint_controller/" class="md-nav__link">
        Constraint Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/force_torque_control/" class="md-nav__link">
        Force Torque Control
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/keyboard_controller/" class="md-nav__link">
        Keyboard Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/metrics/" class="md-nav__link">
        Metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/multi_robot/" class="md-nav__link">
        Multi Robot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/sampling_mpc/" class="md-nav__link">
        Sampling Mpc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/sampling_mpc_multithreaded/" class="md-nav__link">
        Sampling Mpc Multithreaded
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1_4" type="checkbox" id="__nav_13_1_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1_4">
          Core
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Core" data-md-level="3">
        <label class="md-nav__title" for="__nav_13_1_4">
          <span class="md-nav__icon md-icon"></span>
          Core
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../abstract_bag/" class="md-nav__link">
        Abstract Bag
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Astrobee
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Astrobee
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#astrobee" class="md-nav__link">
    Astrobee
  </a>
  
    <nav class="md-nav" aria-label="Astrobee">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-variables" class="md-nav__link">
    Class variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instance-variables" class="md-nav__link">
    Instance variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#close_gripper" class="md-nav__link">
    close_gripper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy_arm" class="md-nav__link">
    deploy_arm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_jacobians" class="md-nav__link">
    get_jacobians
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_joint_angles" class="md-nav__link">
    get_joint_angles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_link_transform" class="md-nav__link">
    get_link_transform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#localize" class="md-nav__link">
    localize
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#open_gripper" class="md-nav__link">
    open_gripper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recompute_inertial_properties" class="md-nav__link">
    recompute_inertial_properties
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_full_state" class="md-nav__link">
    reset_full_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_to_base_pose" class="md-nav__link">
    reset_to_base_pose
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_to_ee_pose" class="md-nav__link">
    reset_to_ee_pose
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_arm_joints" class="md-nav__link">
    set_arm_joints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_gripper_joints" class="md-nav__link">
    set_gripper_joints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_gripper_position" class="md-nav__link">
    set_gripper_position
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_joint_angles" class="md-nav__link">
    set_joint_angles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#store_arm" class="md-nav__link">
    store_arm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unload" class="md-nav__link">
    unload
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../composite_bag/" class="md-nav__link">
        Composite Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../constraint_bag/" class="md-nav__link">
        Constraint Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deformable_bag/" class="md-nav__link">
        Deformable Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../environments/" class="md-nav__link">
        Environments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hybrid_bag/" class="md-nav__link">
        Hybrid Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../iss/" class="md-nav__link">
        Iss
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rigid_bag/" class="md-nav__link">
        Rigid Bag
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1_5" type="checkbox" id="__nav_13_1_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1_5">
          Trajectories
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Trajectories" data-md-level="3">
        <label class="md-nav__title" for="__nav_13_1_5">
          <span class="md-nav__icon md-icon"></span>
          Trajectories
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/arm_planner/" class="md-nav__link">
        Arm Planner
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/bezier/" class="md-nav__link">
        Bezier
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/bezier_slerp/" class="md-nav__link">
        Bezier Slerp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/box_paths/" class="md-nav__link">
        Box Paths
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/curve_utils/" class="md-nav__link">
        Curve Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/decasteljau_slerp/" class="md-nav__link">
        Decasteljau Slerp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/face_forward/" class="md-nav__link">
        Face Forward
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/multi_robot_trajs/" class="md-nav__link">
        Multi Robot Trajs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/planner/" class="md-nav__link">
        Planner
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/polynomials/" class="md-nav__link">
        Polynomials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/quaternion_interpolation/" class="md-nav__link">
        Quaternion Interpolation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/sampling/" class="md-nav__link">
        Sampling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/simple_trajectories/" class="md-nav__link">
        Simple Trajectories
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/splines/" class="md-nav__link">
        Splines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/timing/" class="md-nav__link">
        Timing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/trajectory/" class="md-nav__link">
        Trajectory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/variable_time_curves/" class="md-nav__link">
        Variable Time Curves
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1_6" type="checkbox" id="__nav_13_1_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1_6">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="3">
        <label class="md-nav__title" for="__nav_13_1_6">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/algos/" class="md-nav__link">
        Algos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/bag_frame/" class="md-nav__link">
        Bag Frame
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/boxes/" class="md-nav__link">
        Boxes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/bullet_utils/" class="md-nav__link">
        Bullet Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/debug_visualizer/" class="md-nav__link">
        Debug Visualizer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/dynamics/" class="md-nav__link">
        Dynamics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/math_utils/" class="md-nav__link">
        Math Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/mesh_utils/" class="md-nav__link">
        Mesh Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/poses/" class="md-nav__link">
        Poses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/python_utils/" class="md-nav__link">
        Python Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/quaternion_derivatives/" class="md-nav__link">
        Quaternion Derivatives
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/quaternions/" class="md-nav__link">
        Quaternions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/rotations/" class="md-nav__link">
        Rotations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/transformations/" class="md-nav__link">
        Transformations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/video_concatenation/" class="md-nav__link">
        Video Concatenation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#astrobee" class="md-nav__link">
    Astrobee
  </a>
  
    <nav class="md-nav" aria-label="Astrobee">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-variables" class="md-nav__link">
    Class variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instance-variables" class="md-nav__link">
    Instance variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#close_gripper" class="md-nav__link">
    close_gripper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy_arm" class="md-nav__link">
    deploy_arm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_jacobians" class="md-nav__link">
    get_jacobians
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_joint_angles" class="md-nav__link">
    get_joint_angles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_link_transform" class="md-nav__link">
    get_link_transform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#localize" class="md-nav__link">
    localize
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#open_gripper" class="md-nav__link">
    open_gripper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recompute_inertial_properties" class="md-nav__link">
    recompute_inertial_properties
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_full_state" class="md-nav__link">
    reset_full_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_to_base_pose" class="md-nav__link">
    reset_to_base_pose
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_to_ee_pose" class="md-nav__link">
    reset_to_ee_pose
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_arm_joints" class="md-nav__link">
    set_arm_joints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_gripper_joints" class="md-nav__link">
    set_gripper_joints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_gripper_position" class="md-nav__link">
    set_gripper_position
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_joint_angles" class="md-nav__link">
    set_joint_angles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#store_arm" class="md-nav__link">
    store_arm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unload" class="md-nav__link">
    unload
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/danielpmorton/pyastrobee/edit/main/reference/pyastrobee/core/astrobee.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="module-pyastrobeecoreastrobee">Module pyastrobee.core.astrobee</h1>
<p>Manages the properties of the astrobee and all control-associated functions</p>
<p>In general, we assume that we're working with Honey. Multiple astrobees can be loaded, but
we assume that they all have the exact same configuration</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Manages the properties of the astrobee and all control-associated functions</span>

<span class="sd">In general, we assume that we&#39;re working with Honey. Multiple astrobees can be loaded, but</span>

<span class="sd">we assume that they all have the exact same configuration</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Optional</span><span class="p">,</span><span class="w"> </span><span class="n">Union</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Enum</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pybullet</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pybullet_utils.bullet_client</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">BulletClient</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">npt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.utils.bullet_utils</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">initialize_pybullet</span><span class="p">,</span><span class="w"> </span><span class="n">run_sim</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.utils.transformations</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>

<span class="w">    </span><span class="n">make_transform_mat</span><span class="p">,</span>

<span class="w">    </span><span class="n">invert_transform_mat</span><span class="p">,</span>

<span class="w">    </span><span class="n">transform_point</span><span class="p">,</span>

<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.utils.rotations</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">quat_to_rmat</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.utils.poses</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">tmat_to_pos_quat</span><span class="p">,</span><span class="w"> </span><span class="n">pos_quat_to_tmat</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.config</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">astrobee_transforms</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.config.astrobee_geom</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">COLLISION_RADIUS</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.utils.python_utils</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">print_green</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.utils.dynamics</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>

<span class="w">    </span><span class="n">inertial_transformation</span><span class="p">,</span>

<span class="w">    </span><span class="n">state_matrix</span><span class="p">,</span>

<span class="w">    </span><span class="n">control_matrix</span><span class="p">,</span>

<span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Astrobee</span><span class="p">:</span>

<span class="w">    </span><span class="s2">&quot;&quot;&quot;Astrobee class for managing control, states, and properties</span>

<span class="s2">    Args:</span>

<span class="s2">        pose (npt.ArrayLike, optional): Initial pose of the astrobee when loaded. Defaults to</span>

<span class="s2">            (0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0) (At origin, pointed forward along x axis).</span>

<span class="s2">        arm_joints (npt.ArrayLike, optional): Initial position of the arm&#39;s joints. Defaults to</span>

<span class="s2">            (0.0, 0.0) (Hanging straight down)</span>

<span class="s2">        gripper_pos (float, optional): Initial gripper position, in [0, 100]. Defaults to 100 (fully open)</span>

<span class="s2">        client (BulletClient, optional): If connecting to multiple physics servers, include the client</span>

<span class="s2">            (the class instance, not just the ID) here. Defaults to None (use default connected client)</span>

<span class="s2">    Raises:</span>

<span class="s2">        ConnectionError: If a pybullet server is not connected before initialization</span>

<span class="s2">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="n">URDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;pyastrobee/assets/urdf/astrobee/astrobee.urdf&quot;</span>

<span class="w">    </span><span class="n">NUM_JOINTS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span>

<span class="w">    </span><span class="n">NUM_LINKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>

<span class="w">    </span><span class="n">TRANSFORMS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">astrobee_transforms</span><span class="w">  </span><span class="c1"># TODO figure out if this is the best way to store this info</span>

<span class="w">    </span><span class="n">GRIPPER_JOINT_IDXS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span>

<span class="w">    </span><span class="n">ARM_JOINT_IDXS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span>

<span class="w">    </span><span class="c1"># Joint limit information is extracted from the URDF</span>

<span class="w">    </span><span class="c1"># Joint pos limits are [lower, upper] for each joint</span>

<span class="w">    </span><span class="n">JOINT_POS_LIMITS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>

<span class="w">        </span><span class="p">[</span>

<span class="w">            </span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">],</span><span class="w">  </span><span class="c1"># top aft (fixed)</span>

<span class="w">            </span><span class="p">[</span><span class="o">-</span><span class="mf">2.0944</span><span class="p">,</span><span class="w"> </span><span class="mf">1.57079</span><span class="p">],</span><span class="w">  </span><span class="c1"># arm proximal joint</span>

<span class="w">            </span><span class="p">[</span><span class="o">-</span><span class="mf">1.57079</span><span class="p">,</span><span class="w"> </span><span class="mf">1.57079</span><span class="p">],</span><span class="w">  </span><span class="c1"># arm distal joint</span>

<span class="w">            </span><span class="p">[</span><span class="mf">0.349066</span><span class="p">,</span><span class="w"> </span><span class="mf">0.698132</span><span class="p">],</span><span class="w">  </span><span class="c1"># gripper left proximal joint</span>

<span class="w">            </span><span class="p">[</span><span class="o">-</span><span class="mf">1.22173</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.69813</span><span class="p">],</span><span class="w">  </span><span class="c1"># gripper left distal joint</span>

<span class="w">            </span><span class="p">[</span><span class="o">-</span><span class="mf">0.698132</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.349066</span><span class="p">],</span><span class="w">  </span><span class="c1"># gripper right proximal joint</span>

<span class="w">            </span><span class="p">[</span><span class="mf">0.69813</span><span class="p">,</span><span class="w"> </span><span class="mf">1.22173</span><span class="p">],</span><span class="w">  </span><span class="c1"># gripper right distal joint</span>

<span class="w">        </span><span class="p">]</span>

<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">JOINT_EFFORT_LIMITS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>

<span class="w">        </span><span class="p">[</span>

<span class="w">            </span><span class="mf">0.0</span><span class="p">,</span><span class="w">  </span><span class="c1"># top aft (fixed)</span>

<span class="w">            </span><span class="mf">1.0</span><span class="p">,</span><span class="w">  </span><span class="c1"># arm proximal joint</span>

<span class="w">            </span><span class="mf">1.0</span><span class="p">,</span><span class="w">  </span><span class="c1"># arm distal joint</span>

<span class="w">            </span><span class="mf">0.1</span><span class="p">,</span><span class="w">  </span><span class="c1"># gripper left proximal joint</span>

<span class="w">            </span><span class="mf">0.1</span><span class="p">,</span><span class="w">  </span><span class="c1"># gripper left distal joint</span>

<span class="w">            </span><span class="mf">0.1</span><span class="p">,</span><span class="w">  </span><span class="c1"># gripper right proximal joint</span>

<span class="w">            </span><span class="mf">0.1</span><span class="p">,</span><span class="w">  </span><span class="c1"># gripper right distal joint</span>

<span class="w">        </span><span class="p">]</span>

<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">JOINT_VEL_LIMITS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>

<span class="w">        </span><span class="p">[</span>

<span class="w">            </span><span class="mf">0.00</span><span class="p">,</span><span class="w">  </span><span class="c1"># top aft (fixed)</span>

<span class="w">            </span><span class="mf">0.12</span><span class="p">,</span><span class="w">  </span><span class="c1"># arm proximal joint</span>

<span class="w">            </span><span class="mf">0.12</span><span class="p">,</span><span class="w">  </span><span class="c1"># arm distal joint</span>

<span class="w">            </span><span class="mf">0.12</span><span class="p">,</span><span class="w">  </span><span class="c1"># gripper left proximal joint</span>

<span class="w">            </span><span class="mf">0.12</span><span class="p">,</span><span class="w">  </span><span class="c1"># gripper left distal joint</span>

<span class="w">            </span><span class="mf">0.12</span><span class="p">,</span><span class="w">  </span><span class="c1"># gripper right proximal joint</span>

<span class="w">            </span><span class="mf">0.12</span><span class="p">,</span><span class="w">  </span><span class="c1"># gripper right distal joint</span>

<span class="w">        </span><span class="p">]</span>

<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1"># Bounding sphere for collision modeling</span>

<span class="w">    </span><span class="n">COLLISION_RADIUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COLLISION_RADIUS</span>

<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Joints</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Enumerates the different joints on the astrobee via their Pybullet index&quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># Comments indicate the name of the joint in the URDF</span>

<span class="w">        </span><span class="n">ARM_BASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1"># top_aft (fixed joint)</span>

<span class="w">        </span><span class="n">ARM_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1"># top_aft_arm_proximal_joint</span>

<span class="w">        </span><span class="n">ARM_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="c1"># top_aft_arm_distal_joint</span>

<span class="w">        </span><span class="n">GRIPPER_LEFT_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="c1"># top_aft_gripper_left_proximal_joint</span>

<span class="w">        </span><span class="n">GRIPPER_LEFT_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w">  </span><span class="c1"># top_aft_gripper_left_distal_joint</span>

<span class="w">        </span><span class="n">GRIPPER_RIGHT_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="c1"># top_aft_gripper_right_proximal_joint</span>

<span class="w">        </span><span class="n">GRIPPER_RIGHT_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w">  </span><span class="c1"># top_aft_gripper_right_distal_joint</span>

<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Links</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Enumerates the different links on the astrobee via their Pybullet index</span>

<span class="s2">        Note: the URDF technically has 8 links, but it appears that pybullet considers</span>

<span class="s2">        the very first link to be the base link</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># Comments indicate the name of the link in the URDF</span>

<span class="w">        </span><span class="n">BODY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w">  </span><span class="c1"># honey_body</span>

<span class="w">        </span><span class="n">ARM_BASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1"># honey_top_aft</span>

<span class="w">        </span><span class="n">ARM_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1"># honey_top_aft_arm_proximal_link</span>

<span class="w">        </span><span class="n">ARM_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="c1"># honey_top_aft_arm_distal_link</span>

<span class="w">        </span><span class="n">GRIPPER_LEFT_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="c1"># honey_top_aft_gripper_left_proximal_link</span>

<span class="w">        </span><span class="n">GRIPPER_LEFT_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w">  </span><span class="c1"># honey_top_aft_gripper_left_distal_link</span>

<span class="w">        </span><span class="n">GRIPPER_RIGHT_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="c1"># honey_top_aft_gripper_right_proximal_link</span>

<span class="w">        </span><span class="n">GRIPPER_RIGHT_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w">  </span><span class="c1"># honey_top_aft_gripper_right_distal_link</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span>

<span class="w">        </span><span class="n">pose</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">),</span>

<span class="w">        </span><span class="n">arm_joints</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">),</span>

<span class="w">        </span><span class="n">gripper_pos</span><span class="p">:</span><span class="w"> </span><span class="nb">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>

<span class="w">        </span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">BulletClient</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span>

<span class="w">    </span><span class="p">):</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">pybullet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pybullet</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">client</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">isConnected</span><span class="p">():</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ConnectionError</span><span class="p">(</span>

<span class="w">                </span><span class="s2">&quot;Need to connect to pybullet before initializing an astrobee&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">loadURDF</span><span class="p">(</span>

<span class="w">            </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">URDF</span><span class="p">,</span><span class="w"> </span><span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span><span class="w"> </span><span class="n">flags</span><span class="o">=</span><span class="n">pybullet</span><span class="o">.</span><span class="n">URDF_USE_INERTIA_FROM_FILE</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getPhysicsEngineParameters</span><span class="p">()[</span><span class="s2">&quot;fixedTimeStep&quot;</span><span class="p">]</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">set_gripper_position</span><span class="p">(</span><span class="n">gripper_pos</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">set_arm_joints</span><span class="p">(</span><span class="n">arm_joints</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Initialize dynamics info with estimated numbers from NASA, we can recompute based on the sim state later</span>

<span class="w">        </span><span class="c1"># if desired. Values are from A Brief Guide to Astrobee</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">9.58</span><span class="w">  </span><span class="c1"># kg</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">0.153</span><span class="p">,</span><span class="w"> </span><span class="mf">0.143</span><span class="p">,</span><span class="w"> </span><span class="mf">0.162</span><span class="p">])</span><span class="w">  </span><span class="c1"># kg-m^2</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_inv_inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inertia</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_local_com_position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="c1"># Init, not accurate</span>

<span class="w">        </span><span class="c1"># TODO decide if we should recompute automatically???</span>

<span class="w">        </span><span class="c1"># self.recompute_inertial_properties()</span>

<span class="w">        </span><span class="n">print_green</span><span class="p">(</span><span class="s2">&quot;Astrobee is ready&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">unload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Remove the Astrobee from the simulation&quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">removeBody</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">pose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;The current robot pose (position + XYZW quaternion) expressed in world frame</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Position and quaternion, size (7,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getBasePositionAndOrientation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="p">])</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">tmat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;The current robot pose in world frame, expressed as a transformation matrix</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Transformation matrix (Robot to World), shape (4,4)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">pos_quat_to_tmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">)</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Just the position component of the full pose</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: (3,) position vector</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">orientation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Just the quaternion component of the full pose</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: (4,) XYZW quaternion</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">rmat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;The orientation of the robot expressed as a rotation matrix</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Rotation matrix (Robot to World), shape (3,3)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">quat_to_rmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">)</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">heading</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;A unit vector in the forward (x) component of the astrobee</span>

<span class="s2">        Some notes:</span>

<span class="s2">        - This is NOT a full description of orientation since rotation about this axis is undefined</span>

<span class="s2">        - The arm is on the REAR side of the astrobee, not the front</span>

<span class="s2">        - The y vector points to the port (left) side of the astrobee, and the z vector is up</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: (3,) unit vector</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">R_R2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quat_to_rmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">)</span><span class="w">  </span><span class="c1"># Robot to world</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">R_R2W</span><span class="p">[:,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w">  </span><span class="c1"># Robot frame x vector expressed in world</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Linear velocity of the Astrobee, with respect to the world frame xyz axes</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: [vx, vy, vz] linear velocities, shape (3,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">lin_vel</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getBaseVelocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lin_vel</span><span class="p">)</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">angular_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Angular velocity of the Astrobee, about the world frame xyz axes</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: [wx, wy, wz] angular velocities, shape (3,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getBaseVelocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ang_vel</span><span class="p">)</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">ee_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;The current end-effector pose (position + XYZW quaternion) expressed in world frame</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Position and quaternion, size (7,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tmat_to_pos_quat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ee_tmat</span><span class="p">)</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">ee_tmat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;The current end-effector transformation matrix (gripper-to-world)</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Transformation matrix, shape (4, 4)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">T_G2D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">TRANSFORMS</span><span class="o">.</span><span class="n">GRIPPER_TO_ARM_DISTAL</span><span class="w">  </span><span class="c1"># Gripper to distal</span>

<span class="w">        </span><span class="n">T_D2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">get_link_transform</span><span class="p">(</span>

<span class="w">            </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">Links</span><span class="o">.</span><span class="n">ARM_DISTAL</span><span class="o">.</span><span class="n">value</span>

<span class="w">        </span><span class="p">)</span><span class="w">  </span><span class="c1"># Distal to world</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">T_D2W</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">T_G2D</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">joint_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Angular positions (radians) of each joint on the Astrobee</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Joint angles, shape (NUM_JOINTS,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># States: tuple[tuple], size (7, 4)</span>

<span class="w">        </span><span class="c1"># 7 corresponds to NUM_JOINTS</span>

<span class="w">        </span><span class="c1"># 4 corresponds to position, velocity, reaction forces, and applied torque</span>

<span class="w">        </span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getJointStates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">)))</span>

<span class="w">        </span><span class="c1"># Index 0: position</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">)])</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">joint_vels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Angular velocities (radians/sec) of each joint on the Astrobee</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Joint velocities, shape (NUM_JOINTS,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getJointStates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">)))</span>

<span class="w">        </span><span class="c1"># Index 1: velocity</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">)])</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">joint_torques</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Torques (N-m) applied by each joint on the Astrobee</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Joint torques, shape (NUM_JOINTS,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getJointStates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">)))</span>

<span class="w">        </span><span class="c1"># Index 3: torque</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">)])</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">arm_joint_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Gives the two joint angles associated with the proximal + distal joints of the arm</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Arm joint angles, shape (2,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">joint_angles</span><span class="p">[</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">ARM_JOINT_IDXS</span><span class="p">]</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">gripper_joint_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Gives the four joint angles associated with the proximal + distal joints of the two gripper fingers</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Gripper joint angles, shape (4,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">joint_angles</span><span class="p">[</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">GRIPPER_JOINT_IDXS</span><span class="p">]</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">inertia</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Body inertia tensor for the Astrobee, shape (3, 3)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_inertia</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">inv_inertia</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Inverse of the Astrobee&#39;s body inertia tensor, shape (3, 3)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_inv_inertia</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">world_inertia</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;World-frame inertia tensor of the Astrobee, shape (3, 3)</span>

<span class="s2">        This takes into account the current rotation of Astrobee</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">rmat</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">inertia</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">R</span><span class="o">.</span><span class="n">T</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">world_inv_inertia</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Inverse of the world-frame inertia tensor of the Astrobee, shape (3, 3)</span>

<span class="s2">        This takes into account the current rotation of Astrobee</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">rmat</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">inv_inertia</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">R</span><span class="o">.</span><span class="n">T</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">float</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Mass of the Astrobee&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_mass</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">local_com_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Position of the center of mass of the robot w.r.t. the base, in local frame. Shape (3,)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_local_com_position</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">world_com_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Position of the center of mass of the robot, in world frame. Shape (3,)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">transform_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmat</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">local_com_position</span><span class="p">)</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">state_space_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;The state and control matrices A and B, such that x_dot = Ax + Bu</span>

<span class="s2">        We assume that the state x = [position, velocity, quaternion, angular velocity] ∈ R13</span>

<span class="s2">        and that the control u = [force, torque] ∈ R6</span>

<span class="s2">        We linearize the system about the current state</span>

<span class="s2">        Returns:</span>

<span class="s2">            tuple[np.ndarray, np.ndarray]:</span>

<span class="s2">                np.ndarray: A: State matrix, shape (13, 13)</span>

<span class="s2">                np.ndarray: B: Control matrix, shape (13, 6)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># TODO: decide if using the true joint-angle-based inertia tensor</span>

<span class="w">        </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">dynamics_state</span>

<span class="w">        </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">rmat</span>

<span class="w">        </span><span class="c1"># Use inertias defined in the world frame</span>

<span class="w">        </span><span class="n">inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">inertia</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">R</span><span class="o">.</span><span class="n">T</span>

<span class="w">        </span><span class="n">inv_inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">inv_inertia</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">R</span><span class="o">.</span><span class="n">T</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>

<span class="w">            </span><span class="n">state_matrix</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">inertia</span><span class="p">,</span><span class="w"> </span><span class="n">inv_inertia</span><span class="p">),</span>

<span class="w">            </span><span class="n">control_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span><span class="w"> </span><span class="n">inv_inertia</span><span class="p">),</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">state_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;The state vector x, such that x_dot = Ax + Bu</span>

<span class="s2">        We compose the state as [position, velocity, quaternion, angular velocity] ∈ R13</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getBasePositionAndOrientation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="n">lin_vel</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getBaseVelocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">lin_vel</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="p">])</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">dynamics_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Current state of the Astrobee&#39;s dynamics: Position, orientation, linear vel, and angular vel</span>

<span class="s2">        Returns:</span>

<span class="s2">            tuple[np.ndarray, np.ndarray, np.ndarray, np.ndarray]:</span>

<span class="s2">                np.ndarray: Position, shape (3,)</span>

<span class="s2">                np.ndarray: XYZW quaternion orientation, shape (4,)</span>

<span class="s2">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="s2">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getBasePositionAndOrientation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="n">lin_vel</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getBaseVelocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orn</span><span class="p">),</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lin_vel</span><span class="p">),</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ang_vel</span><span class="p">)</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">mass_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Mass/Inertia matrix for the Astrobee, given its current configuration</span>

<span class="s2">        - This is used to determine the kinetic energy (K = (1/2) * qdot.T @ M @ qdot) or the relationship between</span>

<span class="s2">          joint accelerations and torque (M * joint_accels + centrifugal_coriolis_vec + gravity_vec = torque)</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: The mass matrix, shape (12, 12). (12 is the number of degrees of freedom</span>

<span class="s2">                of the Astrobee - 6 DOF for a floating base, plus 6 for the six non-fixed joints)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># Inputs must be a lists (no numpy) or else pybullet will seg fault</span>

<span class="w">        </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">calculateMassMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_angles</span><span class="p">))</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">get_jacobians</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="p">:</span><span class="w"> </span><span class="n">Union</span><span class="p">[</span><span class="n">Links</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="p">],</span><span class="w"> </span><span class="n">local_pos</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Calculate the linear and angular jacobians (Jv and Jw) for a point on a link</span>

<span class="s2">        - These relate joint motion and task-space motion: [v; w] = [Jv; Jw] * dq</span>

<span class="s2">        - These jacobians will have a 12 columns corresponding to 6 DOF from the Astrobee&#39;s floating base, plus another</span>

<span class="s2">          6 DOF from the non-fixed joints</span>

<span class="s2">        Args:</span>

<span class="s2">            link (Union[Links, int]): Link or link index of interest.</span>

<span class="s2">                Common links: For the base, set this to -1. For the arm distal link, set this to 2</span>

<span class="s2">            local_pos (npt.ArrayLike, optional): Position in the link&#39;s reference frame. Defaults to [0.0, 0.0, 0.0].</span>

<span class="s2">                For the grasp point, use the position from the calibrated distal/grasp transformation</span>

<span class="s2">        Returns:</span>

<span class="s2">            tuple[np.ndarray, np.ndarray]:</span>

<span class="s2">                np.ndarray: Jv: Linear jacobian, shape (3, 12)</span>

<span class="s2">                np.ndarray: Jw: Angular jacobian, shape (3, 12)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">Links</span><span class="p">):</span>

<span class="w">            </span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link</span><span class="o">.</span><span class="n">value</span>

<span class="w">        </span><span class="n">ndof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w">  </span><span class="c1"># 7 joints, but 1 fixed</span>

<span class="w">        </span><span class="c1"># The quickstart guide says that the joint velocities and desired accelerations are just there</span>

<span class="w">        </span><span class="c1"># for an internal call to calculateInverseDynamics (and maybe aren&#39;t really meaningful?)</span>

<span class="w">        </span><span class="n">desired_accels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ndof</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>

<span class="w">        </span><span class="c1"># All inputs must be lists (no numpy) or else pybullet will seg fault</span>

<span class="w">        </span><span class="n">Jv</span><span class="p">,</span><span class="w"> </span><span class="n">Jw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">calculateJacobian</span><span class="p">(</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>

<span class="w">            </span><span class="n">link</span><span class="p">,</span>

<span class="w">            </span><span class="nb">list</span><span class="p">(</span><span class="n">local_pos</span><span class="p">),</span>

<span class="w">            </span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_angles</span><span class="p">)[</span><span class="mi">1</span><span class="p">:],</span><span class="w">  </span><span class="c1"># Don&#39;t include the first fixed joint</span>

<span class="w">            </span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vels</span><span class="p">)[</span><span class="mi">1</span><span class="p">:],</span><span class="w">  </span><span class="c1"># Don&#39;t include the first fixed joint</span>

<span class="w">            </span><span class="n">desired_accels</span><span class="p">,</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Jv</span><span class="p">),</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Jw</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">get_link_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">link_index</span><span class="p">:</span><span class="w"> </span><span class="n">Union</span><span class="p">[</span><span class="n">Links</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Calculates the transformation matrix (w.r.t the world) for a specified link</span>

<span class="s2">        Args:</span>

<span class="s2">            link_index (int): Index of the link on the robot</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Transformation matrix (link to world). Shape = (4,4)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">link_index</span><span class="p">,</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">Links</span><span class="p">):</span>

<span class="w">            </span><span class="n">link_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link_index</span><span class="o">.</span><span class="n">value</span>

<span class="w">        </span><span class="c1"># We have 8 links, indexed from -1 to 6</span>

<span class="w">        </span><span class="c1"># Pybullet does not allow access to the base link (-1) through getLinkState</span>

<span class="w">        </span><span class="c1"># So, use this only for non-base links</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">link_index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">link_index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid link index: </span><span class="si">{</span><span class="n">link_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">link_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getLinkState</span><span class="p">(</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">link_index</span><span class="p">,</span><span class="w"> </span><span class="n">computeForwardKinematics</span><span class="o">=</span><span class="kc">True</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="c1"># First two link state values are linkWorldPosition, linkWorldOrientation</span>

<span class="w">        </span><span class="c1"># There are other state positions and orientations, but they&#39;re confusing. (TODO check on these)</span>

<span class="w">        </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">quat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link_state</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">make_transform_mat</span><span class="p">(</span><span class="n">quat_to_rmat</span><span class="p">(</span><span class="n">quat</span><span class="p">),</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>

<span class="w">    </span><span class="nd">@property</span><span class="w">  </span><span class="c1"># Is this better as a property or as a &quot;getter&quot;?</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">gripper_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">int</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;The current position of the gripper, in range [0, 100]</span>

<span class="s2">        Returns:</span>

<span class="s2">            int: Position of the gripper, an integer between 0 (closed) and 100 (open)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">joint_states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getJointStates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">GRIPPER_JOINT_IDXS</span><span class="p">)</span>

<span class="w">        </span><span class="n">joint_angles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">joint_states</span><span class="p">]</span>

<span class="w">        </span><span class="n">l_angles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_angles</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

<span class="w">        </span><span class="n">r_angles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_angles</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

<span class="w">        </span><span class="n">l_closed</span><span class="p">,</span><span class="w"> </span><span class="n">l_open</span><span class="p">,</span><span class="w"> </span><span class="n">r_closed</span><span class="p">,</span><span class="w"> </span><span class="n">r_open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_get_gripper_joint_ranges</span><span class="p">()</span>

<span class="w">        </span><span class="n">l_pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">l_angles</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l_closed</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">l_open</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l_closed</span><span class="p">)</span>

<span class="w">        </span><span class="n">r_pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">r_angles</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r_closed</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">r_open</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r_closed</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">l_pct</span><span class="p">,</span><span class="w"> </span><span class="n">r_pct</span><span class="p">])))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># TODO decide if we need finer-grain control of the individual joints, or if this integer-position is fine</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">set_gripper_position</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="p">:</span><span class="w"> </span><span class="nb">float</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Sets the gripper to a position between 0 (fully closed) to 100 (fully open)</span>

<span class="s2">        Args:</span>

<span class="s2">            position (float): Gripper position, in range [0, 100]</span>

<span class="s2">            force (bool, optional): Whether to (non-physically) instantly reset the gripper position, instead</span>

<span class="s2">                of stepping the sim. Should only be used at initialization. Defaults to False</span>

<span class="s2">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="s2">                forwards in a blocking manner. Defaults to False</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;Position should be in range [0, 100]&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">l_closed</span><span class="p">,</span><span class="w"> </span><span class="n">l_open</span><span class="p">,</span><span class="w"> </span><span class="n">r_closed</span><span class="p">,</span><span class="w"> </span><span class="n">r_open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_get_gripper_joint_ranges</span><span class="p">()</span>

<span class="w">        </span><span class="n">left_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_closed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">position</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">l_open</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l_closed</span><span class="p">)</span>

<span class="w">        </span><span class="n">right_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r_closed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">position</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">r_open</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r_closed</span><span class="p">)</span>

<span class="w">        </span><span class="n">angle_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="n">left_pos</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">right_pos</span><span class="p">]</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">set_gripper_joints</span><span class="p">(</span><span class="n">angle_cmd</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">open_gripper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Fully opens the gripper&quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">set_gripper_position</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># TODO add force/torque control?</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">close_gripper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Fully closes the gripper&quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">set_gripper_position</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># TODO rework this?</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_get_gripper_joint_ranges</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Helper function to determine the range of motion (closed -&gt; open) of the gripper joints</span>

<span class="s2">        - This is a bit confusing because of how the URDF specifies joint min/max and how this translates</span>

<span class="s2">        to an open/closed position on the gripper</span>

<span class="s2">        - For a fully-closed gripper, the right side joints are at their max, and the left side joints are at their min</span>

<span class="s2">        - Likewise, for a fully-open gripper, the right side is at the joint min, and the left at joint max</span>

<span class="s2">        Returns:</span>

<span class="s2">            tuple[np.ndarray, np.ndarray, np.ndarray, np.ndarray]:</span>

<span class="s2">                np.ndarray: Left-side gripper finger angles when closed. Shape (2,)</span>

<span class="s2">                np.ndarray: Left-side gripper finger angles when open. Shape (2,)</span>

<span class="s2">                np.ndarray: Right-side gripper finger angles when closed. Shape (2,)</span>

<span class="s2">                np.ndarray: Right-side gripper finger angles when open. Shape (2,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">left_joints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">GRIPPER_JOINT_IDXS</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

<span class="w">        </span><span class="n">right_joints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">GRIPPER_JOINT_IDXS</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

<span class="w">        </span><span class="c1"># As a numpy array, each row will correspond to a joint, and the two columns are [min, max]</span>

<span class="w">        </span><span class="n">left_closed</span><span class="p">,</span><span class="w"> </span><span class="n">left_open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">JOINT_POS_LIMITS</span><span class="p">[</span><span class="n">left_joints</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

<span class="w">        </span><span class="n">right_open</span><span class="p">,</span><span class="w"> </span><span class="n">right_closed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">JOINT_POS_LIMITS</span><span class="p">[</span><span class="n">right_joints</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">left_closed</span><span class="p">,</span><span class="w"> </span><span class="n">left_open</span><span class="p">,</span><span class="w"> </span><span class="n">right_closed</span><span class="p">,</span><span class="w"> </span><span class="n">right_open</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">set_joint_angles</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span>

<span class="w">        </span><span class="n">angles</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">indices</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span>

<span class="w">        </span><span class="n">force</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="p">,</span>

<span class="w">        </span><span class="n">wait</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="p">,</span>

<span class="w">    </span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Sets the joint angles for the Astrobee (either all joints, or a specified subset)</span>

<span class="s2">        Args:</span>

<span class="s2">            angles (npt.ArrayLike): Desired joint angles, in radians</span>

<span class="s2">            indices (npt.ArrayLike, optional): Indices of the joints to control. Defaults to None,</span>

<span class="s2">                in which case we assume all 7 joints will be set.</span>

<span class="s2">            force (bool, optional): Whether to (non-physically) instantly reset the joint state.</span>

<span class="s2">                Should only be used at initialization. Defaults to False</span>

<span class="s2">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="s2">                forwards in a blocking manner. Defaults to False</span>

<span class="s2">        Raises:</span>

<span class="s2">            ValueError: If the number of angles provided do not match the number of indices</span>

<span class="s2">            ValueError: If the angles are out of the joint limits for the specified indices</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">            </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">))</span>

<span class="w">        </span><span class="n">angles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="w">  </span><span class="c1"># If scalar, ensure we don&#39;t have a 0-D array</span>

<span class="w">        </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">angles</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="s2">&quot;Number of angles must match with the number of provided indices&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">angles</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">JOINT_POS_LIMITS</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>

<span class="w">            </span><span class="n">angles</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">JOINT_POS_LIMITS</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span>

<span class="w">        </span><span class="p">):</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="sa">f</span><span class="s2">&quot;Joint angle command is outside of joint limits.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">{</span><span class="n">angles</span><span class="si">}</span><span class="s2"> for joints </span><span class="si">{</span><span class="n">indices</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">force</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">ind</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="n">angles</span><span class="p">):</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">resetJointState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ind</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Set the position control for the arm so Pybullet will correct for disturbances</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">setJointMotorControlArray</span><span class="p">(</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>

<span class="w">            </span><span class="n">indices</span><span class="p">,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">POSITION_CONTROL</span><span class="p">,</span>

<span class="w">            </span><span class="n">angles</span><span class="p">,</span>

<span class="w">            </span><span class="n">forces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">JOINT_EFFORT_LIMITS</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Step the sim until the arm is at the desired angle, if waiting for it to reach the position</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">wait</span><span class="p">:</span>

<span class="w">            </span><span class="n">tol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="w">  </span><span class="c1"># TODO TOTALLY ARBITRARY FOR NOW</span>

<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_joint_angles</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">angles</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tol</span><span class="p">):</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">stepSimulation</span><span class="p">()</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">get_joint_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">indices</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Gives the current joint angles for the Astrobee</span>

<span class="s2">        Args:</span>

<span class="s2">            indices (npt.ArrayLike, optional): Indices of the joints of interest. Defaults to None,</span>

<span class="s2">                in which case all joint angles will be returned</span>

<span class="s2">        Returns:</span>

<span class="s2">            np.ndarray: Joint angles (in radians), length = len(indices) or Astrobee.NUM_JOINTS</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getJointStates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">indices</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">states</span><span class="p">])</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">set_arm_joints</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">angles</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Sets the joint angles for the arm (proximal + distal)</span>

<span class="s2">        Args:</span>

<span class="s2">            angles (npt.ArrayLike): Arm joint angles, length = 2</span>

<span class="s2">            force (bool, optional): Whether to (non-physically) instantly reset the joint states.</span>

<span class="s2">                Should only be used at initialization. Defaults to False</span>

<span class="s2">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="s2">                forwards in a blocking manner. Defaults to False</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">set_joint_angles</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">ARM_JOINT_IDXS</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">set_gripper_joints</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">angles</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Sets the joint angles for the gripper (left + right, proximal + distal)</span>

<span class="s2">        Args:</span>

<span class="s2">            angles (npt.ArrayLike): Gripper joint angles, length = 4</span>

<span class="s2">            force (bool, optional): Whether to (non-physically) instantly reset the gripper joints.</span>

<span class="s2">                Should only be used at initialization. Defaults to False</span>

<span class="s2">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="s2">                forwards in a blocking manner. Defaults to False</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">set_joint_angles</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">GRIPPER_JOINT_IDXS</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset_to_ee_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">pose</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Resets the position of the robot to achieve a target end-effector pose</span>

<span class="s2">        This will currently NOT adjust any of the joints in a &quot;smart&quot; way, it will just reset the position of the base</span>

<span class="s2">        given the current joint configuration</span>

<span class="s2">        Args:</span>

<span class="s2">            pose (npt.ArrayLike): Desired position + XYZW quaternion end-effector pose, shape (7,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># Notation: EE: End effector, B: Base, W: World</span>

<span class="w">        </span><span class="n">des_EE2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos_quat_to_tmat</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>

<span class="w">        </span><span class="n">cur_B2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos_quat_to_tmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">)</span>

<span class="w">        </span><span class="n">cur_EE2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos_quat_to_tmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ee_pose</span><span class="p">)</span>

<span class="w">        </span><span class="n">cur_W2EE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invert_transform_mat</span><span class="p">(</span><span class="n">cur_EE2W</span><span class="p">)</span>

<span class="w">        </span><span class="n">cur_B2EE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_W2EE</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">cur_B2W</span>

<span class="w">        </span><span class="n">des_B2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">des_EE2W</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">cur_B2EE</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">reset_to_base_pose</span><span class="p">(</span><span class="n">tmat_to_pos_quat</span><span class="p">(</span><span class="n">des_B2W</span><span class="p">))</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset_to_base_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">pose</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Resets the base of the robot to a target pose</span>

<span class="s2">        Args:</span>

<span class="s2">            pose (npt.ArrayLike): Desired position + XYZW quaternion pose of the Astrobee&#39;s base, shape (7,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">resetBasePositionAndOrientation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">localize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="k">raise</span><span class="w"> </span><span class="n">NotImplementedError</span><span class="p">()</span><span class="w">  </span><span class="c1"># TODO.. see dynamics state. Should have a noise parameter</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">recompute_inertial_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Calculate the inertial properties based on the current state of the robot in sim</span>

<span class="s2">        This is more accurate than the fixed, base-only values from NASA&#39;s documentation, but it is fairly expensive to</span>

<span class="s2">        compute and should NOT be done on every simulation step.</span>

<span class="s2">        This will update the mass, inertia, inv_inertia, and center of mass</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># Note: Mass will be fixed, but it is not necessarily the same value as provided by NASA</span>

<span class="w">        </span><span class="n">mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>

<span class="w">        </span><span class="n">inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>

<span class="w">        </span><span class="n">com</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="w">        </span><span class="n">T_B2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">tmat</span><span class="w">  </span><span class="c1"># Base to world</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">Links</span><span class="p">:</span>

<span class="w">            </span><span class="n">link_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pybullet</span><span class="o">.</span><span class="n">getDynamicsInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="w">            </span><span class="n">link_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">            </span><span class="n">link_inertia_diagonal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">link</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="w">  </span><span class="c1"># Separate handling for base link</span>

<span class="w">                </span><span class="n">inertia</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">link_inertia_diagonal</span><span class="p">)</span>

<span class="w">                </span><span class="n">com</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">link_mass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">T_B2W</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>

<span class="w">            </span><span class="k">else</span><span class="p">:</span>

<span class="w">                </span><span class="n">T_L2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">get_link_transform</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="w">  </span><span class="c1"># Link to world</span>

<span class="w">                </span><span class="n">T_L2B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invert_transform_mat</span><span class="p">(</span><span class="n">T_B2W</span><span class="p">)</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">T_L2W</span><span class="w">  </span><span class="c1"># Link to base</span>

<span class="w">                </span><span class="n">inertia</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">inertial_transformation</span><span class="p">(</span>

<span class="w">                    </span><span class="n">link_mass</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">link_inertia_diagonal</span><span class="p">),</span><span class="w"> </span><span class="n">T_L2B</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="n">com</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">link_mass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">T_L2W</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>

<span class="w">            </span><span class="n">mass</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">link_mass</span>

<span class="w">        </span><span class="n">com</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">mass</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_local_com_position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T_B2W</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">T_B2W</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mass</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inertia</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_inv_inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">inertia</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">store_arm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Folds the Astrobee&#39;s arm into its body</span>

<span class="s2">        Note: Storing the arm reduces the products of inertia, so this is the preferable</span>

<span class="s2">        configuration if not manipulating any objects</span>

<span class="s2">        Args:</span>

<span class="s2">            force (bool, optional): Whether to (non-physically) instantly reset the joints.</span>

<span class="s2">                Should only be used at initialization. Defaults to False</span>

<span class="s2">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="s2">                forwards in a blocking manner. Defaults to False</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">set_arm_joints</span><span class="p">([</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">JOINT_POS_LIMITS</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">set_gripper_position</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">deploy_arm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Sets the arm to the default position, with the gripper fully open</span>

<span class="s2">        Args:</span>

<span class="s2">            force (bool, optional): Whether to (non-physically) instantly reset the joints.</span>

<span class="s2">                Should only be used at initialization. Defaults to False</span>

<span class="s2">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="s2">                forwards in a blocking manner. Defaults to False</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">set_arm_joints</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">set_gripper_position</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">)</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">full_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">]:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;All information required to fully reset the state of the Astrobee</span>

<span class="s2">        Returns:</span>

<span class="s2">            tuple[np.ndarray, ...]:</span>

<span class="s2">                np.ndarray: Position, shape (3,)</span>

<span class="s2">                np.ndarray: Orientation (XYZW quaternion), shape (4,)</span>

<span class="s2">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="s2">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="s2">                np.ndarray: Joint positions, shape (NUM_JOINTS,)</span>

<span class="s2">                np.ndarray: Joint velocities, shape (NUM_JOINTS,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getBasePositionAndOrientation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="n">vel</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getBaseVelocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="n">joint_states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getJointStates</span><span class="p">(</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">))</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="n">joint_positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">)</span>

<span class="w">        </span><span class="n">joint_vels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">)</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">):</span>

<span class="w">            </span><span class="n">joint_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="w">            </span><span class="n">joint_vels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>

<span class="w">            </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span>

<span class="w">            </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orn</span><span class="p">),</span>

<span class="w">            </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel</span><span class="p">),</span>

<span class="w">            </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ang_vel</span><span class="p">),</span>

<span class="w">            </span><span class="n">joint_positions</span><span class="p">,</span>

<span class="w">            </span><span class="n">joint_vels</span><span class="p">,</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset_full_state</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span>

<span class="w">        </span><span class="n">pos</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">orn</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">vel</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">omega</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">q</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">qdot</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">    </span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Fully resets the state of the Astrobee</span>

<span class="s2">        Args:</span>

<span class="s2">            pos (npt.ArrayLike): Position, shape (3,)</span>

<span class="s2">            orn (npt.ArrayLike): Orientation (XYZW quaternion), shape (4,)</span>

<span class="s2">            vel (npt.ArrayLike): Linear velocity, shape (3,)</span>

<span class="s2">            omega (npt.ArrayLike): Angular velocity, shape (3,)</span>

<span class="s2">            q (npt.ArrayLike): Joint positions, shape (NUM_JOINTS,)</span>

<span class="s2">            qdot (npt.ArrayLike): Joint velocities, shape (NUM_JOINTS,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">resetBasePositionAndOrientation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">resetBaseVelocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">vel</span><span class="p">,</span><span class="w"> </span><span class="n">omega</span><span class="p">)</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span><span class="p">):</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">resetJointState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">qdot</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Current axis-aligned bounding box of the Astrobee body (Not including the arm), shape (2, 3)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getAABB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_main</span><span class="p">():</span>

<span class="w">    </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initialize_pybullet</span><span class="p">(</span><span class="n">bg_color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span>

<span class="w">    </span><span class="n">robot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">()</span>

<span class="w">    </span><span class="n">run_sim</span><span class="p">()</span>

<span class="k">if</span><span class="w"> </span><span class="vm">__name__</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

<span class="w">    </span><span class="n">_main</span><span class="p">()</span>
</code></pre></div>

</details>
<h2 id="variables">Variables</h2>
<div class="codehilite"><pre><span></span><code><span class="n">COLLISION_RADIUS</span>
</code></pre></div>

<h2 id="classes">Classes</h2>
<h3 id="astrobee">Astrobee</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Astrobee</span><span class="p">(</span>
    <span class="n">pose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="n">arm_joints</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="n">gripper_pos</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pybullet_utils</span><span class="o">.</span><span class="n">bullet_client</span><span class="o">.</span><span class="n">BulletClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<p>Astrobee class for managing control, states, and properties</p>
<h4 id="attributes">Attributes</h4>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>pose</td>
<td>npt.ArrayLike</td>
<td>Initial pose of the astrobee when loaded. Defaults to<br>(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0) (At origin, pointed forward along x axis).</td>
<td>None</td>
</tr>
<tr>
<td>arm_joints</td>
<td>npt.ArrayLike</td>
<td>Initial position of the arm's joints. Defaults to<br>(0.0, 0.0) (Hanging straight down)</td>
<td>None</td>
</tr>
<tr>
<td>gripper_pos</td>
<td>float</td>
<td>Initial gripper position, in [0, 100]. Defaults to 100 (fully open)</td>
<td>None</td>
</tr>
<tr>
<td>client</td>
<td>BulletClient</td>
<td>If connecting to multiple physics servers, include the client<br>(the class instance, not just the ID) here. Defaults to None (use default connected client)</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nl">Astrobee</span><span class="p">:</span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;Astrobee class for managing control, states, and properties</span>

<span class="ss">    Args:</span>

<span class="ss">        pose (npt.ArrayLike, optional): Initial pose of the astrobee when loaded. Defaults to</span>

<span class="ss">            (0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0) (At origin, pointed forward along x axis).</span>

<span class="ss">        arm_joints (npt.ArrayLike, optional): Initial position of the arm&#39;s joints. Defaults to</span>

<span class="ss">            (0.0, 0.0) (Hanging straight down)</span>

<span class="ss">        gripper_pos (float, optional): Initial gripper position, in [0, 100]. Defaults to 100 (fully open)</span>

<span class="ss">        client (BulletClient, optional): If connecting to multiple physics servers, include the client</span>

<span class="ss">            (the class instance, not just the ID) here. Defaults to None (use default connected client)</span>

<span class="ss">    Raises:</span>

<span class="ss">        ConnectionError: If a pybullet server is not connected before initialization</span>

<span class="ss">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="n">URDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;pyastrobee/assets/urdf/astrobee/astrobee.urdf&quot;</span>

<span class="w">    </span><span class="n">NUM_JOINTS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span>

<span class="w">    </span><span class="n">NUM_LINKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>

<span class="w">    </span><span class="n">TRANSFORMS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">astrobee_transforms</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">figure</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">best</span><span class="w"> </span><span class="n">way</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">info</span>

<span class="w">    </span><span class="n">GRIPPER_JOINT_IDXS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">3, 4, 5, 6</span><span class="o">]</span>

<span class="w">    </span><span class="n">ARM_JOINT_IDXS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">1, 2</span><span class="o">]</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Joint</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">extracted</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">URDF</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Joint</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="n">limits</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="o">[</span><span class="n">lower, upper</span><span class="o">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="n">joint</span>

<span class="w">    </span><span class="n">JOINT_POS_LIMITS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span>

<span class="w">        </span><span class="o">[</span>

<span class="n">            [0.0, 0.0</span><span class="o">]</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">top</span><span class="w"> </span><span class="n">aft</span><span class="w"> </span><span class="p">(</span><span class="n">fixed</span><span class="p">)</span>

<span class="w">            </span><span class="o">[</span><span class="n">-2.0944, 1.57079</span><span class="o">]</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">arm</span><span class="w"> </span><span class="n">proximal</span><span class="w"> </span><span class="n">joint</span>

<span class="w">            </span><span class="o">[</span><span class="n">-1.57079, 1.57079</span><span class="o">]</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">arm</span><span class="w"> </span><span class="n">distal</span><span class="w"> </span><span class="n">joint</span>

<span class="w">            </span><span class="o">[</span><span class="n">0.349066, 0.698132</span><span class="o">]</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">gripper</span><span class="w"> </span><span class="nf">left</span><span class="w"> </span><span class="n">proximal</span><span class="w"> </span><span class="n">joint</span>

<span class="w">            </span><span class="o">[</span><span class="n">-1.22173, -0.69813</span><span class="o">]</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">gripper</span><span class="w"> </span><span class="nf">left</span><span class="w"> </span><span class="n">distal</span><span class="w"> </span><span class="n">joint</span>

<span class="w">            </span><span class="o">[</span><span class="n">-0.698132, -0.349066</span><span class="o">]</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">gripper</span><span class="w"> </span><span class="nf">right</span><span class="w"> </span><span class="n">proximal</span><span class="w"> </span><span class="n">joint</span>

<span class="w">            </span><span class="o">[</span><span class="n">0.69813, 1.22173</span><span class="o">]</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">gripper</span><span class="w"> </span><span class="nf">right</span><span class="w"> </span><span class="n">distal</span><span class="w"> </span><span class="n">joint</span>

<span class="w">        </span><span class="err">]</span>

<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">JOINT_EFFORT_LIMITS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span>

<span class="w">        </span><span class="o">[</span>

<span class="n">            0.0,  # top aft (fixed)</span>

<span class="n">            1.0,  # arm proximal joint</span>

<span class="n">            1.0,  # arm distal joint</span>

<span class="n">            0.1,  # gripper left proximal joint</span>

<span class="n">            0.1,  # gripper left distal joint</span>

<span class="n">            0.1,  # gripper right proximal joint</span>

<span class="n">            0.1,  # gripper right distal joint</span>

<span class="n">        </span><span class="o">]</span>

<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">JOINT_VEL_LIMITS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span>

<span class="w">        </span><span class="o">[</span>

<span class="n">            0.00,  # top aft (fixed)</span>

<span class="n">            0.12,  # arm proximal joint</span>

<span class="n">            0.12,  # arm distal joint</span>

<span class="n">            0.12,  # gripper left proximal joint</span>

<span class="n">            0.12,  # gripper left distal joint</span>

<span class="n">            0.12,  # gripper right proximal joint</span>

<span class="n">            0.12,  # gripper right distal joint</span>

<span class="n">        </span><span class="o">]</span>

<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Bounding</span><span class="w"> </span><span class="n">sphere</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">collision</span><span class="w"> </span><span class="n">modeling</span>

<span class="w">    </span><span class="n">COLLISION_RADIUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COLLISION_RADIUS</span>

<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="n">Joints</span><span class="p">(</span><span class="n">Enum</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Enumerates the different joints on the astrobee via their Pybullet index&quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Comments</span><span class="w"> </span><span class="n">indicate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">joint</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">URDF</span>

<span class="w">        </span><span class="n">ARM_BASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">top_aft</span><span class="w"> </span><span class="p">(</span><span class="n">fixed</span><span class="w"> </span><span class="n">joint</span><span class="p">)</span>

<span class="w">        </span><span class="n">ARM_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">top_aft_arm_proximal_joint</span>

<span class="w">        </span><span class="n">ARM_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">top_aft_arm_distal_joint</span>

<span class="w">        </span><span class="n">GRIPPER_LEFT_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">top_aft_gripper_left_proximal_joint</span>

<span class="w">        </span><span class="n">GRIPPER_LEFT_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">top_aft_gripper_left_distal_joint</span>

<span class="w">        </span><span class="n">GRIPPER_RIGHT_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">top_aft_gripper_right_proximal_joint</span>

<span class="w">        </span><span class="n">GRIPPER_RIGHT_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">top_aft_gripper_right_distal_joint</span>

<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="n">Links</span><span class="p">(</span><span class="n">Enum</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Enumerates the different links on the astrobee via their Pybullet index</span>

<span class="ss">        Note: the URDF technically has 8 links, but it appears that pybullet considers</span>

<span class="ss">        the very first link to be the base link</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Comments</span><span class="w"> </span><span class="n">indicate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">URDF</span>

<span class="w">        </span><span class="n">BODY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">honey_body</span>

<span class="w">        </span><span class="n">ARM_BASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">honey_top_aft</span>

<span class="w">        </span><span class="n">ARM_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">honey_top_aft_arm_proximal_link</span>

<span class="w">        </span><span class="n">ARM_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">honey_top_aft_arm_distal_link</span>

<span class="w">        </span><span class="n">GRIPPER_LEFT_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">honey_top_aft_gripper_left_proximal_link</span>

<span class="w">        </span><span class="n">GRIPPER_LEFT_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">honey_top_aft_gripper_left_distal_link</span>

<span class="w">        </span><span class="n">GRIPPER_RIGHT_PROXIMAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">honey_top_aft_gripper_right_proximal_link</span>

<span class="w">        </span><span class="n">GRIPPER_RIGHT_DISTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">honey_top_aft_gripper_right_distal_link</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">pose</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">),</span>

<span class="w">        </span><span class="nl">arm_joints</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">),</span>

<span class="w">        </span><span class="nl">gripper_pos</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>

<span class="w">        </span><span class="nl">client</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">BulletClient</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="nl">client</span><span class="p">:</span><span class="w"> </span><span class="n">pybullet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pybullet</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">client</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">isConnected</span><span class="p">()</span><span class="err">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ConnectionError</span><span class="p">(</span>

<span class="w">                </span><span class="ss">&quot;Need to connect to pybullet before initializing an astrobee&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">loadURDF</span><span class="p">(</span>

<span class="w">            </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">URDF</span><span class="p">,</span><span class="w"> </span><span class="n">pose</span><span class="o">[</span><span class="n">:3</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">pose</span><span class="o">[</span><span class="n">3:</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="o">=</span><span class="n">pybullet</span><span class="p">.</span><span class="n">URDF_USE_INERTIA_FROM_FILE</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getPhysicsEngineParameters</span><span class="p">()</span><span class="o">[</span><span class="n">&quot;fixedTimeStep&quot;</span><span class="o">]</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">set_gripper_position</span><span class="p">(</span><span class="n">gripper_pos</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">set_arm_joints</span><span class="p">(</span><span class="n">arm_joints</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Initialize</span><span class="w"> </span><span class="n">dynamics</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">estimated</span><span class="w"> </span><span class="n">numbers</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">NASA</span><span class="p">,</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">recompute</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sim</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="n">later</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">desired</span><span class="p">.</span><span class="w"> </span><span class="k">Values</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">Brief</span><span class="w"> </span><span class="n">Guide</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">Astrobee</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">9.58</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">kg</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">diag</span><span class="p">(</span><span class="o">[</span><span class="n">0.153, 0.143, 0.162</span><span class="o">]</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">kg</span><span class="o">-</span><span class="n">m</span><span class="o">^</span><span class="mi">2</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_inv_inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">inv</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_inertia</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_local_com_position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Init</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">accurate</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">decide</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">recompute</span><span class="w"> </span><span class="n">automatically</span><span class="vm">???</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">recompute_inertial_properties</span><span class="p">()</span>

<span class="w">        </span><span class="n">print_green</span><span class="p">(</span><span class="ss">&quot;Astrobee is ready&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">unload</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Remove the Astrobee from the simulation&quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">removeBody</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">pose</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;The current robot pose (position + XYZW quaternion) expressed in world frame</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Position and quaternion, size (7,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getBasePositionAndOrientation</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span><span class="o">[</span><span class="n">pos, orn</span><span class="o">]</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">tmat</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;The current robot pose in world frame, expressed as a transformation matrix</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Transformation matrix (Robot to World), shape (4,4)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">pos_quat_to_tmat</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">pose</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">position</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Just the position component of the full pose</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: (3,) position vector</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">pose</span><span class="o">[</span><span class="n">:3</span><span class="o">]</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">orientation</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Just the quaternion component of the full pose</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: (4,) XYZW quaternion</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">pose</span><span class="o">[</span><span class="n">3:</span><span class="o">]</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">rmat</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;The orientation of the robot expressed as a rotation matrix</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Rotation matrix (Robot to World), shape (3,3)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">quat_to_rmat</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">orientation</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">heading</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;A unit vector in the forward (x) component of the astrobee</span>

<span class="ss">        Some notes:</span>

<span class="ss">        - This is NOT a full description of orientation since rotation about this axis is undefined</span>

<span class="ss">        - The arm is on the REAR side of the astrobee, not the front</span>

<span class="ss">        - The y vector points to the port (left) side of the astrobee, and the z vector is up</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: (3,) unit vector</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">R_R2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quat_to_rmat</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">orientation</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Robot</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">world</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">R_R2W</span><span class="o">[</span><span class="n">:, 0</span><span class="o">]</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Robot</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">expressed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">world</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">velocity</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Linear velocity of the Astrobee, with respect to the world frame xyz axes</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: [vx, vy, vz] linear velocities, shape (3,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">lin_vel</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getBaseVelocity</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="n">lin_vel</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">angular_velocity</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Angular velocity of the Astrobee, about the world frame xyz axes</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: [wx, wy, wz] angular velocities, shape (3,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getBaseVelocity</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="n">ang_vel</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">ee_pose</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;The current end-effector pose (position + XYZW quaternion) expressed in world frame</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Position and quaternion, size (7,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tmat_to_pos_quat</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ee_tmat</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">ee_tmat</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;The current end-effector transformation matrix (gripper-to-world)</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Transformation matrix, shape (4, 4)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">T_G2D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">TRANSFORMS</span><span class="p">.</span><span class="n">GRIPPER_TO_ARM_DISTAL</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Gripper</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">distal</span>

<span class="w">        </span><span class="n">T_D2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">get_link_transform</span><span class="p">(</span>

<span class="w">            </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">Links</span><span class="p">.</span><span class="n">ARM_DISTAL</span><span class="p">.</span><span class="k">value</span>

<span class="w">        </span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Distal</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">world</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">T_D2W</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">T_G2D</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">joint_angles</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Angular positions (radians) of each joint on the Astrobee</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Joint angles, shape (NUM_JOINTS,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nl">States</span><span class="p">:</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">tuple</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">corresponds</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">NUM_JOINTS</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">corresponds</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">position</span><span class="p">,</span><span class="w"> </span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">reaction</span><span class="w"> </span><span class="n">forces</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">applied</span><span class="w"> </span><span class="n">torque</span>

<span class="w">        </span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getJointStates</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="k">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="p">.</span><span class="n">NUM_JOINTS</span><span class="p">)))</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Index</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="w"> </span><span class="k">position</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="o">[</span><span class="n">states[i</span><span class="o">][</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="p">.</span><span class="n">NUM_JOINTS</span><span class="p">)</span><span class="err">]</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">joint_vels</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Angular velocities (radians/sec) of each joint on the Astrobee</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Joint velocities, shape (NUM_JOINTS,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getJointStates</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="k">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="p">.</span><span class="n">NUM_JOINTS</span><span class="p">)))</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Index</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">velocity</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="o">[</span><span class="n">states[i</span><span class="o">][</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="p">.</span><span class="n">NUM_JOINTS</span><span class="p">)</span><span class="err">]</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">joint_torques</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Torques (N-m) applied by each joint on the Astrobee</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Joint torques, shape (NUM_JOINTS,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getJointStates</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="k">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="p">.</span><span class="n">NUM_JOINTS</span><span class="p">)))</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Index</span><span class="w"> </span><span class="mi">3</span><span class="err">:</span><span class="w"> </span><span class="n">torque</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="o">[</span><span class="n">states[i</span><span class="o">][</span><span class="n">3</span><span class="o">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="p">.</span><span class="n">NUM_JOINTS</span><span class="p">)</span><span class="err">]</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">arm_joint_angles</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Gives the two joint angles associated with the proximal + distal joints of the arm</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Arm joint angles, shape (2,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">joint_angles</span><span class="o">[</span><span class="n">Astrobee.ARM_JOINT_IDXS</span><span class="o">]</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">gripper_joint_angles</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Gives the four joint angles associated with the proximal + distal joints of the two gripper fingers</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Gripper joint angles, shape (4,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">joint_angles</span><span class="o">[</span><span class="n">Astrobee.GRIPPER_JOINT_IDXS</span><span class="o">]</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">inertia</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Body inertia tensor for the Astrobee, shape (3, 3)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_inertia</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">inv_inertia</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Inverse of the Astrobee&#39;s body inertia tensor, shape (3, 3)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_inv_inertia</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">world_inertia</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;World-frame inertia tensor of the Astrobee, shape (3, 3)</span>

<span class="ss">        This takes into account the current rotation of Astrobee</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">rmat</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">inertia</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">T</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">world_inv_inertia</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Inverse of the world-frame inertia tensor of the Astrobee, shape (3, 3)</span>

<span class="ss">        This takes into account the current rotation of Astrobee</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">rmat</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">inv_inertia</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">T</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">mass</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">float</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Mass of the Astrobee&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_mass</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">local_com_position</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Position of the center of mass of the robot w.r.t. the base, in local frame. Shape (3,)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_local_com_position</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">world_com_position</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Position of the center of mass of the robot, in world frame. Shape (3,)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">transform_point</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tmat</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">local_com_position</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">state_space_matrices</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">np.ndarray, np.ndarray</span><span class="o">]</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;The state and control matrices A and B, such that x_dot = Ax + Bu</span>

<span class="ss">        We assume that the state x = [position, velocity, quaternion, angular velocity] ∈ R13</span>

<span class="ss">        and that the control u = [force, torque] ∈ R6</span>

<span class="ss">        We linearize the system about the current state</span>

<span class="ss">        Returns:</span>

<span class="ss">            tuple[np.ndarray, np.ndarray]:</span>

<span class="ss">                np.ndarray: A: State matrix, shape (13, 13)</span>

<span class="ss">                np.ndarray: B: Control matrix, shape (13, 6)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nl">TODO</span><span class="p">:</span><span class="w"> </span><span class="n">decide</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="n">joint</span><span class="o">-</span><span class="n">angle</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">inertia</span><span class="w"> </span><span class="n">tensor</span>

<span class="w">        </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dynamics_state</span>

<span class="w">        </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">rmat</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">inertias</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">world</span><span class="w"> </span><span class="n">frame</span>

<span class="w">        </span><span class="n">inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">inertia</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">T</span>

<span class="w">        </span><span class="n">inv_inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">inv_inertia</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">T</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>

<span class="w">            </span><span class="n">state_matrix</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">inertia</span><span class="p">,</span><span class="w"> </span><span class="n">inv_inertia</span><span class="p">),</span>

<span class="w">            </span><span class="n">control_matrix</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">mass</span><span class="p">,</span><span class="w"> </span><span class="n">inv_inertia</span><span class="p">),</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">state_vector</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;The state vector x, such that x_dot = Ax + Bu</span>

<span class="ss">        We compose the state as [position, velocity, quaternion, angular velocity] ∈ R13</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getBasePositionAndOrientation</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="n">lin_vel</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getBaseVelocity</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span><span class="o">[</span><span class="n">pos, lin_vel, orn, ang_vel</span><span class="o">]</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">dynamics_state</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">np.ndarray, np.ndarray, np.ndarray, np.ndarray</span><span class="o">]</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Current state of the Astrobee&#39;s dynamics: Position, orientation, linear vel, and angular vel</span>

<span class="ss">        Returns:</span>

<span class="ss">            tuple[np.ndarray, np.ndarray, np.ndarray, np.ndarray]:</span>

<span class="ss">                np.ndarray: Position, shape (3,)</span>

<span class="ss">                np.ndarray: XYZW quaternion orientation, shape (4,)</span>

<span class="ss">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="ss">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getBasePositionAndOrientation</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="n">lin_vel</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getBaseVelocity</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="n">orn</span><span class="p">),</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="n">lin_vel</span><span class="p">),</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="n">ang_vel</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">mass_matrix</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Mass/Inertia matrix for the Astrobee, given its current configuration</span>

<span class="ss">        - This is used to determine the kinetic energy (K = (1/2) * qdot.T @ M @ qdot) or the relationship between</span>

<span class="ss">          joint accelerations and torque (M * joint_accels + centrifugal_coriolis_vec + gravity_vec = torque)</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: The mass matrix, shape (12, 12). (12 is the number of degrees of freedom</span>

<span class="ss">                of the Astrobee - 6 DOF for a floating base, plus 6 for the six non-fixed joints)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Inputs</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">lists</span><span class="w"> </span><span class="p">(</span><span class="k">no</span><span class="w"> </span><span class="n">numpy</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">pybullet</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">seg</span><span class="w"> </span><span class="n">fault</span>

<span class="w">        </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">calculateMassMatrix</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">joint_angles</span><span class="p">))</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">get_jacobians</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">link</span><span class="p">:</span><span class="w"> </span><span class="ow">Union</span><span class="o">[</span><span class="n">Links, int</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="nl">local_pos</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">np.ndarray, np.ndarray</span><span class="o">]</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Calculate the linear and angular jacobians (Jv and Jw) for a point on a link</span>

<span class="ss">        - These relate joint motion and task-space motion: [v; w] = [Jv; Jw] * dq</span>

<span class="ss">        - These jacobians will have a 12 columns corresponding to 6 DOF from the Astrobee&#39;s floating base, plus another</span>

<span class="ss">          6 DOF from the non-fixed joints</span>

<span class="ss">        Args:</span>

<span class="ss">            link (Union[Links, int]): Link or link index of interest.</span>

<span class="ss">                Common links: For the base, set this to -1. For the arm distal link, set this to 2</span>

<span class="ss">            local_pos (npt.ArrayLike, optional): Position in the link&#39;s reference frame. Defaults to [0.0, 0.0, 0.0].</span>

<span class="ss">                For the grasp point, use the position from the calibrated distal/grasp transformation</span>

<span class="ss">        Returns:</span>

<span class="ss">            tuple[np.ndarray, np.ndarray]:</span>

<span class="ss">                np.ndarray: Jv: Linear jacobian, shape (3, 12)</span>

<span class="ss">                np.ndarray: Jw: Angular jacobian, shape (3, 12)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">Links</span><span class="p">)</span><span class="err">:</span>

<span class="w">            </span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link</span><span class="p">.</span><span class="k">value</span>

<span class="w">        </span><span class="n">ndof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">joints</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">fixed</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">quickstart</span><span class="w"> </span><span class="n">guide</span><span class="w"> </span><span class="n">says</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">joint</span><span class="w"> </span><span class="n">velocities</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">desired</span><span class="w"> </span><span class="n">accelerations</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">there</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">calculateInverseDynamics</span><span class="w"> </span><span class="p">(</span><span class="ow">and</span><span class="w"> </span><span class="n">maybe</span><span class="w"> </span><span class="n">aren</span><span class="s1">&#39;t really meaningful?)</span>

<span class="s1">        desired_accels = ndof * [0.0]</span>

<span class="s1">        # All inputs must be lists (no numpy) or else pybullet will seg fault</span>

<span class="s1">        Jv, Jw = self.client.calculateJacobian(</span>

<span class="s1">            self.id,</span>

<span class="s1">            link,</span>

<span class="s1">            list(local_pos),</span>

<span class="s1">            list(self.joint_angles)[1:],  # Don&#39;</span><span class="n">t</span><span class="w"> </span><span class="k">include</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="n">joint</span>

<span class="w">            </span><span class="n">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">joint_vels</span><span class="p">)</span><span class="o">[</span><span class="n">1:</span><span class="o">]</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Don</span><span class="s1">&#39;t include the first fixed joint</span>

<span class="s1">            desired_accels,</span>

<span class="s1">        )</span>

<span class="s1">        return np.array(Jv), np.array(Jw)</span>

<span class="s1">    def get_link_transform(self, link_index: Union[Links, int]) -&gt; np.ndarray:</span>

<span class="s1">        &quot;&quot;&quot;Calculates the transformation matrix (w.r.t the world) for a specified link</span>

<span class="s1">        Args:</span>

<span class="s1">            link_index (int): Index of the link on the robot</span>

<span class="s1">        Returns:</span>

<span class="s1">            np.ndarray: Transformation matrix (link to world). Shape = (4,4)</span>

<span class="s1">        &quot;&quot;&quot;</span>

<span class="s1">        if isinstance(link_index, Astrobee.Links):</span>

<span class="s1">            link_index = link_index.value</span>

<span class="s1">        # We have 8 links, indexed from -1 to 6</span>

<span class="s1">        # Pybullet does not allow access to the base link (-1) through getLinkState</span>

<span class="s1">        # So, use this only for non-base links</span>

<span class="s1">        if link_index &gt; 6 or link_index &lt; 0:</span>

<span class="s1">            raise ValueError(f&quot;Invalid link index: {link_index}&quot;)</span>

<span class="s1">        link_state = self.client.getLinkState(</span>

<span class="s1">            self.id, link_index, computeForwardKinematics=True</span>

<span class="s1">        )</span>

<span class="s1">        # First two link state values are linkWorldPosition, linkWorldOrientation</span>

<span class="s1">        # There are other state positions and orientations, but they&#39;</span><span class="n">re</span><span class="w"> </span><span class="n">confusing</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">TODO</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">these</span><span class="p">)</span>

<span class="w">        </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">quat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link_state</span><span class="o">[</span><span class="n">:2</span><span class="o">]</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">make_transform_mat</span><span class="p">(</span><span class="n">quat_to_rmat</span><span class="p">(</span><span class="n">quat</span><span class="p">),</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>

<span class="w">    </span><span class="nv">@property</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">Is</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">better</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">property</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ss">&quot;getter&quot;</span><span class="vm">?</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">gripper_position</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">int</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;The current position of the gripper, in range [0, 100]</span>

<span class="ss">        Returns:</span>

<span class="ss">            int: Position of the gripper, an integer between 0 (closed) and 100 (open)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">joint_states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getJointStates</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">GRIPPER_JOINT_IDXS</span><span class="p">)</span>

<span class="w">        </span><span class="n">joint_angles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">state[0</span><span class="o">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">joint_states</span><span class="err">]</span>

<span class="w">        </span><span class="n">l_angles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_angles</span><span class="o">[</span><span class="n">:2</span><span class="o">]</span>

<span class="w">        </span><span class="n">r_angles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_angles</span><span class="o">[</span><span class="n">2:</span><span class="o">]</span>

<span class="w">        </span><span class="n">l_closed</span><span class="p">,</span><span class="w"> </span><span class="n">l_open</span><span class="p">,</span><span class="w"> </span><span class="n">r_closed</span><span class="p">,</span><span class="w"> </span><span class="n">r_open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_gripper_joint_ranges</span><span class="p">()</span>

<span class="w">        </span><span class="n">l_pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">l_angles</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l_closed</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">l_open</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l_closed</span><span class="p">)</span>

<span class="w">        </span><span class="n">r_pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">r_angles</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r_closed</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">r_open</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r_closed</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">average</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span><span class="o">[</span><span class="n">l_pct, r_pct</span><span class="o">]</span><span class="p">))).</span><span class="n">astype</span><span class="p">(</span><span class="nc">int</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">decide</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">finer</span><span class="o">-</span><span class="n">grain</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">individual</span><span class="w"> </span><span class="n">joints</span><span class="p">,</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">integer</span><span class="o">-</span><span class="k">position</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">fine</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">set_gripper_position</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">position</span><span class="err">:</span><span class="w"> </span><span class="nc">float</span><span class="p">,</span><span class="w"> </span><span class="nl">force</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="p">,</span><span class="w"> </span><span class="nl">wait</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Sets the gripper to a position between 0 (fully closed) to 100 (fully open)</span>

<span class="ss">        Args:</span>

<span class="ss">            position (float): Gripper position, in range [0, 100]</span>

<span class="ss">            force (bool, optional): Whether to (non-physically) instantly reset the gripper position, instead</span>

<span class="ss">                of stepping the sim. Should only be used at initialization. Defaults to False</span>

<span class="ss">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="ss">                forwards in a blocking manner. Defaults to False</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="k">position</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="k">position</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="err">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;Position should be in range [0, 100]&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">l_closed</span><span class="p">,</span><span class="w"> </span><span class="n">l_open</span><span class="p">,</span><span class="w"> </span><span class="n">r_closed</span><span class="p">,</span><span class="w"> </span><span class="n">r_open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_gripper_joint_ranges</span><span class="p">()</span>

<span class="w">        </span><span class="n">left_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_closed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="k">position</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">l_open</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l_closed</span><span class="p">)</span>

<span class="w">        </span><span class="n">right_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r_closed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="k">position</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">r_open</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r_closed</span><span class="p">)</span>

<span class="w">        </span><span class="n">angle_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">*left_pos, *right_pos</span><span class="o">]</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">set_gripper_joints</span><span class="p">(</span><span class="n">angle_cmd</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="n">wait</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">open_gripper</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Fully opens the gripper&quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">set_gripper_position</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">force</span><span class="o">/</span><span class="n">torque</span><span class="w"> </span><span class="n">control</span><span class="vm">?</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">close_gripper</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Fully closes the gripper&quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">set_gripper_position</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">rework</span><span class="w"> </span><span class="n">this</span><span class="vm">?</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_get_gripper_joint_ranges</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">np.ndarray, np.ndarray, np.ndarray, np.ndarray</span><span class="o">]</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Helper function to determine the range of motion (closed -&gt; open) of the gripper joints</span>

<span class="ss">        - This is a bit confusing because of how the URDF specifies joint min/max and how this translates</span>

<span class="ss">        to an open/closed position on the gripper</span>

<span class="ss">        - For a fully-closed gripper, the right side joints are at their max, and the left side joints are at their min</span>

<span class="ss">        - Likewise, for a fully-open gripper, the right side is at the joint min, and the left at joint max</span>

<span class="ss">        Returns:</span>

<span class="ss">            tuple[np.ndarray, np.ndarray, np.ndarray, np.ndarray]:</span>

<span class="ss">                np.ndarray: Left-side gripper finger angles when closed. Shape (2,)</span>

<span class="ss">                np.ndarray: Left-side gripper finger angles when open. Shape (2,)</span>

<span class="ss">                np.ndarray: Right-side gripper finger angles when closed. Shape (2,)</span>

<span class="ss">                np.ndarray: Right-side gripper finger angles when open. Shape (2,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">left_joints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">GRIPPER_JOINT_IDXS</span><span class="o">[</span><span class="n">:2</span><span class="o">]</span>

<span class="w">        </span><span class="n">right_joints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">GRIPPER_JOINT_IDXS</span><span class="o">[</span><span class="n">2:</span><span class="o">]</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">As</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">numpy</span><span class="w"> </span><span class="k">array</span><span class="p">,</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">correspond</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">joint</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">columns</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="o">[</span><span class="n">min, max</span><span class="o">]</span>

<span class="w">        </span><span class="n">left_closed</span><span class="p">,</span><span class="w"> </span><span class="n">left_open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">JOINT_POS_LIMITS</span><span class="o">[</span><span class="n">left_joints</span><span class="o">]</span><span class="p">.</span><span class="n">T</span>

<span class="w">        </span><span class="n">right_open</span><span class="p">,</span><span class="w"> </span><span class="n">right_closed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">JOINT_POS_LIMITS</span><span class="o">[</span><span class="n">right_joints</span><span class="o">]</span><span class="p">.</span><span class="n">T</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">left_closed</span><span class="p">,</span><span class="w"> </span><span class="n">left_open</span><span class="p">,</span><span class="w"> </span><span class="n">right_closed</span><span class="p">,</span><span class="w"> </span><span class="n">right_open</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">set_joint_angles</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">angles</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">indices</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">npt.ArrayLike</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">force</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="p">,</span>

<span class="w">        </span><span class="nl">wait</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Sets the joint angles for the Astrobee (either all joints, or a specified subset)</span>

<span class="ss">        Args:</span>

<span class="ss">            angles (npt.ArrayLike): Desired joint angles, in radians</span>

<span class="ss">            indices (npt.ArrayLike, optional): Indices of the joints to control. Defaults to None,</span>

<span class="ss">                in which case we assume all 7 joints will be set.</span>

<span class="ss">            force (bool, optional): Whether to (non-physically) instantly reset the joint state.</span>

<span class="ss">                Should only be used at initialization. Defaults to False</span>

<span class="ss">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="ss">                forwards in a blocking manner. Defaults to False</span>

<span class="ss">        Raises:</span>

<span class="ss">            ValueError: If the number of angles provided do not match the number of indices</span>

<span class="ss">            ValueError: If the angles are out of the joint limits for the specified indices</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="k">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="p">.</span><span class="n">NUM_JOINTS</span><span class="p">))</span>

<span class="w">        </span><span class="n">angles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">scalar</span><span class="p">,</span><span class="w"> </span><span class="n">ensure</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">don</span><span class="s1">&#39;t have a 0-D array</span>

<span class="s1">        indices = np.atleast_1d(indices)</span>

<span class="s1">        if indices.shape != angles.shape:</span>

<span class="s1">            raise ValueError(</span>

<span class="s1">                &quot;Number of angles must match with the number of provided indices&quot;</span>

<span class="s1">            )</span>

<span class="s1">        if np.any(angles &lt; Astrobee.JOINT_POS_LIMITS[indices, 0]) or np.any(</span>

<span class="s1">            angles &gt; Astrobee.JOINT_POS_LIMITS[indices, 1]</span>

<span class="s1">        ):</span>

<span class="s1">            raise ValueError(</span>

<span class="s1">                f&quot;Joint angle command is outside of joint limits.\nGot: {angles} for joints {indices}&quot;</span>

<span class="s1">            )</span>

<span class="s1">        if force:</span>

<span class="s1">            for ind, angle in zip(indices, angles):</span>

<span class="s1">                self.client.resetJointState(self.id, ind, angle)</span>

<span class="s1">        # Set the position control for the arm so Pybullet will correct for disturbances</span>

<span class="s1">        self.client.setJointMotorControlArray(</span>

<span class="s1">            self.id,</span>

<span class="s1">            indices,</span>

<span class="s1">            self.client.POSITION_CONTROL,</span>

<span class="s1">            angles,</span>

<span class="s1">            forces=self.JOINT_EFFORT_LIMITS[indices],</span>

<span class="s1">        )</span>

<span class="s1">        # Step the sim until the arm is at the desired angle, if waiting for it to reach the position</span>

<span class="s1">        if wait:</span>

<span class="s1">            tol = 0.01  # TODO TOTALLY ARBITRARY FOR NOW</span>

<span class="s1">            while np.any(np.abs(self.get_joint_angles(indices) - angles) &gt; tol):</span>

<span class="s1">                self.client.stepSimulation()</span>

<span class="s1">    def get_joint_angles(self, indices: Optional[npt.ArrayLike] = None) -&gt; np.ndarray:</span>

<span class="s1">        &quot;&quot;&quot;Gives the current joint angles for the Astrobee</span>

<span class="s1">        Args:</span>

<span class="s1">            indices (npt.ArrayLike, optional): Indices of the joints of interest. Defaults to None,</span>

<span class="s1">                in which case all joint angles will be returned</span>

<span class="s1">        Returns:</span>

<span class="s1">            np.ndarray: Joint angles (in radians), length = len(indices) or Astrobee.NUM_JOINTS</span>

<span class="s1">        &quot;&quot;&quot;</span>

<span class="s1">        states = self.client.getJointStates(self.id, indices)</span>

<span class="s1">        return np.array([state[0] for state in states])</span>

<span class="s1">    def set_arm_joints(</span>

<span class="s1">        self, angles: npt.ArrayLike, force: bool = False, wait: bool = False</span>

<span class="s1">    ) -&gt; None:</span>

<span class="s1">        &quot;&quot;&quot;Sets the joint angles for the arm (proximal + distal)</span>

<span class="s1">        Args:</span>

<span class="s1">            angles (npt.ArrayLike): Arm joint angles, length = 2</span>

<span class="s1">            force (bool, optional): Whether to (non-physically) instantly reset the joint states.</span>

<span class="s1">                Should only be used at initialization. Defaults to False</span>

<span class="s1">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="s1">                forwards in a blocking manner. Defaults to False</span>

<span class="s1">        &quot;&quot;&quot;</span>

<span class="s1">        self.set_joint_angles(angles, Astrobee.ARM_JOINT_IDXS, force, wait)</span>

<span class="s1">    def set_gripper_joints(</span>

<span class="s1">        self, angles: npt.ArrayLike, force: bool = False, wait: bool = False</span>

<span class="s1">    ) -&gt; None:</span>

<span class="s1">        &quot;&quot;&quot;Sets the joint angles for the gripper (left + right, proximal + distal)</span>

<span class="s1">        Args:</span>

<span class="s1">            angles (npt.ArrayLike): Gripper joint angles, length = 4</span>

<span class="s1">            force (bool, optional): Whether to (non-physically) instantly reset the gripper joints.</span>

<span class="s1">                Should only be used at initialization. Defaults to False</span>

<span class="s1">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="s1">                forwards in a blocking manner. Defaults to False</span>

<span class="s1">        &quot;&quot;&quot;</span>

<span class="s1">        self.set_joint_angles(angles, Astrobee.GRIPPER_JOINT_IDXS, force, wait)</span>

<span class="s1">    def reset_to_ee_pose(self, pose: npt.ArrayLike) -&gt; None:</span>

<span class="s1">        &quot;&quot;&quot;Resets the position of the robot to achieve a target end-effector pose</span>

<span class="s1">        This will currently NOT adjust any of the joints in a &quot;smart&quot; way, it will just reset the position of the base</span>

<span class="s1">        given the current joint configuration</span>

<span class="s1">        Args:</span>

<span class="s1">            pose (npt.ArrayLike): Desired position + XYZW quaternion end-effector pose, shape (7,)</span>

<span class="s1">        &quot;&quot;&quot;</span>

<span class="s1">        # Notation: EE: End effector, B: Base, W: World</span>

<span class="s1">        des_EE2W = pos_quat_to_tmat(pose)</span>

<span class="s1">        cur_B2W = pos_quat_to_tmat(self.pose)</span>

<span class="s1">        cur_EE2W = pos_quat_to_tmat(self.ee_pose)</span>

<span class="s1">        cur_W2EE = invert_transform_mat(cur_EE2W)</span>

<span class="s1">        cur_B2EE = cur_W2EE @ cur_B2W</span>

<span class="s1">        des_B2W = des_EE2W @ cur_B2EE</span>

<span class="s1">        self.reset_to_base_pose(tmat_to_pos_quat(des_B2W))</span>

<span class="s1">    def reset_to_base_pose(self, pose: npt.ArrayLike) -&gt; None:</span>

<span class="s1">        &quot;&quot;&quot;Resets the base of the robot to a target pose</span>

<span class="s1">        Args:</span>

<span class="s1">            pose (npt.ArrayLike): Desired position + XYZW quaternion pose of the Astrobee&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="p">,)</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        self.client.resetBasePositionAndOrientation(self.id, pose[:3], pose[3:])</span>

<span class="ss">    def localize(self):</span>

<span class="ss">        raise NotImplementedError()  # TODO.. see dynamics state. Should have a noise parameter</span>

<span class="ss">    def recompute_inertial_properties(self) -&gt; None:</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="n">Calculate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">inertial</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">robot</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sim</span>

<span class="w">        </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">accurate</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">fixed</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="o">-</span><span class="k">only</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">NASA</span><span class="s1">&#39;s documentation, but it is fairly expensive to</span>

<span class="s1">        compute and should NOT be done on every simulation step.</span>

<span class="s1">        This will update the mass, inertia, inv_inertia, and center of mass</span>

<span class="s1">        &quot;&quot;&quot;</span>

<span class="s1">        # Note: Mass will be fixed, but it is not necessarily the same value as provided by NASA</span>

<span class="s1">        mass = 0.0</span>

<span class="s1">        inertia = np.zeros((3, 3))</span>

<span class="s1">        com = np.zeros(3)</span>

<span class="s1">        T_B2W = self.tmat  # Base to world</span>

<span class="s1">        for link in Astrobee.Links:</span>

<span class="s1">            link_info = pybullet.getDynamicsInfo(self.id, link.value)</span>

<span class="s1">            link_mass = link_info[0]</span>

<span class="s1">            link_inertia_diagonal = link_info[2]</span>

<span class="s1">            if link.value == -1:  # Separate handling for base link</span>

<span class="s1">                inertia += np.diag(link_inertia_diagonal)</span>

<span class="s1">                com += link_mass * T_B2W[:3, 3]</span>

<span class="s1">            else:</span>

<span class="s1">                T_L2W = self.get_link_transform(link.value)  # Link to world</span>

<span class="s1">                T_L2B = invert_transform_mat(T_B2W) @ T_L2W  # Link to base</span>

<span class="s1">                inertia += inertial_transformation(</span>

<span class="s1">                    link_mass, np.diag(link_inertia_diagonal), T_L2B</span>

<span class="s1">                )</span>

<span class="s1">                com += link_mass * T_L2W[:3, 3]</span>

<span class="s1">            mass += link_mass</span>

<span class="s1">        com /= mass</span>

<span class="s1">        self._local_com_position = T_B2W[:3, :3].T @ (com - T_B2W[:3, 3])</span>

<span class="s1">        self._mass = mass</span>

<span class="s1">        self._inertia = inertia</span>

<span class="s1">        self._inv_inertia = np.linalg.inv(inertia)</span>

<span class="s1">    def store_arm(self, force: bool = False, wait: bool = False):</span>

<span class="s1">        &quot;&quot;&quot;Folds the Astrobee&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">arm</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">body</span>

<span class="w">        </span><span class="nl">Note</span><span class="p">:</span><span class="w"> </span><span class="n">Storing</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">arm</span><span class="w"> </span><span class="n">reduces</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">inertia</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">preferable</span>

<span class="w">        </span><span class="n">configuration</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">manipulating</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="n">objects</span>

<span class="w">        </span><span class="nl">Args</span><span class="p">:</span>

<span class="w">            </span><span class="n">force</span><span class="w"> </span><span class="p">(</span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">Whether</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="p">(</span><span class="n">non</span><span class="o">-</span><span class="n">physically</span><span class="p">)</span><span class="w"> </span><span class="n">instantly</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">joints</span><span class="p">.</span>

<span class="w">                </span><span class="n">Should</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">initialization</span><span class="p">.</span><span class="w"> </span><span class="n">Defaults</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">False</span>

<span class="w">            </span><span class="n">wait</span><span class="w"> </span><span class="p">(</span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">Whether</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">arm</span><span class="w"> </span><span class="n">reaches</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">desired</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">stepping</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sim</span>

<span class="w">                </span><span class="n">forwards</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">blocking</span><span class="w"> </span><span class="n">manner</span><span class="p">.</span><span class="w"> </span><span class="n">Defaults</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">False</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        self.set_arm_joints([Astrobee.JOINT_POS_LIMITS[1, 1], 0], force, wait)</span>

<span class="ss">        self.set_gripper_position(0, force, wait)</span>

<span class="ss">    def deploy_arm(self, force: bool = False, wait: bool = False):</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="k">Sets</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">arm</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">position</span><span class="p">,</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gripper</span><span class="w"> </span><span class="n">fully</span><span class="w"> </span><span class="k">open</span>

<span class="w">        </span><span class="nl">Args</span><span class="p">:</span>

<span class="w">            </span><span class="n">force</span><span class="w"> </span><span class="p">(</span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">Whether</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="p">(</span><span class="n">non</span><span class="o">-</span><span class="n">physically</span><span class="p">)</span><span class="w"> </span><span class="n">instantly</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">joints</span><span class="p">.</span>

<span class="w">                </span><span class="n">Should</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">initialization</span><span class="p">.</span><span class="w"> </span><span class="n">Defaults</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">False</span>

<span class="w">            </span><span class="n">wait</span><span class="w"> </span><span class="p">(</span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">Whether</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">arm</span><span class="w"> </span><span class="n">reaches</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">desired</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">stepping</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sim</span>

<span class="w">                </span><span class="n">forwards</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">blocking</span><span class="w"> </span><span class="n">manner</span><span class="p">.</span><span class="w"> </span><span class="n">Defaults</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">False</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        self.set_arm_joints([0, 0], force, wait)</span>

<span class="ss">        self.set_gripper_position(100, force, wait)</span>

<span class="ss">    @property</span>

<span class="ss">    def full_state(self) -&gt; tuple[np.ndarray, ...]:</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="ow">All</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">fully</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Astrobee</span>

<span class="w">        </span><span class="k">Returns</span><span class="err">:</span>

<span class="w">            </span><span class="n">tuple</span><span class="o">[</span><span class="n">np.ndarray, ...</span><span class="o">]</span><span class="err">:</span>

<span class="w">                </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span><span class="w"> </span><span class="k">Position</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

<span class="w">                </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span><span class="w"> </span><span class="n">Orientation</span><span class="w"> </span><span class="p">(</span><span class="n">XYZW</span><span class="w"> </span><span class="n">quaternion</span><span class="p">),</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="p">,)</span>

<span class="w">                </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span><span class="w"> </span><span class="n">Linear</span><span class="w"> </span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

<span class="w">                </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span><span class="w"> </span><span class="n">Angular</span><span class="w"> </span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

<span class="w">                </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span><span class="w"> </span><span class="n">Joint</span><span class="w"> </span><span class="n">positions</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="n">NUM_JOINTS</span><span class="p">,)</span>

<span class="w">                </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span><span class="w"> </span><span class="n">Joint</span><span class="w"> </span><span class="n">velocities</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="n">NUM_JOINTS</span><span class="p">,)</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        pos, orn = self.client.getBasePositionAndOrientation(self.id)</span>

<span class="ss">        vel, ang_vel = self.client.getBaseVelocity(self.id)</span>

<span class="ss">        joint_states = self.client.getJointStates(</span>

<span class="ss">            self.id, list(range(Astrobee.NUM_JOINTS))</span>

<span class="ss">        )</span>

<span class="ss">        joint_positions = np.empty(Astrobee.NUM_JOINTS)</span>

<span class="ss">        joint_vels = np.empty(Astrobee.NUM_JOINTS)</span>

<span class="ss">        for i in range(Astrobee.NUM_JOINTS):</span>

<span class="ss">            joint_positions[i] = joint_states[i][0]</span>

<span class="ss">            joint_vels[i] = joint_states[i][1]</span>

<span class="ss">        return (</span>

<span class="ss">            np.array(pos),</span>

<span class="ss">            np.array(orn),</span>

<span class="ss">            np.array(vel),</span>

<span class="ss">            np.array(ang_vel),</span>

<span class="ss">            joint_positions,</span>

<span class="ss">            joint_vels,</span>

<span class="ss">        )</span>

<span class="ss">    def reset_full_state(</span>

<span class="ss">        self,</span>

<span class="ss">        pos: npt.ArrayLike,</span>

<span class="ss">        orn: npt.ArrayLike,</span>

<span class="ss">        vel: npt.ArrayLike,</span>

<span class="ss">        omega: npt.ArrayLike,</span>

<span class="ss">        q: npt.ArrayLike,</span>

<span class="ss">        qdot: npt.ArrayLike,</span>

<span class="ss">    ):</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="n">Fully</span><span class="w"> </span><span class="n">resets</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Astrobee</span>

<span class="w">        </span><span class="nl">Args</span><span class="p">:</span>

<span class="w">            </span><span class="n">pos</span><span class="w"> </span><span class="p">(</span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="k">Position</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

<span class="w">            </span><span class="n">orn</span><span class="w"> </span><span class="p">(</span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">Orientation</span><span class="w"> </span><span class="p">(</span><span class="n">XYZW</span><span class="w"> </span><span class="n">quaternion</span><span class="p">),</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="p">,)</span>

<span class="w">            </span><span class="n">vel</span><span class="w"> </span><span class="p">(</span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">Linear</span><span class="w"> </span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

<span class="w">            </span><span class="n">omega</span><span class="w"> </span><span class="p">(</span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">Angular</span><span class="w"> </span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

<span class="w">            </span><span class="n">q</span><span class="w"> </span><span class="p">(</span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">Joint</span><span class="w"> </span><span class="n">positions</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="n">NUM_JOINTS</span><span class="p">,)</span>

<span class="w">            </span><span class="n">qdot</span><span class="w"> </span><span class="p">(</span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">Joint</span><span class="w"> </span><span class="n">velocities</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="n">NUM_JOINTS</span><span class="p">,)</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        self.client.resetBasePositionAndOrientation(self.id, pos, orn)</span>

<span class="ss">        self.client.resetBaseVelocity(self.id, vel, omega)</span>

<span class="ss">        for i in range(Astrobee.NUM_JOINTS):</span>

<span class="ss">            self.client.resetJointState(self.id, i, q[i], qdot[i])</span>

<span class="ss">    @property</span>

<span class="ss">    def bounding_box(self) -&gt; np.ndarray:</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="k">Current</span><span class="w"> </span><span class="n">axis</span><span class="o">-</span><span class="n">aligned</span><span class="w"> </span><span class="n">bounding</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Astrobee</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="p">(</span><span class="ow">Not</span><span class="w"> </span><span class="n">including</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">arm</span><span class="p">),</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="ss">&quot;&quot;</span><span class="err">&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getAABB</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>

</details>
<hr />
<h4 id="class-variables">Class variables</h4>
<div class="codehilite"><pre><span></span><code><span class="n">ARM_JOINT_IDXS</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">COLLISION_RADIUS</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">GRIPPER_JOINT_IDXS</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">JOINT_EFFORT_LIMITS</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">JOINT_POS_LIMITS</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">JOINT_VEL_LIMITS</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">Joints</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">Links</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">NUM_JOINTS</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">NUM_LINKS</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">TRANSFORMS</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">URDF</span>
</code></pre></div>

<h4 id="instance-variables">Instance variables</h4>
<div class="codehilite"><pre><span></span><code><span class="n">angular_velocity</span>
</code></pre></div>

<p>Angular velocity of the Astrobee, about the world frame xyz axes</p>
<div class="codehilite"><pre><span></span><code><span class="n">arm_joint_angles</span>
</code></pre></div>

<p>Gives the two joint angles associated with the proximal + distal joints of the arm</p>
<div class="codehilite"><pre><span></span><code><span class="n">bounding_box</span>
</code></pre></div>

<p>Current axis-aligned bounding box of the Astrobee body (Not including the arm), shape (2, 3)</p>
<div class="codehilite"><pre><span></span><code><span class="n">dynamics_state</span>
</code></pre></div>

<p>Current state of the Astrobee's dynamics: Position, orientation, linear vel, and angular vel</p>
<div class="codehilite"><pre><span></span><code><span class="n">ee_pose</span>
</code></pre></div>

<p>The current end-effector pose (position + XYZW quaternion) expressed in world frame</p>
<div class="codehilite"><pre><span></span><code><span class="n">ee_tmat</span>
</code></pre></div>

<p>The current end-effector transformation matrix (gripper-to-world)</p>
<div class="codehilite"><pre><span></span><code><span class="n">full_state</span>
</code></pre></div>

<p>All information required to fully reset the state of the Astrobee</p>
<div class="codehilite"><pre><span></span><code><span class="n">gripper_joint_angles</span>
</code></pre></div>

<p>Gives the four joint angles associated with the proximal + distal joints of the two gripper fingers</p>
<div class="codehilite"><pre><span></span><code><span class="n">gripper_position</span>
</code></pre></div>

<p>The current position of the gripper, in range [0, 100]</p>
<div class="codehilite"><pre><span></span><code><span class="n">heading</span>
</code></pre></div>

<p>A unit vector in the forward (x) component of the astrobee</p>
<p>Some notes:
- This is NOT a full description of orientation since rotation about this axis is undefined
- The arm is on the REAR side of the astrobee, not the front
- The y vector points to the port (left) side of the astrobee, and the z vector is up</p>
<div class="codehilite"><pre><span></span><code><span class="n">inertia</span>
</code></pre></div>

<p>Body inertia tensor for the Astrobee, shape (3, 3)</p>
<div class="codehilite"><pre><span></span><code><span class="n">inv_inertia</span>
</code></pre></div>

<p>Inverse of the Astrobee's body inertia tensor, shape (3, 3)</p>
<div class="codehilite"><pre><span></span><code><span class="n">joint_angles</span>
</code></pre></div>

<p>Angular positions (radians) of each joint on the Astrobee</p>
<div class="codehilite"><pre><span></span><code><span class="n">joint_torques</span>
</code></pre></div>

<p>Torques (N-m) applied by each joint on the Astrobee</p>
<div class="codehilite"><pre><span></span><code><span class="n">joint_vels</span>
</code></pre></div>

<p>Angular velocities (radians/sec) of each joint on the Astrobee</p>
<div class="codehilite"><pre><span></span><code><span class="n">local_com_position</span>
</code></pre></div>

<p>Position of the center of mass of the robot w.r.t. the base, in local frame. Shape (3,)</p>
<div class="codehilite"><pre><span></span><code><span class="n">mass</span>
</code></pre></div>

<p>Mass of the Astrobee</p>
<div class="codehilite"><pre><span></span><code><span class="n">mass_matrix</span>
</code></pre></div>

<p>Mass/Inertia matrix for the Astrobee, given its current configuration</p>
<ul>
<li>This is used to determine the kinetic energy (K = (1/2) * qdot.T @ M @ qdot) or the relationship between
  joint accelerations and torque (M * joint_accels + centrifugal_coriolis_vec + gravity_vec = torque)</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">orientation</span>
</code></pre></div>

<p>Just the quaternion component of the full pose</p>
<div class="codehilite"><pre><span></span><code><span class="n">pose</span>
</code></pre></div>

<p>The current robot pose (position + XYZW quaternion) expressed in world frame</p>
<div class="codehilite"><pre><span></span><code><span class="n">position</span>
</code></pre></div>

<p>Just the position component of the full pose</p>
<div class="codehilite"><pre><span></span><code><span class="n">rmat</span>
</code></pre></div>

<p>The orientation of the robot expressed as a rotation matrix</p>
<div class="codehilite"><pre><span></span><code><span class="n">state_space_matrices</span>
</code></pre></div>

<p>The state and control matrices A and B, such that x_dot = Ax + Bu</p>
<p>We assume that the state x = [position, velocity, quaternion, angular velocity] ∈ R13
and that the control u = [force, torque] ∈ R6</p>
<p>We linearize the system about the current state</p>
<div class="codehilite"><pre><span></span><code><span class="n">state_vector</span>
</code></pre></div>

<p>The state vector x, such that x_dot = Ax + Bu</p>
<p>We compose the state as [position, velocity, quaternion, angular velocity] ∈ R13</p>
<div class="codehilite"><pre><span></span><code><span class="n">tmat</span>
</code></pre></div>

<p>The current robot pose in world frame, expressed as a transformation matrix</p>
<div class="codehilite"><pre><span></span><code><span class="n">velocity</span>
</code></pre></div>

<p>Linear velocity of the Astrobee, with respect to the world frame xyz axes</p>
<div class="codehilite"><pre><span></span><code><span class="n">world_com_position</span>
</code></pre></div>

<p>Position of the center of mass of the robot, in world frame. Shape (3,)</p>
<div class="codehilite"><pre><span></span><code><span class="n">world_inertia</span>
</code></pre></div>

<p>World-frame inertia tensor of the Astrobee, shape (3, 3)</p>
<p>This takes into account the current rotation of Astrobee</p>
<div class="codehilite"><pre><span></span><code><span class="n">world_inv_inertia</span>
</code></pre></div>

<p>Inverse of the world-frame inertia tensor of the Astrobee, shape (3, 3)</p>
<p>This takes into account the current rotation of Astrobee</p>
<h4 id="methods">Methods</h4>
<h4 id="close_gripper">close_gripper</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close_gripper</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Fully closes the gripper</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">close_gripper</span><span class="p">(</span><span class="kr">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Fully closes the gripper&quot;&quot;&quot;</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">set_gripper_position</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="deploy_arm">deploy_arm</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">deploy_arm</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span>
</code></pre></div>

<p>Sets the arm to the default position, with the gripper fully open</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>force</td>
<td>bool</td>
<td>Whether to (non-physically) instantly reset the joints.<br>Should only be used at initialization. Defaults to False</td>
<td>None</td>
</tr>
<tr>
<td>wait</td>
<td>bool</td>
<td>Whether to wait until the arm reaches the desired state by stepping the sim<br>forwards in a blocking manner. Defaults to False</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def deploy_arm(self, force: bool = False, wait: bool = False):

        &quot;&quot;&quot;Sets the arm to the default position, with the gripper fully open

        Args:

            force (bool, optional): Whether to (non-physically) instantly reset the joints.

                Should only be used at initialization. Defaults to False

            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim

                forwards in a blocking manner. Defaults to False

        &quot;&quot;&quot;

        self.set_arm_joints([0, 0], force, wait)

        self.set_gripper_position(100, force, wait)
</code></pre></div>

</details>
<h4 id="get_jacobians">get_jacobians</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_jacobians</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">link</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pyastrobee</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">astrobee</span><span class="o">.</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">Links</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">local_pos</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
</code></pre></div>

<p>Calculate the linear and angular jacobians (Jv and Jw) for a point on a link</p>
<ul>
<li>These relate joint motion and task-space motion: [v; w] = [Jv; Jw] * dq</li>
<li>These jacobians will have a 12 columns corresponding to 6 DOF from the Astrobee's floating base, plus another
  6 DOF from the non-fixed joints</li>
</ul>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>link</td>
<td>Union[Links, int]</td>
<td>Link or link index of interest.<br>Common links: For the base, set this to -1. For the arm distal link, set this to 2</td>
<td>None</td>
</tr>
<tr>
<td>local_pos</td>
<td>npt.ArrayLike</td>
<td>Position in the link's reference frame. Defaults to [0.0, 0.0, 0.0].<br>For the grasp point, use the position from the calibrated distal/grasp transformation</td>
<td>[0.0, 0.0, 0.0]</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>tuple[np.ndarray, np.ndarray]</td>
<td>np.ndarray: Jv: Linear jacobian, shape (3, 12)<br>np.ndarray: Jw: Angular jacobian, shape (3, 12)</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nt">def</span><span class="w"> </span><span class="nt">get_jacobians</span><span class="o">(</span>

<span class="w">        </span><span class="nt">self</span><span class="o">,</span><span class="w"> </span><span class="nt">link</span><span class="o">:</span><span class="w"> </span><span class="nt">Union</span><span class="cp">[</span><span class="nx">Links</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="cp">]</span><span class="o">,</span><span class="w"> </span><span class="nt">local_pos</span><span class="o">:</span><span class="w"> </span><span class="nt">npt</span><span class="p">.</span><span class="nc">ArrayLike</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="nt">0</span><span class="p">.</span><span class="nc">0</span><span class="o">,</span><span class="w"> </span><span class="nt">0</span><span class="p">.</span><span class="nc">0</span><span class="o">,</span><span class="w"> </span><span class="nt">0</span><span class="p">.</span><span class="nc">0</span><span class="o">)</span>

<span class="w">    </span><span class="o">)</span><span class="w"> </span><span class="nt">-</span><span class="o">&gt;</span><span class="w"> </span><span class="nt">tuple</span><span class="cp">[</span><span class="nx">np.ndarray</span><span class="p">,</span><span class="w"> </span><span class="nx">np.ndarray</span><span class="cp">]</span><span class="o">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Calculate the linear and angular jacobians (Jv and Jw) for a point on a link</span>

<span class="s2">        - These relate joint motion and task-space motion: </span><span class="cp">[</span><span class="nx">v</span><span class="p">;</span><span class="w"> </span><span class="nx">w</span><span class="cp">]</span><span class="s2"> = </span><span class="cp">[</span><span class="nx">Jv</span><span class="p">;</span><span class="w"> </span><span class="nx">Jw</span><span class="cp">]</span><span class="s2"> * dq</span>

<span class="s2">        - These jacobians will have a 12 columns corresponding to 6 DOF from the Astrobee&#39;s floating base, plus another</span>

<span class="s2">          6 DOF from the non-fixed joints</span>

<span class="s2">        Args:</span>

<span class="s2">            link (Union</span><span class="cp">[</span><span class="nx">Links</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="cp">]</span><span class="s2">): Link or link index of interest.</span>

<span class="s2">                Common links: For the base, set this to -1. For the arm distal link, set this to 2</span>

<span class="s2">            local_pos (npt.ArrayLike, optional): Position in the link&#39;s reference frame. Defaults to </span><span class="cp">[</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="cp">]</span><span class="s2">.</span>

<span class="s2">                For the grasp point, use the position from the calibrated distal/grasp transformation</span>

<span class="s2">        Returns:</span>

<span class="s2">            tuple</span><span class="cp">[</span><span class="nx">np.ndarray</span><span class="p">,</span><span class="w"> </span><span class="nx">np.ndarray</span><span class="cp">]</span><span class="s2">:</span>

<span class="s2">                np.ndarray: Jv: Linear jacobian, shape (3, 12)</span>

<span class="s2">                np.ndarray: Jw: Angular jacobian, shape (3, 12)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="nt">if</span><span class="w"> </span><span class="nt">isinstance</span><span class="o">(</span><span class="nt">link</span><span class="o">,</span><span class="w"> </span><span class="nt">Astrobee</span><span class="p">.</span><span class="nc">Links</span><span class="o">):</span>

<span class="w">            </span><span class="nt">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">link</span><span class="p">.</span><span class="nc">value</span>

<span class="w">        </span><span class="nt">ndof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">6</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nt">7</span><span class="w"> </span><span class="nt">joints</span><span class="o">,</span><span class="w"> </span><span class="nt">but</span><span class="w"> </span><span class="nt">1</span><span class="w"> </span><span class="nt">fixed</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nt">The</span><span class="w"> </span><span class="nt">quickstart</span><span class="w"> </span><span class="nt">guide</span><span class="w"> </span><span class="nt">says</span><span class="w"> </span><span class="nt">that</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">joint</span><span class="w"> </span><span class="nt">velocities</span><span class="w"> </span><span class="nt">and</span><span class="w"> </span><span class="nt">desired</span><span class="w"> </span><span class="nt">accelerations</span><span class="w"> </span><span class="nt">are</span><span class="w"> </span><span class="nt">just</span><span class="w"> </span><span class="nt">there</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nt">for</span><span class="w"> </span><span class="nt">an</span><span class="w"> </span><span class="nt">internal</span><span class="w"> </span><span class="nt">call</span><span class="w"> </span><span class="nt">to</span><span class="w"> </span><span class="nt">calculateInverseDynamics</span><span class="w"> </span><span class="o">(</span><span class="nt">and</span><span class="w"> </span><span class="nt">maybe</span><span class="w"> </span><span class="nt">aren</span><span class="s1">&#39;t really meaningful?)</span>

<span class="s1">        desired_accels = ndof * </span><span class="cp">[</span><span class="mf">0.0</span><span class="cp">]</span>

<span class="s1">        # All inputs must be lists (no numpy) or else pybullet will seg fault</span>

<span class="s1">        Jv, Jw = self.client.calculateJacobian(</span>

<span class="s1">            self.id,</span>

<span class="s1">            link,</span>

<span class="s1">            list(local_pos),</span>

<span class="s1">            list(self.joint_angles)</span><span class="cp">[</span><span class="mi">1</span><span class="p">:</span><span class="cp">]</span><span class="s1">,  # Don&#39;</span><span class="nt">t</span><span class="w"> </span><span class="nt">include</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">first</span><span class="w"> </span><span class="nt">fixed</span><span class="w"> </span><span class="nt">joint</span>

<span class="w">            </span><span class="nt">list</span><span class="o">(</span><span class="nt">self</span><span class="p">.</span><span class="nc">joint_vels</span><span class="o">)</span><span class="cp">[</span><span class="mi">1</span><span class="p">:</span><span class="cp">]</span><span class="o">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nt">Don</span><span class="err">&#39;</span><span class="nt">t</span><span class="w"> </span><span class="nt">include</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">first</span><span class="w"> </span><span class="nt">fixed</span><span class="w"> </span><span class="nt">joint</span>

<span class="w">            </span><span class="nt">desired_accels</span><span class="o">,</span>

<span class="w">        </span><span class="o">)</span>

<span class="w">        </span><span class="nt">return</span><span class="w"> </span><span class="nt">np</span><span class="p">.</span><span class="nc">array</span><span class="o">(</span><span class="nt">Jv</span><span class="o">),</span><span class="w"> </span><span class="nt">np</span><span class="p">.</span><span class="nc">array</span><span class="o">(</span><span class="nt">Jw</span><span class="o">)</span>
</code></pre></div>

</details>
<h4 id="get_joint_angles">get_joint_angles</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_joint_angles</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">indices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
</code></pre></div>

<p>Gives the current joint angles for the Astrobee</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>indices</td>
<td>npt.ArrayLike</td>
<td>Indices of the joints of interest. Defaults to None,<br>in which case all joint angles will be returned</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>np.ndarray</td>
<td>Joint angles (in radians), length = len(indices) or Astrobee.NUM_JOINTS</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">get_joint_angles</span><span class="p">(</span><span class="kr">self</span><span class="p">,</span><span class="w"> </span><span class="n">indices</span><span class="o">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Gives the current joint angles for the Astrobee</span>

<span class="s">        Args:</span>

<span class="s">            indices (npt.ArrayLike, optional): Indices of the joints of interest. Defaults to None,</span>

<span class="s">                in which case all joint angles will be returned</span>

<span class="s">        Returns:</span>

<span class="s">            np.ndarray: Joint angles (in radians), length = len(indices) or Astrobee.NUM_JOINTS</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getJointStates</span><span class="p">(</span><span class="kr">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">indices</span><span class="p">)</span>

<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">states</span><span class="p">])</span>
</code></pre></div>

</details>
<h4 id="get_link_transform">get_link_transform</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_link_transform</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">link_index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pyastrobee</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">astrobee</span><span class="o">.</span><span class="n">Astrobee</span><span class="o">.</span><span class="n">Links</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
</code></pre></div>

<p>Calculates the transformation matrix (w.r.t the world) for a specified link</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>link_index</td>
<td>int</td>
<td>Index of the link on the robot</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>np.ndarray</td>
<td>Transformation matrix (link to world). Shape = (4,4)</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">get_link_transform</span><span class="p">(</span><span class="kr">self</span><span class="p">,</span><span class="w"> </span><span class="n">link_index</span><span class="o">:</span><span class="w"> </span><span class="n">Union</span><span class="p">[</span><span class="n">Links</span><span class="p">,</span><span class="w"> </span><span class="n">int</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Calculates the transformation matrix (w.r.t the world) for a specified link</span>

<span class="s">        Args:</span>

<span class="s">            link_index (int): Index of the link on the robot</span>

<span class="s">        Returns:</span>

<span class="s">            np.ndarray: Transformation matrix (link to world). Shape = (4,4)</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="nf">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">link_index</span><span class="p">,</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">Links</span><span class="p">)</span><span class="o">:</span>

<span class="w">            </span><span class="n">link_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link_index</span><span class="p">.</span><span class="n">value</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">links</span><span class="p">,</span><span class="w"> </span><span class="n">indexed</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">6</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Pybullet</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="kr">not</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">getLinkState</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">So</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">only</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">base</span><span class="w"> </span><span class="n">links</span>

<span class="w">        </span><span class="nf">if</span><span class="w"> </span><span class="n">link_index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="kr">or</span><span class="w"> </span><span class="n">link_index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;Invalid link index: {link_index}&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">link_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getLinkState</span><span class="p">(</span>

<span class="w">            </span><span class="kr">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">link_index</span><span class="p">,</span><span class="w"> </span><span class="n">computeForwardKinematics</span><span class="o">=</span><span class="kr">True</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="kr">First</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">linkWorldPosition</span><span class="p">,</span><span class="w"> </span><span class="n">linkWorldOrientation</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="kr">and</span><span class="w"> </span><span class="n">orientations</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">they</span><span class="s">&#39;re confusing. (TODO check on these)</span>

<span class="s">        pos, quat = link_state[:2]</span>

<span class="s">        return make_transform_mat(quat_to_rmat(quat), pos)</span>
</code></pre></div>

</details>
<h4 id="localize">localize</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">localize</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def localize(self):

        raise NotImplementedError()  # TODO.. see dynamics state. Should have a noise parameter
</code></pre></div>

</details>
<h4 id="open_gripper">open_gripper</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">open_gripper</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Fully opens the gripper</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">open_gripper</span><span class="p">(</span><span class="kr">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Fully opens the gripper&quot;&quot;&quot;</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">set_gripper_position</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="recompute_inertial_properties">recompute_inertial_properties</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">recompute_inertial_properties</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Calculate the inertial properties based on the current state of the robot in sim</p>
<p>This is more accurate than the fixed, base-only values from NASA's documentation, but it is fairly expensive to
compute and should NOT be done on every simulation step.</p>
<p>This will update the mass, inertia, inv_inertia, and center of mass</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def recompute_inertial_properties(self) -&gt; None:

        &quot;&quot;&quot;Calculate the inertial properties based on the current state of the robot in sim

        This is more accurate than the fixed, base-only values from NASA&#39;s documentation, but it is fairly expensive to

        compute and should NOT be done on every simulation step.

        This will update the mass, inertia, inv_inertia, and center of mass

        &quot;&quot;&quot;

        # Note: Mass will be fixed, but it is not necessarily the same value as provided by NASA

        mass = 0.0

        inertia = np.zeros((3, 3))

        com = np.zeros(3)

        T_B2W = self.tmat  # Base to world

        for link in Astrobee.Links:

            link_info = pybullet.getDynamicsInfo(self.id, link.value)

            link_mass = link_info[0]

            link_inertia_diagonal = link_info[2]

            if link.value == -1:  # Separate handling for base link

                inertia += np.diag(link_inertia_diagonal)

                com += link_mass <span class="gs">* T_B2W[:3, 3]</span>

<span class="gs">            else:</span>

<span class="gs">                T_L2W = self.get_link_transform(link.value)  # Link to world</span>

<span class="gs">                T_L2B = invert_transform_mat(T_B2W) @ T_L2W  # Link to base</span>

<span class="gs">                inertia += inertial_transformation(</span>

<span class="gs">                    link_mass, np.diag(link_inertia_diagonal), T_L2B</span>

<span class="gs">                )</span>

<span class="gs">                com += link_mass *</span> T_L2W[:3, 3]

            mass += link_mass

        com /= mass

        self._local_com_position = T_B2W[:3, :3].T @ (com - T_B2W[:3, 3])

        self._mass = mass

        self._inertia = inertia

        self._inv_inertia = np.linalg.inv(inertia)
</code></pre></div>

</details>
<h4 id="reset_full_state">reset_full_state</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">reset_full_state</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pos</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">orn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">vel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">omega</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">q</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">qdot</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]]</span>
<span class="p">)</span>
</code></pre></div>

<p>Fully resets the state of the Astrobee</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>pos</td>
<td>npt.ArrayLike</td>
<td>Position, shape (3,)</td>
<td>None</td>
</tr>
<tr>
<td>orn</td>
<td>npt.ArrayLike</td>
<td>Orientation (XYZW quaternion), shape (4,)</td>
<td>None</td>
</tr>
<tr>
<td>vel</td>
<td>npt.ArrayLike</td>
<td>Linear velocity, shape (3,)</td>
<td>None</td>
</tr>
<tr>
<td>omega</td>
<td>npt.ArrayLike</td>
<td>Angular velocity, shape (3,)</td>
<td>None</td>
</tr>
<tr>
<td>q</td>
<td>npt.ArrayLike</td>
<td>Joint positions, shape (NUM_JOINTS,)</td>
<td>None</td>
</tr>
<tr>
<td>qdot</td>
<td>npt.ArrayLike</td>
<td>Joint velocities, shape (NUM_JOINTS,)</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">reset_full_state</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">pos</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">orn</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">vel</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">omega</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">q</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">qdot</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Fully resets the state of the Astrobee</span>

<span class="ss">        Args:</span>

<span class="ss">            pos (npt.ArrayLike): Position, shape (3,)</span>

<span class="ss">            orn (npt.ArrayLike): Orientation (XYZW quaternion), shape (4,)</span>

<span class="ss">            vel (npt.ArrayLike): Linear velocity, shape (3,)</span>

<span class="ss">            omega (npt.ArrayLike): Angular velocity, shape (3,)</span>

<span class="ss">            q (npt.ArrayLike): Joint positions, shape (NUM_JOINTS,)</span>

<span class="ss">            qdot (npt.ArrayLike): Joint velocities, shape (NUM_JOINTS,)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">resetBasePositionAndOrientation</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">resetBaseVelocity</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">vel</span><span class="p">,</span><span class="w"> </span><span class="n">omega</span><span class="p">)</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="p">.</span><span class="n">NUM_JOINTS</span><span class="p">)</span><span class="err">:</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">resetJointState</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">qdot</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="reset_to_base_pose">reset_to_base_pose</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">reset_to_base_pose</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Resets the base of the robot to a target pose</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>pose</td>
<td>npt.ArrayLike</td>
<td>Desired position + XYZW quaternion pose of the Astrobee's base, shape (7,)</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">reset_to_base_pose</span><span class="p">(</span><span class="kr">self</span><span class="p">,</span><span class="w"> </span><span class="n">pose</span><span class="o">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Resets the base of the robot to a target pose</span>

<span class="s">        Args:</span>

<span class="s">            pose (npt.ArrayLike): Desired position + XYZW quaternion pose of the Astrobee&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="p">,)</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;</span>

<span class="s">        self.client.resetBasePositionAndOrientation(self.id, pose[:3], pose[3:])</span>
</code></pre></div>

</details>
<h4 id="reset_to_ee_pose">reset_to_ee_pose</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">reset_to_ee_pose</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Resets the position of the robot to achieve a target end-effector pose</p>
<p>This will currently NOT adjust any of the joints in a "smart" way, it will just reset the position of the base
given the current joint configuration</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>pose</td>
<td>npt.ArrayLike</td>
<td>Desired position + XYZW quaternion end-effector pose, shape (7,)</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">reset_to_ee_pose</span><span class="p">(</span><span class="kr">self</span><span class="p">,</span><span class="w"> </span><span class="n">pose</span><span class="o">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Resets the position of the robot to achieve a target end-effector pose</span>

<span class="s">        This will currently NOT adjust any of the joints in a &quot;</span><span class="n">smart</span><span class="s">&quot; way, it will just reset the position of the base</span>

<span class="s">        given the current joint configuration</span>

<span class="s">        Args:</span>

<span class="s">            pose (npt.ArrayLike): Desired position + XYZW quaternion end-effector pose, shape (7,)</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Notation</span><span class="o">:</span><span class="w"> </span><span class="n">EE</span><span class="o">:</span><span class="w"> </span><span class="kd">End </span><span class="n">effector</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">:</span><span class="w"> </span><span class="n">Base</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="o">:</span><span class="w"> </span><span class="n">World</span>

<span class="w">        </span><span class="n">des_EE2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos_quat_to_tmat</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>

<span class="w">        </span><span class="n">cur_B2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos_quat_to_tmat</span><span class="p">(</span><span class="kr">self</span><span class="p">.</span><span class="n">pose</span><span class="p">)</span>

<span class="w">        </span><span class="n">cur_EE2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos_quat_to_tmat</span><span class="p">(</span><span class="kr">self</span><span class="p">.</span><span class="n">ee_pose</span><span class="p">)</span>

<span class="w">        </span><span class="n">cur_W2EE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invert_transform_mat</span><span class="p">(</span><span class="n">cur_EE2W</span><span class="p">)</span>

<span class="w">        </span><span class="n">cur_B2EE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_W2EE</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">cur_B2W</span>

<span class="w">        </span><span class="n">des_B2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">des_EE2W</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">cur_B2EE</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">reset_to_base_pose</span><span class="p">(</span><span class="n">tmat_to_pos_quat</span><span class="p">(</span><span class="n">des_B2W</span><span class="p">))</span>
</code></pre></div>

</details>
<h4 id="set_arm_joints">set_arm_joints</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">set_arm_joints</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">angles</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Sets the joint angles for the arm (proximal + distal)</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>angles</td>
<td>npt.ArrayLike</td>
<td>Arm joint angles, length = 2</td>
<td>None</td>
</tr>
<tr>
<td>force</td>
<td>bool</td>
<td>Whether to (non-physically) instantly reset the joint states.<br>Should only be used at initialization. Defaults to False</td>
<td>None</td>
</tr>
<tr>
<td>wait</td>
<td>bool</td>
<td>Whether to wait until the arm reaches the desired state by stepping the sim<br>forwards in a blocking manner. Defaults to False</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">set_arm_joints</span><span class="p">(</span>

<span class="w">        </span><span class="kr">self</span><span class="p">,</span><span class="w"> </span><span class="n">angles</span><span class="o">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="o">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">False</span><span class="p">,</span><span class="w"> </span><span class="kr">wait</span><span class="o">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">False</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Sets the joint angles for the arm (proximal + distal)</span>

<span class="s">        Args:</span>

<span class="s">            angles (npt.ArrayLike): Arm joint angles, length = 2</span>

<span class="s">            force (bool, optional): Whether to (non-physically) instantly reset the joint states.</span>

<span class="s">                Should only be used at initialization. Defaults to False</span>

<span class="s">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="s">                forwards in a blocking manner. Defaults to False</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">set_joint_angles</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">ARM_JOINT_IDXS</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="kr">wait</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="set_gripper_joints">set_gripper_joints</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">set_gripper_joints</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">angles</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Sets the joint angles for the gripper (left + right, proximal + distal)</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>angles</td>
<td>npt.ArrayLike</td>
<td>Gripper joint angles, length = 4</td>
<td>None</td>
</tr>
<tr>
<td>force</td>
<td>bool</td>
<td>Whether to (non-physically) instantly reset the gripper joints.<br>Should only be used at initialization. Defaults to False</td>
<td>None</td>
</tr>
<tr>
<td>wait</td>
<td>bool</td>
<td>Whether to wait until the arm reaches the desired state by stepping the sim<br>forwards in a blocking manner. Defaults to False</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">set_gripper_joints</span><span class="p">(</span>

<span class="w">        </span><span class="kr">self</span><span class="p">,</span><span class="w"> </span><span class="n">angles</span><span class="o">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="o">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">False</span><span class="p">,</span><span class="w"> </span><span class="kr">wait</span><span class="o">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">False</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Sets the joint angles for the gripper (left + right, proximal + distal)</span>

<span class="s">        Args:</span>

<span class="s">            angles (npt.ArrayLike): Gripper joint angles, length = 4</span>

<span class="s">            force (bool, optional): Whether to (non-physically) instantly reset the gripper joints.</span>

<span class="s">                Should only be used at initialization. Defaults to False</span>

<span class="s">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="s">                forwards in a blocking manner. Defaults to False</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">set_joint_angles</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">GRIPPER_JOINT_IDXS</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="kr">wait</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="set_gripper_position">set_gripper_position</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">set_gripper_position</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">position</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Sets the gripper to a position between 0 (fully closed) to 100 (fully open)</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>position</td>
<td>float</td>
<td>Gripper position, in range [0, 100]</td>
<td>None</td>
</tr>
<tr>
<td>force</td>
<td>bool</td>
<td>Whether to (non-physically) instantly reset the gripper position, instead<br>of stepping the sim. Should only be used at initialization. Defaults to False</td>
<td>None</td>
</tr>
<tr>
<td>wait</td>
<td>bool</td>
<td>Whether to wait until the arm reaches the desired state by stepping the sim<br>forwards in a blocking manner. Defaults to False</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def set_gripper_position(

        self, position: float, force: bool = False, wait: bool = False

    ) -&gt; None:

        &quot;&quot;&quot;Sets the gripper to a position between 0 (fully closed) to 100 (fully open)

        Args:

            position (float): Gripper position, in range [0, 100]

            force (bool, optional): Whether to (non-physically) instantly reset the gripper position, instead

                of stepping the sim. Should only be used at initialization. Defaults to False

            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim

                forwards in a blocking manner. Defaults to False

        &quot;&quot;&quot;

        if position &lt; 0 or position &gt; 100:

            raise ValueError(&quot;Position should be in range [0, 100]&quot;)

        l_closed, l_open, r_closed, r_open = self._get_gripper_joint_ranges()

        left_pos = l_closed + (position / 100) <span class="gs">* (l_open - l_closed)</span>

<span class="gs">        right_pos = r_closed + (position / 100) *</span> (r_open - r_closed)

        angle_cmd = [*left_pos, *right_pos]

        self.set_gripper_joints(angle_cmd, force, wait)
</code></pre></div>

</details>
<h4 id="set_joint_angles">set_joint_angles</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">set_joint_angles</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">angles</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">indices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span>
</code></pre></div>

<p>Sets the joint angles for the Astrobee (either all joints, or a specified subset)</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>angles</td>
<td>npt.ArrayLike</td>
<td>Desired joint angles, in radians</td>
<td>None</td>
</tr>
<tr>
<td>indices</td>
<td>npt.ArrayLike</td>
<td>Indices of the joints to control. Defaults to None,<br>in which case we assume all 7 joints will be set.</td>
<td>None</td>
</tr>
<tr>
<td>force</td>
<td>bool</td>
<td>Whether to (non-physically) instantly reset the joint state.<br>Should only be used at initialization. Defaults to False</td>
<td>None</td>
</tr>
<tr>
<td>wait</td>
<td>bool</td>
<td>Whether to wait until the arm reaches the desired state by stepping the sim<br>forwards in a blocking manner. Defaults to False</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Raises:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ValueError</td>
<td>If the number of angles provided do not match the number of indices</td>
</tr>
<tr>
<td>ValueError</td>
<td>If the angles are out of the joint limits for the specified indices</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">set_joint_angles</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">angles</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">indices</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">npt.ArrayLike</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">force</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="p">,</span>

<span class="w">        </span><span class="nl">wait</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Sets the joint angles for the Astrobee (either all joints, or a specified subset)</span>

<span class="ss">        Args:</span>

<span class="ss">            angles (npt.ArrayLike): Desired joint angles, in radians</span>

<span class="ss">            indices (npt.ArrayLike, optional): Indices of the joints to control. Defaults to None,</span>

<span class="ss">                in which case we assume all 7 joints will be set.</span>

<span class="ss">            force (bool, optional): Whether to (non-physically) instantly reset the joint state.</span>

<span class="ss">                Should only be used at initialization. Defaults to False</span>

<span class="ss">            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim</span>

<span class="ss">                forwards in a blocking manner. Defaults to False</span>

<span class="ss">        Raises:</span>

<span class="ss">            ValueError: If the number of angles provided do not match the number of indices</span>

<span class="ss">            ValueError: If the angles are out of the joint limits for the specified indices</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="k">range</span><span class="p">(</span><span class="n">Astrobee</span><span class="p">.</span><span class="n">NUM_JOINTS</span><span class="p">))</span>

<span class="w">        </span><span class="n">angles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">scalar</span><span class="p">,</span><span class="w"> </span><span class="n">ensure</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">don</span><span class="err">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="k">array</span>

<span class="w">        </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">indices</span><span class="p">.</span><span class="n">shape</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">angles</span><span class="p">.</span><span class="nl">shape</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="ss">&quot;Number of angles must match with the number of provided indices&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="ow">any</span><span class="p">(</span><span class="n">angles</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">JOINT_POS_LIMITS</span><span class="o">[</span><span class="n">indices, 0</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="ow">any</span><span class="p">(</span>

<span class="w">            </span><span class="n">angles</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">.</span><span class="n">JOINT_POS_LIMITS</span><span class="o">[</span><span class="n">indices, 1</span><span class="o">]</span>

<span class="w">        </span><span class="p">)</span><span class="err">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="n">f</span><span class="ss">&quot;Joint angle command is outside of joint limits.\nGot: {angles} for joints {indices}&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">force</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">ind</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="n">angles</span><span class="p">)</span><span class="err">:</span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">resetJointState</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ind</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="p">)</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Set</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">position</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">arm</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">Pybullet</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">disturbances</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">setJointMotorControlArray</span><span class="p">(</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>

<span class="w">            </span><span class="n">indices</span><span class="p">,</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">POSITION_CONTROL</span><span class="p">,</span>

<span class="w">            </span><span class="n">angles</span><span class="p">,</span>

<span class="w">            </span><span class="n">forces</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">JOINT_EFFORT_LIMITS</span><span class="o">[</span><span class="n">indices</span><span class="o">]</span><span class="p">,</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sim</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">arm</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">desired</span><span class="w"> </span><span class="n">angle</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">reach</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">position</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">wait</span><span class="p">:</span>

<span class="w">            </span><span class="n">tol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">TOTALLY</span><span class="w"> </span><span class="n">ARBITRARY</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="n">NOW</span>

<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="ow">any</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">get_joint_angles</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">angles</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tol</span><span class="p">)</span><span class="err">:</span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">stepSimulation</span><span class="p">()</span>
</code></pre></div>

</details>
<h4 id="store_arm">store_arm</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">store_arm</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span>
</code></pre></div>

<p>Folds the Astrobee's arm into its body</p>
<p>Note: Storing the arm reduces the products of inertia, so this is the preferable
configuration if not manipulating any objects</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>force</td>
<td>bool</td>
<td>Whether to (non-physically) instantly reset the joints.<br>Should only be used at initialization. Defaults to False</td>
<td>None</td>
</tr>
<tr>
<td>wait</td>
<td>bool</td>
<td>Whether to wait until the arm reaches the desired state by stepping the sim<br>forwards in a blocking manner. Defaults to False</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def store_arm(self, force: bool = False, wait: bool = False):

        &quot;&quot;&quot;Folds the Astrobee&#39;s arm into its body

        Note: Storing the arm reduces the products of inertia, so this is the preferable

        configuration if not manipulating any objects

        Args:

            force (bool, optional): Whether to (non-physically) instantly reset the joints.

                Should only be used at initialization. Defaults to False

            wait (bool, optional): Whether to wait until the arm reaches the desired state by stepping the sim

                forwards in a blocking manner. Defaults to False

        &quot;&quot;&quot;

        self.set_arm_joints([Astrobee.JOINT_POS_LIMITS[1, 1], 0], force, wait)

        self.set_gripper_position(0, force, wait)
</code></pre></div>

</details>
<h4 id="unload">unload</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">unload</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Remove the Astrobee from the simulation</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">unload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the Astrobee from the simulation&quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">removeBody</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>

</details>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        
<footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../abstract_bag/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Abstract Bag" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                Abstract Bag
              </div>
            </div>
          </a>
        
        
          
          <a href="../composite_bag/" class="md-footer__link md-footer__link--next" aria-label="Next: Composite Bag" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Composite Bag
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
            
            Powered by
            <a href="http://timothycrosley.github.io/portray">portray.</a>
            You too can
            <a href="http://timothycrosley.github.io/portray">
              portray</a>
            your Python project well using automatic documentation.
          </div>
        
      </div>
    </div>
  </footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>