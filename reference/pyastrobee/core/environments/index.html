
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.4">
    
    
      
        <title>Environments - pyastrobee</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.80dcb947.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue-grey" data-md-color-accent="pink">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-pyastrobeecoreenvironments" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="pyastrobee" class="md-header__button md-logo" aria-label="pyastrobee" data-md-component="logo">
      
  <img src="../../../../images/favicon_large.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pyastrobee
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Environments
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/danielpmorton/pyastrobee" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    pyastrobee
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="pyastrobee" class="md-nav__button md-logo" aria-label="pyastrobee" data-md-component="logo">
      
  <img src="../../../../images/favicon_large.png" alt="logo">

    </a>
    pyastrobee
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/danielpmorton/pyastrobee" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    pyastrobee
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/additional_installs/" class="md-nav__link">
        Additional Installs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/bag_dynamics/" class="md-nav__link">
        Bag Dynamics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/getting_started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/loading_iss_meshes/" class="md-nav__link">
        Loading Iss Meshes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/meshing/" class="md-nav__link">
        Meshing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/nasa_sim/" class="md-nav__link">
        Nasa Sim
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/pybullet_tips/" class="md-nav__link">
        Pybullet Tips
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/retexturing/" class="md-nav__link">
        Retexturing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/tet_meshing/" class="md-nav__link">
        Tet Meshing
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13" type="checkbox" id="__nav_13" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_13">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1" type="checkbox" id="__nav_13_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1">
          Pyastrobee
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pyastrobee" data-md-level="2">
        <label class="md-nav__title" for="__nav_13_1">
          <span class="md-nav__icon md-icon"></span>
          Pyastrobee
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1_2" type="checkbox" id="__nav_13_1_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1_2">
          Config
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Config" data-md-level="3">
        <label class="md-nav__title" for="__nav_13_1_2">
          <span class="md-nav__icon md-icon"></span>
          Config
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/astrobee_geom/" class="md-nav__link">
        Astrobee Geom
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/astrobee_motion/" class="md-nav__link">
        Astrobee Motion
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/astrobee_transforms/" class="md-nav__link">
        Astrobee Transforms
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/bag_properties/" class="md-nav__link">
        Bag Properties
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/iss_paths/" class="md-nav__link">
        Iss Paths
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/iss_safe_boxes/" class="md-nav__link">
        Iss Safe Boxes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1_3" type="checkbox" id="__nav_13_1_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1_3">
          Control
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Control" data-md-level="3">
        <label class="md-nav__title" for="__nav_13_1_3">
          <span class="md-nav__icon md-icon"></span>
          Control
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/constraint_controller/" class="md-nav__link">
        Constraint Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/force_torque_control/" class="md-nav__link">
        Force Torque Control
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/keyboard_controller/" class="md-nav__link">
        Keyboard Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/metrics/" class="md-nav__link">
        Metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/multi_robot/" class="md-nav__link">
        Multi Robot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/sampling_mpc/" class="md-nav__link">
        Sampling Mpc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../control/sampling_mpc_multithreaded/" class="md-nav__link">
        Sampling Mpc Multithreaded
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1_4" type="checkbox" id="__nav_13_1_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1_4">
          Core
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Core" data-md-level="3">
        <label class="md-nav__title" for="__nav_13_1_4">
          <span class="md-nav__icon md-icon"></span>
          Core
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../abstract_bag/" class="md-nav__link">
        Abstract Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../astrobee/" class="md-nav__link">
        Astrobee
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../composite_bag/" class="md-nav__link">
        Composite Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../constraint_bag/" class="md-nav__link">
        Constraint Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deformable_bag/" class="md-nav__link">
        Deformable Bag
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Environments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Environments
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_vec_env" class="md-nav__link">
    make_vec_env
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#astrobeeenv" class="md-nav__link">
    AstrobeeEnv
  </a>
  
    <nav class="md-nav" aria-label="AstrobeeEnv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ancestors-in-mro" class="md-nav__link">
    Ancestors (in MRO)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#descendants" class="md-nav__link">
    Descendants
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-variables" class="md-nav__link">
    Class variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instance-variables" class="md-nav__link">
    Instance variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#close" class="md-nav__link">
    close
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_wrapper_attr" class="md-nav__link">
    get_wrapper_attr
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#render" class="md-nav__link">
    render
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset" class="md-nav__link">
    reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restore_state" class="md-nav__link">
    restore_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#save_state" class="md-nav__link">
    save_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send_client_command" class="md-nav__link">
    send_client_command
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step" class="md-nav__link">
    step
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step_simulation" class="md-nav__link">
    step_simulation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#astrobeempcenv" class="md-nav__link">
    AstrobeeMPCEnv
  </a>
  
    <nav class="md-nav" aria-label="AstrobeeMPCEnv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes_1" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ancestors-in-mro_1" class="md-nav__link">
    Ancestors (in MRO)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-variables_1" class="md-nav__link">
    Class variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instance-variables_1" class="md-nav__link">
    Instance variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods_1" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#close_1" class="md-nav__link">
    close
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_bag_state" class="md-nav__link">
    get_bag_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_robot_state" class="md-nav__link">
    get_robot_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_wrapper_attr_1" class="md-nav__link">
    get_wrapper_attr
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#render_1" class="md-nav__link">
    render
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_1" class="md-nav__link">
    reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_bag_state" class="md-nav__link">
    reset_bag_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_robot_state" class="md-nav__link">
    reset_robot_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restore_state_1" class="md-nav__link">
    restore_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sample_trajectory" class="md-nav__link">
    sample_trajectory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#save_state_1" class="md-nav__link">
    save_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send_client_command_1" class="md-nav__link">
    send_client_command
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_arm_traj" class="md-nav__link">
    set_arm_traj
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_flight_state" class="md-nav__link">
    set_flight_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_planning_duration" class="md-nav__link">
    set_planning_duration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_target_state" class="md-nav__link">
    set_target_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show_traj_plan" class="md-nav__link">
    show_traj_plan
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step_1" class="md-nav__link">
    step
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step_simulation_1" class="md-nav__link">
    step_simulation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unshow_traj_plan" class="md-nav__link">
    unshow_traj_plan
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hybrid_bag/" class="md-nav__link">
        Hybrid Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../iss/" class="md-nav__link">
        Iss
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rigid_bag/" class="md-nav__link">
        Rigid Bag
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1_5" type="checkbox" id="__nav_13_1_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1_5">
          Trajectories
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Trajectories" data-md-level="3">
        <label class="md-nav__title" for="__nav_13_1_5">
          <span class="md-nav__icon md-icon"></span>
          Trajectories
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/arm_planner/" class="md-nav__link">
        Arm Planner
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/bezier/" class="md-nav__link">
        Bezier
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/bezier_slerp/" class="md-nav__link">
        Bezier Slerp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/box_paths/" class="md-nav__link">
        Box Paths
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/curve_utils/" class="md-nav__link">
        Curve Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/decasteljau_slerp/" class="md-nav__link">
        Decasteljau Slerp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/face_forward/" class="md-nav__link">
        Face Forward
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/multi_robot_trajs/" class="md-nav__link">
        Multi Robot Trajs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/planner/" class="md-nav__link">
        Planner
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/polynomials/" class="md-nav__link">
        Polynomials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/quaternion_interpolation/" class="md-nav__link">
        Quaternion Interpolation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/sampling/" class="md-nav__link">
        Sampling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/simple_trajectories/" class="md-nav__link">
        Simple Trajectories
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/splines/" class="md-nav__link">
        Splines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/timing/" class="md-nav__link">
        Timing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/trajectory/" class="md-nav__link">
        Trajectory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/variable_time_curves/" class="md-nav__link">
        Variable Time Curves
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_1_6" type="checkbox" id="__nav_13_1_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13_1_6">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="3">
        <label class="md-nav__title" for="__nav_13_1_6">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/algos/" class="md-nav__link">
        Algos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/bag_frame/" class="md-nav__link">
        Bag Frame
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/boxes/" class="md-nav__link">
        Boxes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/bullet_utils/" class="md-nav__link">
        Bullet Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/debug_visualizer/" class="md-nav__link">
        Debug Visualizer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/dynamics/" class="md-nav__link">
        Dynamics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/math_utils/" class="md-nav__link">
        Math Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/mesh_utils/" class="md-nav__link">
        Mesh Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/poses/" class="md-nav__link">
        Poses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/python_utils/" class="md-nav__link">
        Python Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/quaternion_derivatives/" class="md-nav__link">
        Quaternion Derivatives
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/quaternions/" class="md-nav__link">
        Quaternions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/rotations/" class="md-nav__link">
        Rotations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/transformations/" class="md-nav__link">
        Transformations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/video_concatenation/" class="md-nav__link">
        Video Concatenation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_vec_env" class="md-nav__link">
    make_vec_env
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#astrobeeenv" class="md-nav__link">
    AstrobeeEnv
  </a>
  
    <nav class="md-nav" aria-label="AstrobeeEnv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ancestors-in-mro" class="md-nav__link">
    Ancestors (in MRO)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#descendants" class="md-nav__link">
    Descendants
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-variables" class="md-nav__link">
    Class variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instance-variables" class="md-nav__link">
    Instance variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#close" class="md-nav__link">
    close
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_wrapper_attr" class="md-nav__link">
    get_wrapper_attr
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#render" class="md-nav__link">
    render
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset" class="md-nav__link">
    reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restore_state" class="md-nav__link">
    restore_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#save_state" class="md-nav__link">
    save_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send_client_command" class="md-nav__link">
    send_client_command
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step" class="md-nav__link">
    step
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step_simulation" class="md-nav__link">
    step_simulation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#astrobeempcenv" class="md-nav__link">
    AstrobeeMPCEnv
  </a>
  
    <nav class="md-nav" aria-label="AstrobeeMPCEnv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes_1" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ancestors-in-mro_1" class="md-nav__link">
    Ancestors (in MRO)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-variables_1" class="md-nav__link">
    Class variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instance-variables_1" class="md-nav__link">
    Instance variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods_1" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#close_1" class="md-nav__link">
    close
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_bag_state" class="md-nav__link">
    get_bag_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_robot_state" class="md-nav__link">
    get_robot_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_wrapper_attr_1" class="md-nav__link">
    get_wrapper_attr
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#render_1" class="md-nav__link">
    render
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_1" class="md-nav__link">
    reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_bag_state" class="md-nav__link">
    reset_bag_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_robot_state" class="md-nav__link">
    reset_robot_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restore_state_1" class="md-nav__link">
    restore_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sample_trajectory" class="md-nav__link">
    sample_trajectory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#save_state_1" class="md-nav__link">
    save_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send_client_command_1" class="md-nav__link">
    send_client_command
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_arm_traj" class="md-nav__link">
    set_arm_traj
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_flight_state" class="md-nav__link">
    set_flight_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_planning_duration" class="md-nav__link">
    set_planning_duration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_target_state" class="md-nav__link">
    set_target_state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show_traj_plan" class="md-nav__link">
    show_traj_plan
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step_1" class="md-nav__link">
    step
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step_simulation_1" class="md-nav__link">
    step_simulation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unshow_traj_plan" class="md-nav__link">
    unshow_traj_plan
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/danielpmorton/pyastrobee/edit/main/reference/pyastrobee/core/environments.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="module-pyastrobeecoreenvironments">Module pyastrobee.core.environments</h1>
<p>Gym and vectorized environments for the Astrobee/ISS/Cargo setup</p>
<p>NOTE:
- Class variables DO NOT get updated in vectorized environments (for instance, modifying the value in a
  non-vectorized environment will be reflected in all non-vectorized environments, but not the vectorized ones.
  You'd have to explicitly call the set_attr method for that)</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Gym and vectorized environments for the Astrobee/ISS/Cargo setup</span>

<span class="sd">NOTE:</span>

<span class="sd">- Class variables DO NOT get updated in vectorized environments (for instance, modifying the value in a</span>

<span class="sd">  non-vectorized environment will be reflected in all non-vectorized environments, but not the vectorized ones.</span>

<span class="sd">  You&#39;d have to explicitly call the set_attr method for that)</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># TODO</span>

<span class="c1"># - See if there is a faster way to save/restore state in the case that we&#39;re using the rigid bag</span>

<span class="c1"># - Add ability to save/restore state from a state ID (saved in memory) -- ONLY if this is useful</span>

<span class="c1"># - Use terminated/truncated as a stopping parameter</span>

<span class="c1"># - Should the reset() function reset the simulation back to an initial saved state?</span>

<span class="c1"># - Decide if the base AstrobeeEnv should have cleanup functionality</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Optional</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">,</span><span class="w"> </span><span class="n">Callable</span><span class="p">,</span><span class="w"> </span><span class="n">Dict</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">,</span><span class="w"> </span><span class="n">Union</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Enum</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">npt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">gymnasium</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gym</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">gymnasium.core</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">ObsType</span><span class="p">,</span><span class="w"> </span><span class="n">ActType</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">stable_baselines3.common.monitor</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Monitor</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">stable_baselines3.common.env_util</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">DummyVecEnv</span><span class="p">,</span><span class="w"> </span><span class="n">SubprocVecEnv</span><span class="p">,</span><span class="w"> </span><span class="n">VecEnv</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">stable_baselines3.common.vec_env.patch_gym</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">_patch_env</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.control.force_torque_control</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">ForceTorqueController</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.utils.bullet_utils</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">initialize_pybullet</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.core.astrobee</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Astrobee</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.core.iss</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">ISS</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.core.abstract_bag</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">CargoBag</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.core.deformable_bag</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">DeformableCargoBag</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.core.constraint_bag</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">ConstraintCargoBag</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.control.metrics</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">safe_set_cost</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.trajectories.sampling</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">generate_trajs</span><span class="p">,</span><span class="w"> </span><span class="n">sample_state</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.utils.debug_visualizer</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">remove_debug_objects</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.utils.boxes</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">check_box_containment</span><span class="p">,</span><span class="w"> </span><span class="n">visualize_3D_box</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.config.iss_safe_boxes</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">FULL_SAFE_SET</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.utils.quaternions</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">quaternion_dist</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.control.metrics</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">robot_and_bag_termination_criteria</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.config.astrobee_motion</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">MAX_FORCE_MAGNITUDE</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_TORQUE_MAGNITUDE</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.trajectories.trajectory</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Trajectory</span><span class="p">,</span><span class="w"> </span><span class="n">ArmTrajectory</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.utils.transformations</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">invert_transform_mat</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.trajectories.planner</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">local_planner</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyastrobee.trajectories.trajectory</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">concatenate_trajs</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AstrobeeEnv</span><span class="p">(</span><span class="n">gym</span><span class="o">.</span><span class="n">Env</span><span class="p">):</span>

<span class="w">    </span><span class="s2">&quot;&quot;&quot;Base Astrobee environment containing the Astrobee, ISS, and a cargo bag</span>

<span class="s2">    Args:</span>

<span class="s2">        use_gui (bool): Whether or not to use the GUI as opposed to headless.</span>

<span class="s2">        robot_pose (npt.ArrayLike, optional): Starting position + XYZW quaternion pose of the Astrobee, shape (7,)</span>

<span class="s2">        bag_name (str, optional): Type of cargo bag to load. Defaults to &quot;top_handle&quot;.</span>

<span class="s2">        bag_mass (float): Mass of the cargo bag, in kg. Defaults to 10</span>

<span class="s2">        bag_type (type[CargoBag]): Class of cargo bag to use in the environment. Defaults to DeformableCargoBag</span>

<span class="s2">        load_full_iss (bool, optional): Whether to load the ISS (expensive, not necessarily required for rollouts) or</span>

<span class="s2">            just work with the safe set information. Defaults to True (load the ISS)</span>

<span class="s2">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="n">SAVE_STATE_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;artifacts/saved_states/&quot;</span>

<span class="w">    </span><span class="n">SAVE_STATE_PATHS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span>

<span class="w">        </span><span class="n">use_gui</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="p">,</span>

<span class="w">        </span><span class="n">robot_pose</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>

<span class="w">        </span><span class="n">bag_name</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;top_handle_symmetric&quot;</span><span class="p">,</span>

<span class="w">        </span><span class="n">bag_mass</span><span class="p">:</span><span class="w"> </span><span class="nb">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>

<span class="w">        </span><span class="n">bag_type</span><span class="p">:</span><span class="w"> </span><span class="nb">type</span><span class="p">[</span><span class="n">CargoBag</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeformableCargoBag</span><span class="p">,</span>

<span class="w">        </span><span class="n">load_full_iss</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span><span class="p">,</span>

<span class="w">    </span><span class="p">):</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initialize_pybullet</span><span class="p">(</span><span class="n">use_gui</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FULL_SAFE_SET</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">load_full_iss</span><span class="p">:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">iss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ISS</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

<span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="n">use_gui</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>

<span class="w">                </span><span class="n">visualize_3D_box</span><span class="p">(</span><span class="n">box</span><span class="p">,</span><span class="w"> </span><span class="n">rgba</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">))</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">(</span><span class="n">robot_pose</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bag_type</span><span class="p">(</span><span class="n">bag_name</span><span class="p">,</span><span class="w"> </span><span class="n">bag_mass</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">reset_to_handle_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">ee_pose</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">attach_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="p">,</span><span class="w"> </span><span class="n">object_to_move</span><span class="o">=</span><span class="s2">&quot;bag&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getPhysicsEngineParameters</span><span class="p">()[</span><span class="s2">&quot;fixedTimeStep&quot;</span><span class="p">]</span>

<span class="w">        </span><span class="c1"># Dummy parameters for gym/stable baselines compatibility</span>

<span class="w">        </span><span class="c1"># TODO make custom gym.spaces.space.Space subclasses for these?</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gym</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">Discrete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="c1"># temporary, unused</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gym</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">Discrete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="c1"># temporary, unused</span>

<span class="w">        </span><span class="c1"># Step the simulation once to get the bag in the right place</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">stepSimulation</span><span class="p">()</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">ObsType</span><span class="p">,</span><span class="w"> </span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]:</span>

<span class="w">        </span><span class="c1"># Implementation of Gym template method reset(): See Gym for full method docstring</span>

<span class="w">        </span><span class="c1"># Gym states this must be the first line of the reset() method</span>

<span class="w">        </span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_get_obs</span><span class="p">(),</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()</span><span class="w">  </span><span class="c1"># Initial state observation</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_get_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ObsType</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Translates the environment&#39;s state into an observation</span>

<span class="s2">        Returns:</span>

<span class="s2">            ObsType: Observation</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># This function setup was recommended in the gym documentation</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="w">  </span><span class="c1"># Dummy value for now</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Provide auxiliary information associated with an observation</span>

<span class="s2">        Returns:</span>

<span class="s2">            dict[str, Any]: Additional observation information</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># This function setup was recommended in the gym documentation</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{}</span><span class="w">  </span><span class="c1"># Dummy value for now</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="p">:</span><span class="w"> </span><span class="n">ActType</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">ObsType</span><span class="p">,</span><span class="w"> </span><span class="nb">float</span><span class="p">,</span><span class="w"> </span><span class="nb">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]:</span>

<span class="w">        </span><span class="c1"># Implementation of Gym template method step(): See Gym for full method docstring</span>

<span class="w">        </span><span class="c1"># Note: The return parameters differ slightly from step() for a vectorized environment</span>

<span class="w">        </span><span class="c1"># In this base environment, we will just step the pybullet simulation and return a dummy value for reward</span>

<span class="w">        </span><span class="c1"># The MPC environment can add more specific MPC/control functionality here</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">stepSimulation</span><span class="p">()</span>

<span class="w">        </span><span class="n">reward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="n">observation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_get_obs</span><span class="p">()</span>

<span class="w">        </span><span class="n">terminated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="w">  </span><span class="c1"># If at the terminal state</span>

<span class="w">        </span><span class="n">truncated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="w">  </span><span class="c1"># If stopping the sim before the terminal state</span>

<span class="w">        </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">observation</span><span class="p">,</span><span class="w"> </span><span class="n">reward</span><span class="p">,</span><span class="w"> </span><span class="n">terminated</span><span class="p">,</span><span class="w"> </span><span class="n">truncated</span><span class="p">,</span><span class="w"> </span><span class="n">info</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">step_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Single pybullet simulation step&quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">stepSimulation</span><span class="p">()</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="c1"># Implementation of Gym template method close(): See Gym for full method docstring</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">str</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Saves the current simulation state to disk</span>

<span class="s2">        - Note: saved states are not currently overwritten (could lead to issues with parallel environments?). But,</span>

<span class="s2">          these can be cleared out at the end of the simulation period</span>

<span class="s2">        Returns:</span>

<span class="s2">            str: Path to the saved state file</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># Autogenerate a unique filename/path and save to it</span>

<span class="w">        </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;state_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S_</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">filepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AstrobeeEnv</span><span class="o">.</span><span class="n">SAVE_STATE_DIR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;.bullet&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">saveBullet</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<span class="w">        </span><span class="n">AstrobeeEnv</span><span class="o">.</span><span class="n">SAVE_STATE_PATHS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">filepath</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">restore_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Restores the simulation to a saved state file</span>

<span class="s2">        Args:</span>

<span class="s2">            filename (str): Path to a .bullet saved state within the saved state directory</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_check_state_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">restoreState</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_check_state_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">str</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Helper function: Validates that a saved state file exists</span>

<span class="s2">        Args:</span>

<span class="s2">            filename (str): Path to a .bullet saved state within the saved state directory</span>

<span class="s2">        Returns:</span>

<span class="s2">            str: Validated path</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;.bullet&quot;</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="sa">f</span><span class="s2">&quot;Invalid filename: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Not a .bullet saved state file&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">AstrobeeEnv</span><span class="o">.</span><span class="n">SAVE_STATE_DIR</span><span class="p">):</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="sa">f</span><span class="s2">&quot;Invalid filename: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Check that the filename points to within the saved state directory&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="w">        </span><span class="k">raise</span><span class="w"> </span><span class="n">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">send_client_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Any</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Send a command to the environment&#39;s pybullet client</span>

<span class="s2">        For instance, we can use pybullet.getBasePositionAndOrientation with this as</span>

<span class="s2">        send_client_command(&quot;getBasePositionAndOrientation&quot;, body_id)</span>

<span class="s2">        Returns:</span>

<span class="s2">            Any: The return from the Pybullet command</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">Callable</span><span class="p">):</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">attr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">attr</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AstrobeeMPCEnv</span><span class="p">(</span><span class="n">AstrobeeEnv</span><span class="p">):</span>

<span class="w">    </span><span class="s2">&quot;&quot;&quot;Astrobee environment for MPC: Contains additional controller parameters and functions associated with MPC, on</span>

<span class="s2">    top of the base Astrobee environment capability</span>

<span class="s2">    Args:</span>

<span class="s2">        use_gui (bool): Whether or not to use the GUI as opposed to headless.</span>

<span class="s2">        is_primary (bool): Whether or not this environment is the main simulation (True) or if it is one of the</span>

<span class="s2">            vectorized environments for evaluating a rollout (False)</span>

<span class="s2">        robot_pose (npt.ArrayLike, optional): Starting position + XYZW quaternion pose of the Astrobee, shape (7,)</span>

<span class="s2">        bag_name (str, optional): Type of cargo bag to load. Defaults to &quot;top_handle&quot;.</span>

<span class="s2">        bag_mass (float): Mass of the cargo bag, in kg. Defaults to 10</span>

<span class="s2">        bag_type (type[CargoBag]): Class of cargo bag to use in the environment. Defaults to DeformableCargoBag</span>

<span class="s2">        load_full_iss (bool, optional): Whether to load the ISS (expensive, not necessarily required for rollouts) or</span>

<span class="s2">            just work with the safe set information. Defaults to True (load the ISS)</span>

<span class="s2">        nominal_rollouts (bool, optional): If True, will roll-out a trajectory based on the nominal target.</span>

<span class="s2">            If False, will sample a trajectory about the nominal target. Defaults to False.</span>

<span class="s2">        cleanup (bool, optional): Whether or not to delete all saved states when the simulation ends. Defaults to True.</span>

<span class="s2">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">FlightStates</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>

<span class="w">        </span><span class="c1"># STARTING = &quot;starting&quot;</span>

<span class="w">        </span><span class="n">NOMINAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nominal&quot;</span>

<span class="w">        </span><span class="n">SLOWING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;slowing&quot;</span>

<span class="w">        </span><span class="n">STOPPING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;stopping&quot;</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span>

<span class="w">        </span><span class="n">use_gui</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="p">,</span>

<span class="w">        </span><span class="n">is_primary</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="p">,</span>

<span class="w">        </span><span class="n">robot_pose</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>

<span class="w">        </span><span class="n">bag_name</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;top_handle&quot;</span><span class="p">,</span>

<span class="w">        </span><span class="n">bag_mass</span><span class="p">:</span><span class="w"> </span><span class="nb">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>

<span class="w">        </span><span class="n">bag_type</span><span class="p">:</span><span class="w"> </span><span class="nb">type</span><span class="p">[</span><span class="n">CargoBag</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeformableCargoBag</span><span class="p">,</span>

<span class="w">        </span><span class="n">load_full_iss</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span><span class="p">,</span>

<span class="w">        </span><span class="n">nominal_rollouts</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="p">,</span>

<span class="w">        </span><span class="n">cleanup</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span><span class="p">,</span>

<span class="w">    </span><span class="p">):</span>

<span class="w">        </span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>

<span class="w">            </span><span class="n">use_gui</span><span class="p">,</span><span class="w"> </span><span class="n">robot_pose</span><span class="p">,</span><span class="w"> </span><span class="n">bag_name</span><span class="p">,</span><span class="w"> </span><span class="n">bag_mass</span><span class="p">,</span><span class="w"> </span><span class="n">bag_type</span><span class="p">,</span><span class="w"> </span><span class="n">load_full_iss</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="c1"># TODO figure out how to handle controller parameters</span>

<span class="w">        </span><span class="c1"># Just fixing the gains here for now</span>

<span class="w">        </span><span class="c1"># TODO should these be functions of the bag mass???</span>

<span class="w">        </span><span class="n">kp</span><span class="p">,</span><span class="w"> </span><span class="n">kv</span><span class="p">,</span><span class="w"> </span><span class="n">kq</span><span class="p">,</span><span class="w"> </span><span class="n">kw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="w">  </span><span class="c1"># TODO make parameters</span>

<span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">position</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">position</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ForceTorqueController</span><span class="p">(</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">mass</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bag_mass</span><span class="p">,</span>

<span class="w">            </span><span class="c1"># self.robot.inertia,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">inertia</span>

<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">bag_mass</span>

<span class="w">            </span><span class="o">*</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>

<span class="w">            </span><span class="p">),</span><span class="w">  </span><span class="c1"># TODO parallel axis theorem for bag?? test this</span>

<span class="w">            </span><span class="n">kp</span><span class="p">,</span>

<span class="w">            </span><span class="n">kv</span><span class="p">,</span>

<span class="w">            </span><span class="n">kq</span><span class="p">,</span>

<span class="w">            </span><span class="n">kw</span><span class="p">,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>

<span class="w">            </span><span class="n">max_force</span><span class="o">=</span><span class="n">MAX_FORCE_MAGNITUDE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">  </span><span class="c1"># TODO REMOVE THIS SCALING FACTOR</span>

<span class="w">            </span><span class="n">max_torque</span><span class="o">=</span><span class="n">MAX_TORQUE_MAGNITUDE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>

<span class="w">            </span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Sampling parameters (TODO these need refinement)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">pos_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">orn_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">vel_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">accel_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="c1"># Store last acceleration commands</span>

<span class="w">        </span><span class="c1"># Update through set_attr</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">last_accel_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">last_alpha_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">        </span><span class="c1"># Frequency at which we query our &quot;stay away from the walls&quot; cost function</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set_eval_freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w">  </span><span class="c1"># Hz</span>

<span class="w">        </span><span class="c1"># Keep track of any temporary debug visualizer IDs</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">debug_viz_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span>

<span class="w">        </span><span class="c1"># Keep track of whether we&#39;re stopping or in a nominal flight mode</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">NOMINAL</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">        </span><span class="c1"># (effectively the rollout duration, should be a constant) - TODO IMPROVE THIS</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">planning_duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span>

<span class="w">        </span><span class="c1"># Store where we want the Astrobee to be at the end of the MPC run to determine if we are done</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">goal_pose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">        </span><span class="c1"># HACK - improve how this is handled</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_is_primary_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is_primary</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_is_debugging_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">is_primary</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">use_gui</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_nominal_rollouts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nominal_rollouts</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cleanup</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">is_primary_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">bool</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Whether this environment is running the primary planning/control simulation</span>

<span class="s2">        or is a separate (likely vectorized) environment for evaluating rollouts&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_is_primary_env</span>

<span class="w">    </span><span class="nd">@property</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">is_debugging_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">bool</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Whether this is an environment launched in debug mode&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_is_debugging_env</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">set_arm_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">traj</span><span class="p">:</span><span class="w"> </span><span class="n">ArmTrajectory</span><span class="p">):</span><span class="w">  </span><span class="c1"># TODO IMPROVE THIS</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">traj</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">set_planning_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">):</span><span class="w">  </span><span class="c1"># TODO improve this</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">planning_duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">set_flight_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">FlightStates</span><span class="p">]):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Set the current flight state: for instance, whether we are in nominal operating mode, stopping, ...</span>

<span class="s2">        Args:</span>

<span class="s2">            state (Union[str, FlightStates]): A flight state or its string representation</span>

<span class="s2">                (i.e. &quot;nominal&quot;, &quot;stopping&quot;, ...)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># TODO add check that it is valid</span>

<span class="w">        </span><span class="c1"># TODO should we store the state as the string or the Enum????</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">):</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="p">):</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;Flight state not recognized&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">set_target_state</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span>

<span class="w">        </span><span class="n">pos</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">orn</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">vel</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">omega</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">accel</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">alpha</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">duration</span><span class="p">:</span><span class="w"> </span><span class="nb">float</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Set the target dynamics state for planning/sampling trajectories and determining penalties</span>

<span class="s2">        Args:</span>

<span class="s2">            pos (npt.ArrayLike): Desired position, shape (3,)</span>

<span class="s2">            orn (npt.ArrayLike): Desired XYZW quaternion orientation, shape (4,)</span>

<span class="s2">            vel (npt.ArrayLike): Desired linear velocity, shape (3,)</span>

<span class="s2">            omega (npt.ArrayLike): Desired angular velocity, shape (3,)</span>

<span class="s2">            accel (npt.ArrayLike): Desired linear acceleration, shape (3,)</span>

<span class="s2">            alpha (npt.ArrayLike): Desired angular acceleration, shape (3,)</span>

<span class="s2">            duration (float): Amount of time to pass before achieving this desired state</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orn</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vel</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omega</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_accel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accel</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">sample_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Samples a trajectory about the nominal target.</span>

<span class="s2">        - If the nominal_rollouts parameter is True for this environment, the final state of the trajectory will be</span>

<span class="s2">          exactly the nominal value (no noise added when sampling)</span>

<span class="s2">        - This should just be called in the vectorized rollout environments (not the main environment) since the main</span>

<span class="s2">          environment will use the best trajectory from the rollout envs</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="s2">&quot;Trajectory sampling should only occur in one of parallel environments for evaluation purposes&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="p">,</span><span class="w"> </span><span class="n">vel</span><span class="p">,</span><span class="w"> </span><span class="n">omega</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">dynamics_state</span>

<span class="w">        </span><span class="c1"># Time sampling parameters (TODO refine these, move them somewhere else)</span>

<span class="w">        </span><span class="n">time_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="c1"># Note: ensure that this is a positive value post-sampling</span>

<span class="w">        </span><span class="n">min_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="n">n_timesteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planning_duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span><span class="w">  </span><span class="c1"># Nominal</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">:</span>

<span class="w">            </span><span class="n">end_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="p">[</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_accel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_alpha</span><span class="p">,</span>

<span class="w">                </span><span class="p">]</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_nominal_rollouts</span>

<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="n">sample_state</span><span class="p">(</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">last_accel_cmd</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">last_alpha_cmd</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">pos_stdev</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">orn_stdev</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">vel_stdev</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_stdev</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">accel_stdev</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_stdev</span><span class="p">,</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">target_duration</span>

<span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">SLOWING</span><span class="p">:</span>

<span class="w">            </span><span class="n">end_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="p">[</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_accel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_alpha</span><span class="p">,</span>

<span class="w">                </span><span class="p">]</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_nominal_rollouts</span>

<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="n">sample_state</span><span class="p">(</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">last_accel_cmd</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">last_alpha_cmd</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">pos_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">orn_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">vel_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">accel_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_duration</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_nominal_rollouts</span>

<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_duration</span><span class="p">,</span><span class="w"> </span><span class="n">time_stdev</span><span class="p">),</span><span class="w"> </span><span class="n">min_time</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">STOPPING</span><span class="p">:</span>

<span class="w">            </span><span class="n">end_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">,</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">,</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">,</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">,</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_accel</span><span class="p">,</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_alpha</span><span class="p">,</span>

<span class="w">            </span><span class="p">]</span>

<span class="w">            </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">planning_duration</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_nominal_rollouts</span>

<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planning_duration</span><span class="p">,</span><span class="w"> </span><span class="n">time_stdev</span><span class="p">),</span><span class="w"> </span><span class="n">min_time</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">AttributeError</span><span class="p">(</span><span class="s2">&quot;Flight state not recognized&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">traj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_planner</span><span class="p">(</span>

<span class="w">            </span><span class="n">pos</span><span class="p">,</span>

<span class="w">            </span><span class="n">orn</span><span class="p">,</span>

<span class="w">            </span><span class="n">vel</span><span class="p">,</span>

<span class="w">            </span><span class="n">omega</span><span class="p">,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">last_accel_cmd</span><span class="p">,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">last_alpha_cmd</span><span class="p">,</span>

<span class="w">            </span><span class="o">*</span><span class="n">end_state</span><span class="p">,</span>

<span class="w">            </span><span class="n">duration</span><span class="p">,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">traj</span><span class="o">.</span><span class="n">num_timesteps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_timesteps</span><span class="p">:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">traj</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># Traj is either too long or too short, so adjust it</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">traj</span><span class="o">.</span><span class="n">num_timesteps</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">n_timesteps</span><span class="p">:</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">traj</span><span class="o">.</span><span class="n">get_segment</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">n_timesteps</span><span class="p">)</span>

<span class="w">            </span><span class="k">else</span><span class="p">:</span><span class="w">  </span><span class="c1"># Less than</span>

<span class="w">                </span><span class="c1"># Create a trajectory at the stopped position for the remaining timesteps</span>

<span class="w">                </span><span class="n">remaining_timesteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_timesteps</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">traj</span><span class="o">.</span><span class="n">num_timesteps</span>

<span class="w">                </span><span class="n">stop_traj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Trajectory</span><span class="p">(</span>

<span class="w">                    </span><span class="n">traj</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">traj</span><span class="o">.</span><span class="n">quaternions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">remaining_timesteps</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">concatenate_trajs</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span><span class="w"> </span><span class="n">stop_traj</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">sampled_end_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">quaternions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">linear_velocities</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">angular_velocities</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_get_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ObsType</span><span class="p">:</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span><span class="p">:</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">full_state</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">dynamics_state</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="p">:</span><span class="w"> </span><span class="n">ActType</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">ObsType</span><span class="p">,</span><span class="w"> </span><span class="nb">float</span><span class="p">,</span><span class="w"> </span><span class="nb">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]:</span>

<span class="w">        </span><span class="c1"># Note: For MPC, this is less so a &quot;step&quot; than a &quot;rollout&quot; function. The trajectory should be sampled</span>

<span class="w">        </span><span class="c1">#       before calling this function</span>

<span class="w">        </span><span class="c1"># TODO use the action parameter to pass in a trajectory to follow?</span>

<span class="w">        </span><span class="n">terminated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="w">  </span><span class="c1"># init (If at the terminal state)</span>

<span class="w">        </span><span class="n">truncated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span><span class="w">  </span><span class="c1"># init (If stopping the sim before the terminal state)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;Trajectory has not been planned&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Follow the trajectory. NOTE: This is effectively the same as the follow_traj() function in the controller,</span>

<span class="w">        </span><span class="c1"># but accessing the loop directly allows us to do more with the data at each step</span>

<span class="w">        </span><span class="c1"># TODO decide how to handle the stopping criteria</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">num_timesteps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;Mismatched time info between base and arm trajs&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># If this is the primary simulation, we just follow the best trajectory we have</span>

<span class="w">        </span><span class="c1"># Rewrd for the primary simulation doesn&#39;t mean anything, so no computation needed</span>

<span class="w">        </span><span class="n">inertia_update_freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>

<span class="w">        </span><span class="n">steps_per_inertia_update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">round</span><span class="p">(</span>

<span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">timestep</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inertia_update_freq</span><span class="p">)</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">):</span>

<span class="w">                </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="p">,</span><span class="w"> </span><span class="n">lin_vel</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_current_state</span><span class="p">()</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>

<span class="w">                    </span><span class="n">pos</span><span class="p">,</span>

<span class="w">                    </span><span class="n">lin_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="n">orn</span><span class="p">,</span>

<span class="w">                    </span><span class="n">ang_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">linear_velocities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">linear_accels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">quaternions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">angular_velocities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">angular_accels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_joint_angles</span><span class="p">(</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="o">.</span><span class="n">joint_ids</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="c1"># TODO THIS KINDA SUCKS</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">steps_per_inertia_update</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">                    </span><span class="n">T_R2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">tmat</span>

<span class="w">                    </span><span class="n">T_B2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">tmat</span>

<span class="w">                    </span><span class="n">T_B2R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invert_transform_mat</span><span class="p">(</span><span class="n">T_R2W</span><span class="p">)</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">T_B2W</span>

<span class="w">                    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T_B2R</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">inertia</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">mass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span>

<span class="w">                        </span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">            </span><span class="n">reward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># We are in a rollout environment</span>

<span class="w">            </span><span class="c1"># So, follow the trajectory, but also keep track of a bunch of things so that we can compute the reward</span>

<span class="w">            </span><span class="n">robot_safe_set_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">            </span><span class="n">bag_safe_set_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">            </span><span class="n">stabilization_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="n">tracking_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="n">bag_vel_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="n">steps_per_safe_set_eval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">round</span><span class="p">(</span>

<span class="w">                </span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">timestep</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set_eval_freq</span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="c1"># TODO IMPROVE THIS</span>

<span class="w">            </span><span class="c1"># the thought here was that if we&#39;re stopping (or slowing) we care more about the overall positioning</span>

<span class="w">            </span><span class="c1"># rather than just staying in the middle of the modules</span>

<span class="w">            </span><span class="n">safe_set_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="mi">1</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">NOMINAL</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">):</span>

<span class="w">                </span><span class="c1"># Note: the traj log gets updated whenever we access the current state</span>

<span class="w">                </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="p">,</span><span class="w"> </span><span class="n">lin_vel</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_current_state</span><span class="p">()</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>

<span class="w">                    </span><span class="n">pos</span><span class="p">,</span>

<span class="w">                    </span><span class="n">lin_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="n">orn</span><span class="p">,</span>

<span class="w">                    </span><span class="n">ang_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">linear_velocities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">linear_accels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">quaternions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">angular_velocities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">angular_accels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_joint_angles</span><span class="p">(</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="o">.</span><span class="n">joint_ids</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="c1"># TODO THIS KINDA SUCKS</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">steps_per_inertia_update</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">                    </span><span class="n">T_R2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">tmat</span>

<span class="w">                    </span><span class="n">T_B2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">tmat</span>

<span class="w">                    </span><span class="n">T_B2R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invert_transform_mat</span><span class="p">(</span><span class="n">T_R2W</span><span class="p">)</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">T_B2W</span>

<span class="w">                    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T_B2R</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">inertia</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">mass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span>

<span class="w">                        </span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">                </span><span class="c1"># *** COST FUNCTION ***</span>

<span class="w">                </span><span class="c1"># Perform collision checking on every timestep</span>

<span class="w">                </span><span class="n">robot_bb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">bounding_box</span>

<span class="w">                </span><span class="n">bag_bb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">bounding_box</span>

<span class="w">                </span><span class="n">robot_is_safe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_box_containment</span><span class="p">(</span><span class="n">robot_bb</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="w">                </span><span class="n">bag_is_safe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_box_containment</span><span class="p">(</span><span class="n">bag_bb</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="w">                </span><span class="c1"># If either the robot or bag collided, stop the simulation and return an effectively infinite cost</span>

<span class="w">                </span><span class="c1"># (Very large but not infinity to maintain sorting order in the edge case that all rollouts collide)</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">robot_is_safe</span><span class="p">:</span>

<span class="w">                    </span><span class="n">robot_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">10000</span>

<span class="w">                    </span><span class="n">truncated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span>

<span class="w">                    </span><span class="c1"># break</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">bag_is_safe</span><span class="p">:</span>

<span class="w">                    </span><span class="n">bag_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">10000</span>

<span class="w">                    </span><span class="n">truncated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span>

<span class="w">                    </span><span class="c1"># break</span>

<span class="w">                </span><span class="c1"># These &quot;stay away from the walls&quot; costs are somewhat expensive to compute and don&#39;t necessarily need</span>

<span class="w">                </span><span class="c1"># to be done every timestep. TODO just use the local description of the safe set, not the full thing</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">steps_per_safe_set_eval</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">                    </span><span class="n">robot_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">safe_set_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">safe_set_cost</span><span class="p">(</span>

<span class="w">                        </span><span class="n">robot_bb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">                    </span><span class="n">robot_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">safe_set_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">safe_set_cost</span><span class="p">(</span>

<span class="w">                        </span><span class="n">robot_bb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">                    </span><span class="n">bag_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">safe_set_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">safe_set_cost</span><span class="p">(</span>

<span class="w">                        </span><span class="n">bag_bb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">                    </span><span class="n">bag_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">safe_set_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">safe_set_cost</span><span class="p">(</span>

<span class="w">                        </span><span class="n">bag_bb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">            </span><span class="n">bag_pos</span><span class="p">,</span><span class="w"> </span><span class="n">bag_orn</span><span class="p">,</span><span class="w"> </span><span class="n">bag_vel</span><span class="p">,</span><span class="w"> </span><span class="n">bag_ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">dynamics_state</span>

<span class="w">            </span><span class="c1"># Penalizing bag velocities perpendicular to the robot&#39;s velocity at end of rollout</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">:</span>

<span class="w">                </span><span class="n">bag_vel_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bag_vel</span><span class="p">)</span>

<span class="w">                    </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lin_vel</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lin_vel</span><span class="p">),</span><span class="w"> </span><span class="n">bag_vel</span><span class="p">)</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="c1"># End-of-rollout additional cost function evaluations</span>

<span class="w">            </span><span class="c1"># 1) Stabilize the motion of the bag with respect to the robot</span>

<span class="w">            </span><span class="c1"># 2) Position the robot so it&#39;s stopped at the goal pose</span>

<span class="w">            </span><span class="c1"># Both of these are only relevant when we&#39;re at the end of the nominal trajectory</span>

<span class="w">            </span><span class="c1"># TODO tune all of the scaling factors on the costs</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">STOPPING</span><span class="p">:</span>

<span class="w">                </span><span class="n">angular_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ang_vel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bag_ang_vel</span><span class="p">)</span>

<span class="w">                </span><span class="n">r_r2b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bag_pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pos</span><span class="w">  </span><span class="c1"># Vector from robot to bag</span>

<span class="w">                </span><span class="n">linear_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>

<span class="w">                    </span><span class="n">lin_vel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bag_vel</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ang_vel</span><span class="p">,</span><span class="w"> </span><span class="n">r_r2b</span><span class="p">)</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="n">stabilization_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">500</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">linear_term</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">angular_term</span><span class="p">)</span>

<span class="w">                </span><span class="c1"># TODO make this a separate function?</span>

<span class="w">                </span><span class="c1"># Adding back in a tracking cost component</span>

<span class="w">                </span><span class="c1"># If we are stopping then we know that the target state is the goal</span>

<span class="w">                </span><span class="n">pos_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">)</span>

<span class="w">                </span><span class="n">orn_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quaternion_dist</span><span class="p">(</span><span class="n">orn</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">)</span>

<span class="w">                </span><span class="n">vel_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lin_vel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">)</span>

<span class="w">                </span><span class="n">ang_vel_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ang_vel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">)</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_debugging_simulation</span><span class="p">:</span>

<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Position error: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pos_error</span><span class="p">)</span>

<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Orn error: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">orn_error</span><span class="p">)</span>

<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vel error: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vel_error</span><span class="p">)</span>

<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ang vel error: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel_error</span><span class="p">)</span>

<span class="w">                </span><span class="n">tracking_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                    </span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pos_error</span>

<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">orn_error</span>

<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vel_error</span>

<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ang_vel_error</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="k">else</span><span class="p">:</span>

<span class="w">                </span><span class="n">stabilization_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">                </span><span class="n">tracking_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_debugging_simulation</span><span class="p">:</span>

<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Robot safe set cost: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">robot_safe_set_cost</span><span class="p">)</span>

<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bag safe set cost: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bag_safe_set_cost</span><span class="p">)</span>

<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stabilization cost: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">stabilization_cost</span><span class="p">)</span>

<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracking cost: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tracking_cost</span><span class="p">)</span>

<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bag velocity cost: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bag_vel_cost</span><span class="p">)</span>

<span class="w">            </span><span class="n">reward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="n">robot_safe_set_cost</span>

<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">bag_safe_set_cost</span>

<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">stabilization_cost</span>

<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">tracking_cost</span>

<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">bag_vel_cost</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Observe the robot/bag state in the main env, dummy value if in rollout env</span>

<span class="w">        </span><span class="n">observation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_get_obs</span><span class="p">()</span>

<span class="w">        </span><span class="c1"># Evaluate if we have stabilized the robot and the bag at the end of the trajectory</span>

<span class="w">        </span><span class="c1"># (main env only since that&#39;s what we care about and we don&#39;t want to waste compute)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">STOPPING</span>

<span class="w">            </span><span class="ow">and</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span>

<span class="w">            </span><span class="ow">and</span><span class="w"> </span><span class="n">robot_and_bag_termination_criteria</span><span class="p">(</span>

<span class="w">                </span><span class="n">observation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">observation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">goal_pose</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="p">):</span>

<span class="w">            </span><span class="n">terminated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span>

<span class="w">        </span><span class="c1"># TODO: If we change the observation function to return the state of the robot and the bag,</span>

<span class="w">        </span><span class="c1"># we can determine the &quot;terminated&quot; parameter!</span>

<span class="w">        </span><span class="c1"># But note that we should only really do the observation in the main env</span>

<span class="w">        </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">observation</span><span class="p">,</span><span class="w"> </span><span class="n">reward</span><span class="p">,</span><span class="w"> </span><span class="n">terminated</span><span class="p">,</span><span class="w"> </span><span class="n">truncated</span><span class="p">,</span><span class="w"> </span><span class="n">info</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># Delete all of the previous saved states at the end of the simulation process</span>

<span class="w">            </span><span class="c1"># TODO: decide if each session should have its own directory?</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">AstrobeeMPCEnv</span><span class="o">.</span><span class="n">SAVE_STATE_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.bullet&quot;</span><span class="p">):</span>

<span class="w">                </span><span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">str</span><span class="p">:</span>

<span class="w">        </span><span class="c1"># Ensure that any simulations strictly for evaluating rollouts cannot save their state</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">PermissionError</span><span class="p">(</span><span class="s2">&quot;Only the primary simulation can save the state&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">get_robot_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">]:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Returns the full state information for the Astrobee in the environment (Base pos/orn/vels, joint angles/vels)</span>

<span class="s2">        Returns:</span>

<span class="s2">            tuple[np.ndarray, ...]:</span>

<span class="s2">                np.ndarray: Position, shape (3,)</span>

<span class="s2">                np.ndarray: Orientation (XYZW quaternion), shape (4,)</span>

<span class="s2">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="s2">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="s2">                np.ndarray: Joint positions, shape (NUM_JOINTS,)</span>

<span class="s2">                np.ndarray: Joint velocities, shape (NUM_JOINTS,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">full_state</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">get_bag_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">]:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Returns the dynamics state information for the bag in the environment (pos/orn/vels)</span>

<span class="s2">        Returns:</span>

<span class="s2">            tuple[np.ndarray, ...]:</span>

<span class="s2">                np.ndarray: Position, shape (3,)</span>

<span class="s2">                np.ndarray: XYZW quaternion orientation, shape (4,)</span>

<span class="s2">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="s2">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">dynamics_state</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset_robot_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Fully resets the state of the Astrobee in the environment</span>

<span class="s2">        Args:</span>

<span class="s2">            state (tuple[np.ndarray, ...]): Full Astrobee state information containing:</span>

<span class="s2">                np.ndarray: Position, shape (3,)</span>

<span class="s2">                np.ndarray: Orientation (XYZW quaternion), shape (4,)</span>

<span class="s2">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="s2">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="s2">                np.ndarray: Joint positions, shape (NUM_JOINTS,)</span>

<span class="s2">                np.ndarray: Joint velocities, shape (NUM_JOINTS,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">reset_full_state</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset_bag_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Resets the dynamics of the bag in the environment</span>

<span class="s2">        Args:</span>

<span class="s2">            state (tuple[np.ndarray, ...]): Dynamics info of the bag, containing:</span>

<span class="s2">                np.ndarray: Position, shape (3,)</span>

<span class="s2">                np.ndarray: Orientation (XYZW quaternion), shape (4,)</span>

<span class="s2">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="s2">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">reset_dynamics</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">show_traj_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Displays the planned trajectory on the current pybullet client GUI (if enabled)</span>

<span class="s2">        Args:</span>

<span class="s2">            n (Optional[int]): Number of frames to plot, if plotting all of the frames is not desired.</span>

<span class="s2">                Defaults to None (plot all frames)</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;No trajectory available to visualize&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">debug_viz_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">unshow_traj_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;Removes a displayed trajectory from the pybullet client GUI&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_viz_ids</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">            </span><span class="k">return</span>

<span class="w">        </span><span class="n">remove_debug_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_viz_ids</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">debug_viz_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_vec_env</span><span class="p">(</span>

<span class="w">    </span><span class="n">env_id</span><span class="p">:</span><span class="w"> </span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">gym</span><span class="o">.</span><span class="n">Env</span><span class="p">]],</span>

<span class="w">    </span><span class="n">n_envs</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>

<span class="w">    </span><span class="n">seed</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">start_index</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>

<span class="w">    </span><span class="n">monitor_dir</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">wrapper_class</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">gym</span><span class="o">.</span><span class="n">Env</span><span class="p">],</span><span class="w"> </span><span class="n">gym</span><span class="o">.</span><span class="n">Env</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">env_kwargs</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">vec_env_cls</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">DummyVecEnv</span><span class="p">,</span><span class="w"> </span><span class="n">SubprocVecEnv</span><span class="p">]]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">vec_env_kwargs</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">monitor_kwargs</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">wrapper_kwargs</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">per_env_kwargs</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span><span class="w">  </span><span class="c1"># NEW</span>

<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">VecEnv</span><span class="p">:</span>

<span class="w">    </span><span class="s2">&quot;&quot;&quot;Modified version of make_vec_env from Stable Baselines (SB3) to allow for specifying input</span>

<span class="s2">    parameters on a per-environment basis</span>

<span class="s2">    The main changes are any lines associated with the per_env_kwargs input. Updated SB3 docstring below:</span>

<span class="s2">    Create a wrapped, monitored ``VecEnv``.</span>

<span class="s2">    By default it uses a ``DummyVecEnv`` which is usually faster</span>

<span class="s2">    than a ``SubprocVecEnv``.</span>

<span class="s2">    :param env_id: either the env ID, the env class or a callable returning an env</span>

<span class="s2">    :param n_envs: the number of environments you wish to have in parallel</span>

<span class="s2">    :param seed: the initial seed for the random number generator</span>

<span class="s2">    :param start_index: start rank index</span>

<span class="s2">    :param monitor_dir: Path to a folder where the monitor files will be saved.</span>

<span class="s2">        If None, no file will be written, however, the env will still be wrapped</span>

<span class="s2">        in a Monitor wrapper to provide additional information about training.</span>

<span class="s2">    :param wrapper_class: Additional wrapper to use on the environment.</span>

<span class="s2">        This can also be a function with single argument that wraps the environment in many things.</span>

<span class="s2">        Note: the wrapper specified by this parameter will be applied after the ``Monitor`` wrapper.</span>

<span class="s2">        if some cases (e.g. with TimeLimit wrapper) this can lead to undesired behavior.</span>

<span class="s2">        See here for more details: https://github.com/DLR-RM/stable-baselines3/issues/894</span>

<span class="s2">    :param env_kwargs: Optional keyword argument to pass to the env constructor</span>

<span class="s2">    :param vec_env_cls: A custom ``VecEnv`` class constructor. Default: None.</span>

<span class="s2">    :param vec_env_kwargs: Keyword arguments to pass to the ``VecEnv`` class constructor.</span>

<span class="s2">    :param monitor_kwargs: Keyword arguments to pass to the ``Monitor`` class constructor.</span>

<span class="s2">    :param wrapper_kwargs: Keyword arguments to pass to the ``Wrapper`` class constructor.</span>

<span class="s2">    :param per_env_kwargs: Like env-kwargs, keyword arguments fore the env constructor, but keyed to</span>

<span class="s2">        allow for different initialization on a per-env basis via the env&#39;s rank. These override any</span>

<span class="s2">        default values set via the env_kwargs input</span>

<span class="s2">    :return: The wrapped environment</span>

<span class="s2">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="n">env_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env_kwargs</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="n">vec_env_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_env_kwargs</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="n">monitor_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">monitor_kwargs</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="n">wrapper_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wrapper_kwargs</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="n">per_env_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">per_env_kwargs</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="k">assert</span><span class="w"> </span><span class="n">vec_env_kwargs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w">  </span><span class="c1"># for mypy</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">make_env</span><span class="p">(</span><span class="n">rank</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Callable</span><span class="p">[[],</span><span class="w"> </span><span class="n">gym</span><span class="o">.</span><span class="n">Env</span><span class="p">]:</span>

<span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="nf">_init</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">gym</span><span class="o">.</span><span class="n">Env</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># For type checker:</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="n">monitor_kwargs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="n">wrapper_kwargs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="n">env_kwargs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span>

<span class="w">            </span><span class="n">this_env_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env_kwargs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">per_env_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">env_id</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">):</span>

<span class="w">                </span><span class="c1"># if the render mode was not specified, we set it to `rgb_array` as default.</span>

<span class="w">                </span><span class="n">kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;render_mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rgb_array&quot;</span><span class="p">}</span>

<span class="w">                </span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">this_env_kwargs</span><span class="p">)</span>

<span class="w">                </span><span class="k">try</span><span class="p">:</span>

<span class="w">                    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">env_id</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="w">  </span><span class="c1"># type: ignore[arg-type]</span>

<span class="w">                </span><span class="k">except</span><span class="w"> </span><span class="n">TypeError</span><span class="p">:</span>

<span class="w">                    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">env_id</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">this_env_kwargs</span><span class="p">)</span>

<span class="w">            </span><span class="k">else</span><span class="p">:</span>

<span class="w">                </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env_id</span><span class="p">(</span><span class="o">**</span><span class="n">this_env_kwargs</span><span class="p">)</span>

<span class="w">                </span><span class="c1"># Patch to support gym 0.21/0.26 and gymnasium</span>

<span class="w">                </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_patch_env</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">                </span><span class="c1"># Note: here we only seed the action space</span>

<span class="w">                </span><span class="c1"># We will seed the env at the next reset</span>

<span class="w">                </span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rank</span><span class="p">)</span>

<span class="w">            </span><span class="c1"># Wrap the env in a Monitor wrapper</span>

<span class="w">            </span><span class="c1"># to have additional training information</span>

<span class="w">            </span><span class="n">monitor_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">monitor_dir</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">))</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">monitor_dir</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span>

<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="c1"># Create the monitor folder if needed</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">monitor_path</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">monitor_dir</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">                </span><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">monitor_dir</span><span class="p">,</span><span class="w"> </span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="w">            </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Monitor</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="o">=</span><span class="n">monitor_path</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">monitor_kwargs</span><span class="p">)</span>

<span class="w">            </span><span class="c1"># Optionally, wrap the environment with the provided wrapper</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">wrapper_class</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">                </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wrapper_class</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">wrapper_kwargs</span><span class="p">)</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">env</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">_init</span>

<span class="w">    </span><span class="c1"># No custom VecEnv is passed</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">vec_env_cls</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="c1"># Default: use a DummyVecEnv</span>

<span class="w">        </span><span class="n">vec_env_cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DummyVecEnv</span>

<span class="w">    </span><span class="n">vec_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_env_cls</span><span class="p">(</span>

<span class="w">        </span><span class="p">[</span><span class="n">make_env</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">start_index</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">n_envs</span><span class="p">)],</span><span class="w"> </span><span class="o">**</span><span class="n">vec_env_kwargs</span>

<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1"># Prepare the seeds for the first reset</span>

<span class="w">    </span><span class="n">vec_env</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vec_env</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_test_envs</span><span class="p">():</span>

<span class="w">    </span><span class="s2">&quot;&quot;&quot;Run a quick test of the environment generation methods&quot;&quot;&quot;</span>

<span class="w">    </span><span class="c1"># Create one primary non-vectorized environment</span>

<span class="w">    </span><span class="n">main_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AstrobeeEnv</span><span class="p">(</span><span class="n">use_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># Create a few vectorized environments</span>

<span class="w">    </span><span class="n">n_vec_envs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>

<span class="w">    </span><span class="n">env_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;use_gui&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">False</span><span class="p">}</span>

<span class="w">    </span><span class="c1"># Let one vectorized environment use the GUI for debugging</span>

<span class="w">    </span><span class="n">per_env_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;use_gui&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">True</span><span class="p">}}</span>

<span class="w">    </span><span class="n">vec_envs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_vec_env</span><span class="p">(</span>

<span class="w">        </span><span class="n">AstrobeeEnv</span><span class="p">,</span>

<span class="w">        </span><span class="n">n_vec_envs</span><span class="p">,</span>

<span class="w">        </span><span class="n">env_kwargs</span><span class="o">=</span><span class="n">env_kwargs</span><span class="p">,</span>

<span class="w">        </span><span class="n">vec_env_cls</span><span class="o">=</span><span class="n">SubprocVecEnv</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">n_vec_envs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">DummyVecEnv</span><span class="p">,</span>

<span class="w">        </span><span class="n">per_env_kwargs</span><span class="o">=</span><span class="n">per_env_kwargs</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="k">try</span><span class="p">:</span>

<span class="w">        </span><span class="c1"># Reset has to be called first</span>

<span class="w">        </span><span class="n">main_env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="w">        </span><span class="n">vec_envs</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="w">        </span><span class="c1"># Call step with dummy action values, note difference in return parameters</span>

<span class="w">        </span><span class="n">observation</span><span class="p">,</span><span class="w"> </span><span class="n">reward</span><span class="p">,</span><span class="w"> </span><span class="n">terminated</span><span class="p">,</span><span class="w"> </span><span class="n">truncated</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main_env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="w">        </span><span class="n">observation</span><span class="p">,</span><span class="w"> </span><span class="n">reward</span><span class="p">,</span><span class="w"> </span><span class="n">done</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_envs</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_vec_envs</span><span class="p">))</span>

<span class="w">        </span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Stepped. Press Enter to finish&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="k">finally</span><span class="p">:</span>

<span class="w">        </span><span class="c1"># Terminate pybullet processes, delete any saved states</span>

<span class="w">        </span><span class="n">main_env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="w">        </span><span class="n">vec_envs</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span><span class="w"> </span><span class="vm">__name__</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

<span class="w">    </span><span class="n">_test_envs</span><span class="p">()</span>
</code></pre></div>

</details>
<h2 id="variables">Variables</h2>
<div class="codehilite"><pre><span></span><code><span class="n">FULL_SAFE_SET</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">MAX_FORCE_MAGNITUDE</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">MAX_TORQUE_MAGNITUDE</span>
</code></pre></div>

<h2 id="functions">Functions</h2>
<h3 id="make_vec_env">make_vec_env</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">make_vec_env</span><span class="p">(</span>
    <span class="n">env_id</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">gymnasium</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Env</span><span class="p">]],</span>
    <span class="n">n_envs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">start_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">monitor_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">wrapper_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">gymnasium</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Env</span><span class="p">],</span> <span class="n">gymnasium</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Env</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">env_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vec_env_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">stable_baselines3</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">vec_env</span><span class="o">.</span><span class="n">dummy_vec_env</span><span class="o">.</span><span class="n">DummyVecEnv</span><span class="p">,</span> <span class="n">stable_baselines3</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">vec_env</span><span class="o">.</span><span class="n">subproc_vec_env</span><span class="o">.</span><span class="n">SubprocVecEnv</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vec_env_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">monitor_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">wrapper_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">per_env_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">stable_baselines3</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">vec_env</span><span class="o">.</span><span class="n">base_vec_env</span><span class="o">.</span><span class="n">VecEnv</span>
</code></pre></div>

<p>Modified version of make_vec_env from Stable Baselines (SB3) to allow for specifying input</p>
<p>parameters on a per-environment basis</p>
<p>The main changes are any lines associated with the per_env_kwargs input. Updated SB3 docstring below:</p>
<p>Create a wrapped, monitored <code>VecEnv</code>.
By default it uses a <code>DummyVecEnv</code> which is usually faster
than a <code>SubprocVecEnv</code>.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>env_id</td>
<td>None</td>
<td>either the env ID, the env class or a callable returning an env</td>
<td>None</td>
</tr>
<tr>
<td>n_envs</td>
<td>None</td>
<td>the number of environments you wish to have in parallel</td>
<td>None</td>
</tr>
<tr>
<td>seed</td>
<td>None</td>
<td>the initial seed for the random number generator</td>
<td>None</td>
</tr>
<tr>
<td>start_index</td>
<td>None</td>
<td>start rank index</td>
<td>None</td>
</tr>
<tr>
<td>monitor_dir</td>
<td>None</td>
<td>Path to a folder where the monitor files will be saved.<br>If None, no file will be written, however, the env will still be wrapped<br>in a Monitor wrapper to provide additional information about training.</td>
<td>None</td>
</tr>
<tr>
<td>wrapper_class</td>
<td>None</td>
<td>Additional wrapper to use on the environment.<br>This can also be a function with single argument that wraps the environment in many things.<br>Note: the wrapper specified by this parameter will be applied after the <code>Monitor</code> wrapper.<br>if some cases (e.g. with TimeLimit wrapper) this can lead to undesired behavior.<br>See here for more details: https://github.com/DLR-RM/stable-baselines3/issues/894</td>
<td>None</td>
</tr>
<tr>
<td>env_kwargs</td>
<td>None</td>
<td>Optional keyword argument to pass to the env constructor</td>
<td>None</td>
</tr>
<tr>
<td>vec_env_cls</td>
<td>None</td>
<td>A custom <code>VecEnv</code> class constructor. Default: None.</td>
<td>None</td>
</tr>
<tr>
<td>vec_env_kwargs</td>
<td>None</td>
<td>Keyword arguments to pass to the <code>VecEnv</code> class constructor.</td>
<td>None</td>
</tr>
<tr>
<td>monitor_kwargs</td>
<td>None</td>
<td>Keyword arguments to pass to the <code>Monitor</code> class constructor.</td>
<td>None</td>
</tr>
<tr>
<td>wrapper_kwargs</td>
<td>None</td>
<td>Keyword arguments to pass to the <code>Wrapper</code> class constructor.</td>
<td>None</td>
</tr>
<tr>
<td>per_env_kwargs</td>
<td>None</td>
<td>Like env-kwargs, keyword arguments fore the env constructor, but keyed to<br>allow for different initialization on a per-env basis via the env's rank. These override any<br>default values set via the env_kwargs input</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>The wrapped environment</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">make_vec_env</span><span class="p">(</span>

<span class="w">    </span><span class="n">env_id</span><span class="o">:</span><span class="w"> </span><span class="k">Union</span><span class="err">[</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">Callable</span><span class="err">[</span><span class="p">...,</span><span class="w"> </span><span class="n">gym</span><span class="p">.</span><span class="n">Env</span><span class="err">]]</span><span class="p">,</span>

<span class="w">    </span><span class="n">n_envs</span><span class="o">:</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>

<span class="w">    </span><span class="n">seed</span><span class="o">:</span><span class="w"> </span><span class="k">Optional</span><span class="err">[</span><span class="kt">int</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">start_index</span><span class="o">:</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>

<span class="w">    </span><span class="n">monitor_dir</span><span class="o">:</span><span class="w"> </span><span class="k">Optional</span><span class="err">[</span><span class="n">str</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">wrapper_class</span><span class="o">:</span><span class="w"> </span><span class="k">Optional</span><span class="err">[</span><span class="n">Callable</span><span class="err">[[</span><span class="n">gym</span><span class="p">.</span><span class="n">Env</span><span class="err">]</span><span class="p">,</span><span class="w"> </span><span class="n">gym</span><span class="p">.</span><span class="n">Env</span><span class="err">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">env_kwargs</span><span class="o">:</span><span class="w"> </span><span class="k">Optional</span><span class="err">[</span><span class="n">Dict</span><span class="err">[</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="k">Any</span><span class="err">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">vec_env_cls</span><span class="o">:</span><span class="w"> </span><span class="k">Optional</span><span class="err">[</span><span class="k">Type</span><span class="err">[</span><span class="k">Union</span><span class="err">[</span><span class="n">DummyVecEnv</span><span class="p">,</span><span class="w"> </span><span class="n">SubprocVecEnv</span><span class="err">]]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">vec_env_kwargs</span><span class="o">:</span><span class="w"> </span><span class="k">Optional</span><span class="err">[</span><span class="n">Dict</span><span class="err">[</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="k">Any</span><span class="err">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">monitor_kwargs</span><span class="o">:</span><span class="w"> </span><span class="k">Optional</span><span class="err">[</span><span class="n">Dict</span><span class="err">[</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="k">Any</span><span class="err">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">wrapper_kwargs</span><span class="o">:</span><span class="w"> </span><span class="k">Optional</span><span class="err">[</span><span class="n">Dict</span><span class="err">[</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="k">Any</span><span class="err">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="n">per_env_kwargs</span><span class="o">:</span><span class="w"> </span><span class="k">Optional</span><span class="err">[</span><span class="n">Dict</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">Dict</span><span class="err">[</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="k">Any</span><span class="err">]]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w">  </span><span class="c1"># NEW</span>

<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">VecEnv</span><span class="o">:</span>

<span class="w">    </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Modified version of make_vec_env from Stable Baselines (SB3) to allow for specifying input</span>

<span class="s2">    parameters on a per-environment basis</span>

<span class="s2">    The main changes are any lines associated with the per_env_kwargs input. Updated SB3 docstring below:</span>

<span class="s2">    Create a wrapped, monitored ``VecEnv``.</span>

<span class="s2">    By default it uses a ``DummyVecEnv`` which is usually faster</span>

<span class="s2">    than a ``SubprocVecEnv``.</span>

<span class="s2">    :param env_id: either the env ID, the env class or a callable returning an env</span>

<span class="s2">    :param n_envs: the number of environments you wish to have in parallel</span>

<span class="s2">    :param seed: the initial seed for the random number generator</span>

<span class="s2">    :param start_index: start rank index</span>

<span class="s2">    :param monitor_dir: Path to a folder where the monitor files will be saved.</span>

<span class="s2">        If None, no file will be written, however, the env will still be wrapped</span>

<span class="s2">        in a Monitor wrapper to provide additional information about training.</span>

<span class="s2">    :param wrapper_class: Additional wrapper to use on the environment.</span>

<span class="s2">        This can also be a function with single argument that wraps the environment in many things.</span>

<span class="s2">        Note: the wrapper specified by this parameter will be applied after the ``Monitor`` wrapper.</span>

<span class="s2">        if some cases (e.g. with TimeLimit wrapper) this can lead to undesired behavior.</span>

<span class="s2">        See here for more details: https://github.com/DLR-RM/stable-baselines3/issues/894</span>

<span class="s2">    :param env_kwargs: Optional keyword argument to pass to the env constructor</span>

<span class="s2">    :param vec_env_cls: A custom ``VecEnv`` class constructor. Default: None.</span>

<span class="s2">    :param vec_env_kwargs: Keyword arguments to pass to the ``VecEnv`` class constructor.</span>

<span class="s2">    :param monitor_kwargs: Keyword arguments to pass to the ``Monitor`` class constructor.</span>

<span class="s2">    :param wrapper_kwargs: Keyword arguments to pass to the ``Wrapper`` class constructor.</span>

<span class="s2">    :param per_env_kwargs: Like env-kwargs, keyword arguments fore the env constructor, but keyed to</span>

<span class="s2">        allow for different initialization on a per-env basis via the env&#39;s rank. These override any</span>

<span class="s2">        default values set via the env_kwargs input</span>

<span class="s2">    :return: The wrapped environment</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="n">env_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env_kwargs</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="err">{}</span>

<span class="w">    </span><span class="n">vec_env_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_env_kwargs</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="err">{}</span>

<span class="w">    </span><span class="n">monitor_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">monitor_kwargs</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="err">{}</span>

<span class="w">    </span><span class="n">wrapper_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wrapper_kwargs</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="err">{}</span>

<span class="w">    </span><span class="n">per_env_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">per_env_kwargs</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="err">{}</span>

<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">vec_env_kwargs</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">None</span><span class="w">  </span><span class="c1"># for mypy</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">make_env</span><span class="p">(</span><span class="k">rank</span><span class="o">:</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Callable</span><span class="err">[[]</span><span class="p">,</span><span class="w"> </span><span class="n">gym</span><span class="p">.</span><span class="n">Env</span><span class="err">]</span><span class="o">:</span>

<span class="w">        </span><span class="n">def</span><span class="w"> </span><span class="n">_init</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">gym</span><span class="p">.</span><span class="n">Env</span><span class="o">:</span>

<span class="w">            </span><span class="c1"># For type checker:</span>

<span class="w">            </span><span class="n">assert</span><span class="w"> </span><span class="n">monitor_kwargs</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">None</span>

<span class="w">            </span><span class="n">assert</span><span class="w"> </span><span class="n">wrapper_kwargs</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">None</span>

<span class="w">            </span><span class="n">assert</span><span class="w"> </span><span class="n">env_kwargs</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">None</span>

<span class="w">            </span><span class="n">this_env_kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env_kwargs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">per_env_kwargs</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="k">rank</span><span class="p">,</span><span class="w"> </span><span class="err">{}</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">env_id</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="o">:</span>

<span class="w">                </span><span class="c1"># if the render mode was not specified, we set it to `rgb_array` as default.</span>

<span class="w">                </span><span class="n">kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="s2">&quot;render_mode&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;rgb_array&quot;</span><span class="err">}</span>

<span class="w">                </span><span class="n">kwargs</span><span class="p">.</span><span class="k">update</span><span class="p">(</span><span class="n">this_env_kwargs</span><span class="p">)</span>

<span class="w">                </span><span class="n">try</span><span class="o">:</span>

<span class="w">                    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gym</span><span class="p">.</span><span class="n">make</span><span class="p">(</span><span class="n">env_id</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="w">  </span><span class="c1"># type: ignore[arg-type]</span>

<span class="w">                </span><span class="k">except</span><span class="w"> </span><span class="n">TypeError</span><span class="o">:</span>

<span class="w">                    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gym</span><span class="p">.</span><span class="n">make</span><span class="p">(</span><span class="n">env_id</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">this_env_kwargs</span><span class="p">)</span>

<span class="w">            </span><span class="k">else</span><span class="o">:</span>

<span class="w">                </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env_id</span><span class="p">(</span><span class="o">**</span><span class="n">this_env_kwargs</span><span class="p">)</span>

<span class="w">                </span><span class="c1"># Patch to support gym 0.21/0.26 and gymnasium</span>

<span class="w">                </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_patch_env</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">None</span><span class="o">:</span>

<span class="w">                </span><span class="c1"># Note: here we only seed the action space</span>

<span class="w">                </span><span class="c1"># We will seed the env at the next reset</span>

<span class="w">                </span><span class="n">env</span><span class="p">.</span><span class="n">action_space</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">rank</span><span class="p">)</span>

<span class="w">            </span><span class="c1"># Wrap the env in a Monitor wrapper</span>

<span class="w">            </span><span class="c1"># to have additional training information</span>

<span class="w">            </span><span class="n">monitor_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">monitor_dir</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">(</span><span class="k">rank</span><span class="p">))</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">monitor_dir</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">None</span>

<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="k">None</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="c1"># Create the monitor folder if needed</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">monitor_path</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">None</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">monitor_dir</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">None</span><span class="o">:</span>

<span class="w">                </span><span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">monitor_dir</span><span class="p">,</span><span class="w"> </span><span class="n">exist_ok</span><span class="o">=</span><span class="no">True</span><span class="p">)</span>

<span class="w">            </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Monitor</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="o">=</span><span class="n">monitor_path</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">monitor_kwargs</span><span class="p">)</span>

<span class="w">            </span><span class="c1"># Optionally, wrap the environment with the provided wrapper</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">wrapper_class</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">None</span><span class="o">:</span>

<span class="w">                </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wrapper_class</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">wrapper_kwargs</span><span class="p">)</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">env</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">_init</span>

<span class="w">    </span><span class="c1"># No custom VecEnv is passed</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">vec_env_cls</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="o">:</span>

<span class="w">        </span><span class="c1"># Default: use a DummyVecEnv</span>

<span class="w">        </span><span class="n">vec_env_cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DummyVecEnv</span>

<span class="w">    </span><span class="n">vec_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_env_cls</span><span class="p">(</span>

<span class="w">        </span><span class="err">[</span><span class="n">make_env</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">start_index</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">n_envs</span><span class="p">)</span><span class="err">]</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">vec_env_kwargs</span>

<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1"># Prepare the seeds for the first reset</span>

<span class="w">    </span><span class="n">vec_env</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vec_env</span>
</code></pre></div>

</details>
<h2 id="classes">Classes</h2>
<h3 id="astrobeeenv">AstrobeeEnv</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AstrobeeEnv</span><span class="p">(</span>
    <span class="n">use_gui</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">robot_pose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">bag_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;top_handle_symmetric&#39;</span><span class="p">,</span>
    <span class="n">bag_mass</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">bag_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">pyastrobee</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">abstract_bag</span><span class="o">.</span><span class="n">CargoBag</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">pyastrobee</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">deformable_bag</span><span class="o">.</span><span class="n">DeformableCargoBag</span><span class="s1">&#39;&gt;,</span>
    <span class="n">load_full_iss</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span>
</code></pre></div>

<p>Base Astrobee environment containing the Astrobee, ISS, and a cargo bag</p>
<h4 id="attributes">Attributes</h4>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>use_gui</td>
<td>bool</td>
<td>Whether or not to use the GUI as opposed to headless.</td>
<td>None</td>
</tr>
<tr>
<td>robot_pose</td>
<td>npt.ArrayLike</td>
<td>Starting position + XYZW quaternion pose of the Astrobee, shape (7,)</td>
<td>None</td>
</tr>
<tr>
<td>bag_name</td>
<td>str</td>
<td>Type of cargo bag to load. Defaults to "top_handle".</td>
<td>"top_handle"</td>
</tr>
<tr>
<td>bag_mass</td>
<td>float</td>
<td>Mass of the cargo bag, in kg. Defaults to 10</td>
<td>None</td>
</tr>
<tr>
<td>bag_type</td>
<td>type[CargoBag]</td>
<td>Class of cargo bag to use in the environment. Defaults to DeformableCargoBag</td>
<td>None</td>
</tr>
<tr>
<td>load_full_iss</td>
<td>bool</td>
<td>Whether to load the ISS (expensive, not necessarily required for rollouts) or<br>just work with the safe set information. Defaults to True (load the ISS)</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">AstrobeeEnv</span><span class="p">(</span><span class="n">gym</span><span class="p">.</span><span class="n">Env</span><span class="p">)</span><span class="err">:</span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;Base Astrobee environment containing the Astrobee, ISS, and a cargo bag</span>

<span class="ss">    Args:</span>

<span class="ss">        use_gui (bool): Whether or not to use the GUI as opposed to headless.</span>

<span class="ss">        robot_pose (npt.ArrayLike, optional): Starting position + XYZW quaternion pose of the Astrobee, shape (7,)</span>

<span class="ss">        bag_name (str, optional): Type of cargo bag to load. Defaults to &quot;</span><span class="n">top_handle</span><span class="ss">&quot;.</span>

<span class="ss">        bag_mass (float): Mass of the cargo bag, in kg. Defaults to 10</span>

<span class="ss">        bag_type (type[CargoBag]): Class of cargo bag to use in the environment. Defaults to DeformableCargoBag</span>

<span class="ss">        load_full_iss (bool, optional): Whether to load the ISS (expensive, not necessarily required for rollouts) or</span>

<span class="ss">            just work with the safe set information. Defaults to True (load the ISS)</span>

<span class="ss">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="n">SAVE_STATE_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;artifacts/saved_states/&quot;</span>

<span class="w">    </span><span class="n">SAVE_STATE_PATHS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">use_gui</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="p">,</span>

<span class="w">        </span><span class="nl">robot_pose</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>

<span class="w">        </span><span class="nl">bag_name</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;top_handle_symmetric&quot;</span><span class="p">,</span>

<span class="w">        </span><span class="nl">bag_mass</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>

<span class="w">        </span><span class="nl">bag_type</span><span class="p">:</span><span class="w"> </span><span class="n">type</span><span class="o">[</span><span class="n">CargoBag</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeformableCargoBag</span><span class="p">,</span>

<span class="w">        </span><span class="nl">load_full_iss</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initialize_pybullet</span><span class="p">(</span><span class="n">use_gui</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">safe_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FULL_SAFE_SET</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">load_full_iss</span><span class="p">:</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">iss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ISS</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="nl">use_gui</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">safe_set</span><span class="p">.</span><span class="k">values</span><span class="p">()</span><span class="err">:</span>

<span class="w">                </span><span class="n">visualize_3D_box</span><span class="p">(</span><span class="n">box</span><span class="p">,</span><span class="w"> </span><span class="n">rgba</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">))</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">robot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Astrobee</span><span class="p">(</span><span class="n">robot_pose</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">bag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bag_type</span><span class="p">(</span><span class="n">bag_name</span><span class="p">,</span><span class="w"> </span><span class="n">bag_mass</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">bag</span><span class="p">.</span><span class="n">reset_to_handle_pose</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">robot</span><span class="p">.</span><span class="n">ee_pose</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">bag</span><span class="p">.</span><span class="n">attach_to</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">robot</span><span class="p">,</span><span class="w"> </span><span class="n">object_to_move</span><span class="o">=</span><span class="ss">&quot;bag&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">getPhysicsEngineParameters</span><span class="p">()</span><span class="o">[</span><span class="n">&quot;fixedTimeStep&quot;</span><span class="o">]</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Dummy</span><span class="w"> </span><span class="k">parameters</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">gym</span><span class="o">/</span><span class="n">stable</span><span class="w"> </span><span class="n">baselines</span><span class="w"> </span><span class="n">compatibility</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="n">gym</span><span class="p">.</span><span class="n">spaces</span><span class="p">.</span><span class="nf">space</span><span class="p">.</span><span class="nf">Space</span><span class="w"> </span><span class="n">subclasses</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">these</span><span class="vm">?</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">observation_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gym</span><span class="p">.</span><span class="n">spaces</span><span class="p">.</span><span class="n">Discrete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">temporary</span><span class="p">,</span><span class="w"> </span><span class="n">unused</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">action_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gym</span><span class="p">.</span><span class="n">spaces</span><span class="p">.</span><span class="n">Discrete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">temporary</span><span class="p">,</span><span class="w"> </span><span class="n">unused</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">simulation</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">bag</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nf">right</span><span class="w"> </span><span class="n">place</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">stepSimulation</span><span class="p">()</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">reset</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">seed</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"> </span><span class="nl">options</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">dict[str, Any</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">ObsType, dict[str, Any</span><span class="o">]</span><span class="err">]:</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Implementation</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="n">reset</span><span class="p">()</span><span class="err">:</span><span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="n">docstring</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="n">states</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">reset</span><span class="p">()</span><span class="w"> </span><span class="k">method</span>

<span class="w">        </span><span class="n">super</span><span class="p">().</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_obs</span><span class="p">(),</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_info</span><span class="p">()</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Initial</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="n">observation</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_get_obs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nl">ObsType</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Translates the environment&#39;s state into an observation</span>

<span class="ss">        Returns:</span>

<span class="ss">            ObsType: Observation</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">recommended</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gym</span><span class="w"> </span><span class="n">documentation</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"> </span><span class="k">None</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Dummy</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">now</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_get_info</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dict</span><span class="o">[</span><span class="n">str, Any</span><span class="o">]</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Provide auxiliary information associated with an observation</span>

<span class="ss">        Returns:</span>

<span class="ss">            dict[str, Any]: Additional observation information</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">recommended</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gym</span><span class="w"> </span><span class="n">documentation</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="err">{}</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Dummy</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">now</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">step</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">action</span><span class="err">:</span><span class="w"> </span><span class="n">ActType</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">ObsType, float, bool, bool, dict[str, Any</span><span class="o">]</span><span class="err">]:</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Implementation</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="n">step</span><span class="p">()</span><span class="err">:</span><span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="n">docstring</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nl">Note</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">parameters</span><span class="w"> </span><span class="n">differ</span><span class="w"> </span><span class="n">slightly</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">step</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">vectorized</span><span class="w"> </span><span class="n">environment</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="ow">In</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pybullet</span><span class="w"> </span><span class="n">simulation</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">dummy</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">reward</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">MPC</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="k">specific</span><span class="w"> </span><span class="n">MPC</span><span class="o">/</span><span class="n">control</span><span class="w"> </span><span class="n">functionality</span><span class="w"> </span><span class="n">here</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">stepSimulation</span><span class="p">()</span>

<span class="w">        </span><span class="n">reward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="n">observation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_obs</span><span class="p">()</span>

<span class="w">        </span><span class="n">terminated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">terminal</span><span class="w"> </span><span class="k">state</span>

<span class="w">        </span><span class="n">truncated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">stopping</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sim</span><span class="w"> </span><span class="k">before</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">terminal</span><span class="w"> </span><span class="k">state</span>

<span class="w">        </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_info</span><span class="p">()</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">observation</span><span class="p">,</span><span class="w"> </span><span class="n">reward</span><span class="p">,</span><span class="w"> </span><span class="n">terminated</span><span class="p">,</span><span class="w"> </span><span class="n">truncated</span><span class="p">,</span><span class="w"> </span><span class="n">info</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">step_simulation</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Single pybullet simulation step&quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">stepSimulation</span><span class="p">()</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">close</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Implementation</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="k">close</span><span class="p">()</span><span class="err">:</span><span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="n">docstring</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="k">disconnect</span><span class="p">()</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">save_state</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">str</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Saves the current simulation state to disk</span>

<span class="ss">        - Note: saved states are not currently overwritten (could lead to issues with parallel environments?). But,</span>

<span class="ss">          these can be cleared out at the end of the simulation period</span>

<span class="ss">        Returns:</span>

<span class="ss">            str: Path to the saved state file</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Autogenerate</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">unique</span><span class="w"> </span><span class="n">filename</span><span class="o">/</span><span class="k">path</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">save</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">it</span>

<span class="w">        </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;state_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="ss">&quot;%Y%m%d_%H%M%S_%f&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">filepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AstrobeeEnv</span><span class="p">.</span><span class="n">SAVE_STATE_DIR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;.bullet&quot;</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">saveBullet</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<span class="w">        </span><span class="n">AstrobeeEnv</span><span class="p">.</span><span class="n">SAVE_STATE_PATHS</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">filepath</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">restore_state</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">filename</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Restores the simulation to a saved state file</span>

<span class="ss">        Args:</span>

<span class="ss">            filename (str): Path to a .bullet saved state within the saved state directory</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_check_state_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">restoreState</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_check_state_file</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">filename</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">str</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Helper function: Validates that a saved state file exists</span>

<span class="ss">        Args:</span>

<span class="ss">            filename (str): Path to a .bullet saved state within the saved state directory</span>

<span class="ss">        Returns:</span>

<span class="ss">            str: Validated path</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="k">path</span><span class="p">.</span><span class="n">suffix</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">&quot;.bullet&quot;</span><span class="err">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="n">f</span><span class="ss">&quot;Invalid filename: {filename}.\nNot a .bullet saved state file&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="k">path</span><span class="p">.</span><span class="n">parent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">Path</span><span class="p">(</span><span class="n">AstrobeeEnv</span><span class="p">.</span><span class="n">SAVE_STATE_DIR</span><span class="p">)</span><span class="err">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="n">f</span><span class="ss">&quot;Invalid filename: {filename}.\nCheck that the filename points to within the saved state directory&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="k">path</span><span class="p">.</span><span class="n">is_file</span><span class="p">()</span><span class="err">:</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="k">path</span><span class="p">)</span>

<span class="w">        </span><span class="n">raise</span><span class="w"> </span><span class="n">FileNotFoundError</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Could not find file: {filename}&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">send_client_command</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ow">Any</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Send a command to the environment&#39;s pybullet client</span>

<span class="ss">        For instance, we can use pybullet.getBasePositionAndOrientation with this as</span>

<span class="ss">        send_client_command(&quot;</span><span class="n">getBasePositionAndOrientation</span><span class="ss">&quot;, body_id)</span>

<span class="ss">        Returns:</span>

<span class="ss">            Any: The return from the Pybullet command</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getattr</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">Callable</span><span class="p">)</span><span class="err">:</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">attr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="o">[</span><span class="n">1:</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">attr</span>
</code></pre></div>

</details>
<hr />
<h4 id="ancestors-in-mro">Ancestors (in MRO)</h4>
<ul>
<li>gymnasium.core.Env</li>
<li>typing.Generic</li>
</ul>
<h4 id="descendants">Descendants</h4>
<ul>
<li>pyastrobee.core.environments.AstrobeeMPCEnv</li>
</ul>
<h4 id="class-variables">Class variables</h4>
<div class="codehilite"><pre><span></span><code><span class="n">SAVE_STATE_DIR</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">SAVE_STATE_PATHS</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">metadata</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">render_mode</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">reward_range</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">spec</span>
</code></pre></div>

<h4 id="instance-variables">Instance variables</h4>
<div class="codehilite"><pre><span></span><code><span class="n">np_random</span>
</code></pre></div>

<p>Returns the environment's internal :attr:<code>_np_random</code> that if not set will initialise with a random seed.</p>
<div class="codehilite"><pre><span></span><code><span class="n">unwrapped</span>
</code></pre></div>

<p>Returns the base non-wrapped environment.</p>
<h4 id="methods">Methods</h4>
<h4 id="close">close</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>After the user has finished using the environment, close contains the code necessary to "clean up" the environment.</p>
<p>This is critical for closing rendering windows, database or HTTP connections.
Calling <code>close</code> on an already closed environment has no effect and won't raise an error.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">def</span><span class="w"> </span><span class="nv">close</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:

<span class="w">        </span>#<span class="w"> </span><span class="nv">Implementation</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">Gym</span><span class="w"> </span><span class="nv">template</span><span class="w"> </span><span class="nv">method</span><span class="w"> </span><span class="nv">close</span><span class="ss">()</span>:<span class="w"> </span><span class="nv">See</span><span class="w"> </span><span class="nv">Gym</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">full</span><span class="w"> </span><span class="nv">method</span><span class="w"> </span><span class="nv">docstring</span>

<span class="w">        </span><span class="nv">self</span>.<span class="nv">client</span>.<span class="k">disconnect</span><span class="ss">()</span>
</code></pre></div>

</details>
<h4 id="get_wrapper_attr">get_wrapper_attr</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_wrapper_attr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Any&#39;</span>
</code></pre></div>

<p>Gets the attribute <code>name</code> from the environment.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">get_wrapper_attr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">name</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">Any</span><span class="o">:</span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Gets the attribute `name` from the environment.</span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">name</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="render">render</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">render</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;RenderFrame | list[RenderFrame] | None&#39;</span>
</code></pre></div>

<p>Compute the render frames as specified by :attr:<code>render_mode</code> during the initialization of the environment.</p>
<p>The environment's :attr:<code>metadata</code> render modes (<code>env.metadata["render_modes"]</code>) should contain the possible
ways to implement the render modes. In addition, list versions for most render modes is achieved through
<code>gymnasium.make</code> which automatically applies a wrapper to collect rendered frames.</p>
<p>Note:
    As the :attr:<code>render_mode</code> is known during <code>__init__</code>, the objects used to render the environment state
    should be initialised in <code>__init__</code>.</p>
<p>By convention, if the :attr:<code>render_mode</code> is:</p>
<ul>
<li>None (default): no render is computed.</li>
<li>"human": The environment is continuously rendered in the current display or terminal, usually for human consumption.
  This rendering should occur during :meth:<code>step</code> and :meth:<code>render</code> doesn't need to be called. Returns <code>None</code>.</li>
<li>"rgb_array": Return a single frame representing the current state of the environment.
  A frame is a <code>np.ndarray</code> with shape <code>(x, y, 3)</code> representing RGB values for an x-by-y pixel image.</li>
<li>"ansi": Return a strings (<code>str</code>) or <code>StringIO.StringIO</code> containing a terminal-style text representation
  for each time step. The text can include newlines and ANSI escape sequences (e.g. for colors).</li>
<li>"rgb_array_list" and "ansi_list": List based version of render modes are possible (except Human) through the
  wrapper, :py:class:<code>gymnasium.wrappers.RenderCollection</code> that is automatically applied during <code>gymnasium.make(..., render_mode="rgb_array_list")</code>.
  The frames collected are popped after :meth:<code>render</code> is called or :meth:<code>reset</code>.</li>
</ul>
<p>Note:
    Make sure that your class's :attr:<code>metadata</code> <code>"render_modes"</code> key includes the list of supported modes.</p>
<p>.. versionchanged:: 0.25.0</p>
<div class="codehilite"><pre><span></span><code>The render function was changed to no longer accept parameters, rather these parameters should be specified
in the environment initialised, i.e., ``gymnasium.make(&quot;CartPole-v1&quot;, render_mode=&quot;human&quot;)``
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">RenderFrame</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">list</span><span class="err">[</span><span class="n">RenderFrame</span><span class="err">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">None</span><span class="o">:</span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Compute the render frames as specified by :attr:`render_mode` during the initialization of the environment.</span>

<span class="s2">        The environment&#39;s :attr:`metadata` render modes (`env.metadata[&quot;</span><span class="n">render_modes</span><span class="s2">&quot;]`) should contain the possible</span>

<span class="s2">        ways to implement the render modes. In addition, list versions for most render modes is achieved through</span>

<span class="s2">        `gymnasium.make` which automatically applies a wrapper to collect rendered frames.</span>

<span class="s2">        Note:</span>

<span class="s2">            As the :attr:`render_mode` is known during ``__init__``, the objects used to render the environment state</span>

<span class="s2">            should be initialised in ``__init__``.</span>

<span class="s2">        By convention, if the :attr:`render_mode` is:</span>

<span class="s2">        - None (default): no render is computed.</span>

<span class="s2">        - &quot;</span><span class="n">human</span><span class="s2">&quot;: The environment is continuously rendered in the current display or terminal, usually for human consumption.</span>

<span class="s2">          This rendering should occur during :meth:`step` and :meth:`render` doesn&#39;t need to be called. Returns ``None``.</span>

<span class="s2">        - &quot;</span><span class="n">rgb_array</span><span class="s2">&quot;: Return a single frame representing the current state of the environment.</span>

<span class="s2">          A frame is a ``np.ndarray`` with shape ``(x, y, 3)`` representing RGB values for an x-by-y pixel image.</span>

<span class="s2">        - &quot;</span><span class="n">ansi</span><span class="s2">&quot;: Return a strings (``str``) or ``StringIO.StringIO`` containing a terminal-style text representation</span>

<span class="s2">          for each time step. The text can include newlines and ANSI escape sequences (e.g. for colors).</span>

<span class="s2">        - &quot;</span><span class="n">rgb_array_list</span><span class="s2">&quot; and &quot;</span><span class="n">ansi_list</span><span class="s2">&quot;: List based version of render modes are possible (except Human) through the</span>

<span class="s2">          wrapper, :py:class:`gymnasium.wrappers.RenderCollection` that is automatically applied during ``gymnasium.make(..., render_mode=&quot;</span><span class="n">rgb_array_list</span><span class="s2">&quot;)``.</span>

<span class="s2">          The frames collected are popped after :meth:`render` is called or :meth:`reset`.</span>

<span class="s2">        Note:</span>

<span class="s2">            Make sure that your class&#39;s :attr:`metadata` ``&quot;</span><span class="n">render_modes</span><span class="s2">&quot;`` key includes the list of supported modes.</span>

<span class="s2">        .. versionchanged:: 0.25.0</span>

<span class="s2">            The render function was changed to no longer accept parameters, rather these parameters should be specified</span>

<span class="s2">            in the environment initialised, i.e., ``gymnasium.make(&quot;</span><span class="n">CartPole</span><span class="o">-</span><span class="n">v1</span><span class="s2">&quot;, render_mode=&quot;</span><span class="n">human</span><span class="s2">&quot;)``</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="n">raise</span><span class="w"> </span><span class="n">NotImplementedError</span>
</code></pre></div>

</details>
<h4 id="reset">reset</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">reset</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">~</span><span class="n">ObsType</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>
</code></pre></div>

<p>Resets the environment to an initial internal state, returning an initial observation and info.</p>
<p>This method generates a new starting state often with some randomness to ensure that the agent explores the
state space and learns a generalised policy about the environment. This randomness can be controlled
with the <code>seed</code> parameter otherwise if the environment already has a random number generator and
:meth:<code>reset</code> is called with <code>seed=None</code>, the RNG is not reset.</p>
<p>Therefore, :meth:<code>reset</code> should (in the typical use case) be called with a seed right after initialization and then never again.</p>
<p>For Custom environments, the first line of :meth:<code>reset</code> should be <code>super().reset(seed=seed)</code> which implements
the seeding correctly.</p>
<p>.. versionchanged:: v0.25</p>
<div class="codehilite"><pre><span></span><code><span class="n">The</span><span class="w"> </span><span class="n n-Quoted">``</span><span class="n">return_info</span><span class="n n-Quoted">``</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">removed</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">returned</span><span class="p">.</span>
</code></pre></div>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>seed</td>
<td>optional int</td>
<td>The seed that is used to initialize the environment's PRNG (<code>np_random</code>).<br>If the environment does not already have a PRNG and <code>seed=None</code> (the default option) is passed,<br>a seed will be chosen from some source of entropy (e.g. timestamp or /dev/urandom).<br>However, if the environment already has a PRNG and <code>seed=None</code> is passed, the PRNG will <em>not</em> be reset.<br>If you pass an integer, the PRNG will be reset even if it already exists.<br>Usually, you want to pass an integer <em>right after the environment has been initialized and then never again</em>.<br>Please refer to the minimal example above to see this paradigm in action.</td>
<td>None</td>
</tr>
<tr>
<td>options</td>
<td>optional dict</td>
<td>Additional information to specify how the environment is reset (optional,<br>depending on the specific environment)</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>observation (ObsType): Observation of the initial state. This will be an element of :attr:<code>observation_space</code><br>    (typically a numpy array) and is analogous to the observation returned by :meth:<code>step</code>.<br>info (dictionary):  This dictionary contains auxiliary information complementing <code>observation</code>. It should be analogous to<br>    the <code>info</code> returned by :meth:<code>step</code>.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">reset</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">seed</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"> </span><span class="nl">options</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">dict[str, Any</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">ObsType, dict[str, Any</span><span class="o">]</span><span class="err">]:</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Implementation</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="n">reset</span><span class="p">()</span><span class="err">:</span><span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="n">docstring</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="n">states</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">reset</span><span class="p">()</span><span class="w"> </span><span class="k">method</span>

<span class="w">        </span><span class="n">super</span><span class="p">().</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_obs</span><span class="p">(),</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_info</span><span class="p">()</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Initial</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="n">observation</span>
</code></pre></div>

</details>
<h4 id="restore_state">restore_state</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">restore_state</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Restores the simulation to a saved state file</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>filename</td>
<td>str</td>
<td>Path to a .bullet saved state within the saved state directory</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">restore_state</span><span class="p">(</span><span class="kr">self</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Restores the simulation to a saved state file</span>

<span class="s">        Args:</span>

<span class="s">            filename (str): Path to a .bullet saved state within the saved state directory</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="n">_check_state_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">restoreState</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="save_state">save_state</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</code></pre></div>

<p>Saves the current simulation state to disk</p>
<ul>
<li>Note: saved states are not currently overwritten (could lead to issues with parallel environments?). But,
  these can be cleared out at the end of the simulation period</li>
</ul>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>str</td>
<td>Path to the saved state file</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">save_state</span><span class="p">(</span><span class="kr">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">str</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Saves the current simulation state to disk</span>

<span class="s">        - Note: saved states are not currently overwritten (could lead to issues with parallel environments?). But,</span>

<span class="s">          these can be cleared out at the end of the simulation period</span>

<span class="s">        Returns:</span>

<span class="s">            str: Path to the saved state file</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Autogenerate</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">unique</span><span class="w"> </span><span class="n">filename</span><span class="o">/</span><span class="n">path</span><span class="w"> </span><span class="kr">and</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">it</span>

<span class="w">        </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;state_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y%m%d_%H%M%S_%f&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">filepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AstrobeeEnv</span><span class="p">.</span><span class="n">SAVE_STATE_DIR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.bullet&quot;</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">saveBullet</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<span class="w">        </span><span class="n">AstrobeeEnv</span><span class="p">.</span><span class="n">SAVE_STATE_PATHS</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="n">filepath</span>
</code></pre></div>

</details>
<h4 id="send_client_command">send_client_command</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">send_client_command</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span>
</code></pre></div>

<p>Send a command to the environment's pybullet client</p>
<p>For instance, we can use pybullet.getBasePositionAndOrientation with this as
send_client_command("getBasePositionAndOrientation", body_id)</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Any</td>
<td>The return from the Pybullet command</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def send_client_command(self, <span class="gs">*args, *</span>*kwargs) -&gt; Any:

        &quot;&quot;&quot;Send a command to the environment&#39;s pybullet client

        For instance, we can use pybullet.getBasePositionAndOrientation with this as

        send_client_command(&quot;getBasePositionAndOrientation&quot;, body_id)

        Returns:

            Any: The return from the Pybullet command

        &quot;&quot;&quot;

        attr = getattr(self.client, args[0])

        if isinstance(attr, Callable):

            return attr(*args[1:], **kwargs)

        return attr
</code></pre></div>

</details>
<h4 id="step">step</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">action</span><span class="p">:</span> <span class="o">~</span><span class="n">ActType</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">~</span><span class="n">ObsType</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>
</code></pre></div>

<p>Run one timestep of the environment's dynamics using the agent actions.</p>
<p>When the end of an episode is reached (<code>terminated or truncated</code>), it is necessary to call :meth:<code>reset</code> to
reset this environment's state for the next episode.</p>
<p>.. versionchanged:: 0.26</p>
<div class="codehilite"><pre><span></span><code><span class="n">The</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="k">changed</span><span class="w"> </span><span class="n">removing</span><span class="w"> </span><span class="n n-Quoted">``</span><span class="n">done</span><span class="n n-Quoted">``</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">favor</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n n-Quoted">``</span><span class="k">terminated</span><span class="n n-Quoted">``</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n n-Quoted">``</span><span class="n">truncated</span><span class="n n-Quoted">``</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">clearer</span>
<span class="k">to</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">had</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">truncated</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">reinforcement</span><span class="w"> </span><span class="n">learning</span>
<span class="n">bootstrapping</span><span class="w"> </span><span class="n">algorithms</span><span class="p">.</span>
</code></pre></div>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>action</td>
<td>ActType</td>
<td>an action provided by the agent to update the environment state.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>observation (ObsType): An element of the environment's :attr:<code>observation_space</code> as the next observation due to the agent actions.<br>    An example is a numpy array containing the positions and velocities of the pole in CartPole.<br>reward (SupportsFloat): The reward as a result of taking the action.<br>terminated (bool): Whether the agent reaches the terminal state (as defined under the MDP of the task)<br>    which can be positive or negative. An example is reaching the goal state or moving into the lava from<br>    the Sutton and Barton, Gridworld. If true, the user needs to call :meth:<code>reset</code>.<br>truncated (bool): Whether the truncation condition outside the scope of the MDP is satisfied.<br>    Typically, this is a timelimit, but could also be used to indicate an agent physically going out of bounds.<br>    Can be used to end the episode prematurely before a terminal state is reached.<br>    If true, the user needs to call :meth:<code>reset</code>.<br>info (dict): Contains auxiliary diagnostic information (helpful for debugging, learning, and logging).<br>    This might, for instance, contain: metrics that describe the agent's performance state, variables that are<br>    hidden from observations, or individual reward terms that are combined to produce the total reward.<br>    In OpenAI Gym &lt;v26, it contains "TimeLimit.truncated" to distinguish truncation and termination,<br>    however this is deprecated in favour of returning terminated and truncated variables.<br>done (bool): (Deprecated) A boolean value for if the episode has ended, in which case further :meth:<code>step</code> calls will<br>    return undefined results. This was removed in OpenAI Gym v26 in favor of terminated and truncated attributes.<br>    A done signal may be emitted for different reasons: Maybe the task underlying the environment was solved successfully,<br>    a certain timelimit was exceeded, or the physics simulation has entered an invalid state.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">step</span><span class="p">(</span>

<span class="w">        </span><span class="kr">self</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="o">:</span><span class="w"> </span><span class="n">ActType</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="p">[</span><span class="n">ObsType</span><span class="p">,</span><span class="w"> </span><span class="n">float</span><span class="p">,</span><span class="w"> </span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="n">dict</span><span class="p">[</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="kr">Any</span><span class="p">]]</span><span class="o">:</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Implementation</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="n">step</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="kr">full</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="n">docstring</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Note</span><span class="o">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="n">differ</span><span class="w"> </span><span class="n">slightly</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">step</span><span class="p">()</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">vectorized</span><span class="w"> </span><span class="n">environment</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="kr">In</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pybullet</span><span class="w"> </span><span class="n">simulation</span><span class="w"> </span><span class="kr">and</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">dummy</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">reward</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">MPC</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">MPC</span><span class="o">/</span><span class="n">control</span><span class="w"> </span><span class="n">functionality</span><span class="w"> </span><span class="n">here</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">stepSimulation</span><span class="p">()</span>

<span class="w">        </span><span class="n">reward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="n">observation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="n">_get_obs</span><span class="p">()</span>

<span class="w">        </span><span class="n">terminated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">False</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">terminal</span><span class="w"> </span><span class="n">state</span>

<span class="w">        </span><span class="n">truncated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">False</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="n">stopping</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sim</span><span class="w"> </span><span class="kr">before</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">terminal</span><span class="w"> </span><span class="n">state</span>

<span class="w">        </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="n">_get_info</span><span class="p">()</span>

<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="n">observation</span><span class="p">,</span><span class="w"> </span><span class="n">reward</span><span class="p">,</span><span class="w"> </span><span class="n">terminated</span><span class="p">,</span><span class="w"> </span><span class="n">truncated</span><span class="p">,</span><span class="w"> </span><span class="n">info</span>
</code></pre></div>

</details>
<h4 id="step_simulation">step_simulation</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">step_simulation</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>Single pybullet simulation step</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def step_simulation(self):

        &quot;&quot;&quot;Single pybullet simulation step&quot;&quot;&quot;

        self.client.stepSimulation()
</code></pre></div>

</details>
<h3 id="astrobeempcenv">AstrobeeMPCEnv</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AstrobeeMPCEnv</span><span class="p">(</span>
    <span class="n">use_gui</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">is_primary</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">robot_pose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">bag_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;top_handle&#39;</span><span class="p">,</span>
    <span class="n">bag_mass</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">bag_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">pyastrobee</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">abstract_bag</span><span class="o">.</span><span class="n">CargoBag</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">pyastrobee</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">deformable_bag</span><span class="o">.</span><span class="n">DeformableCargoBag</span><span class="s1">&#39;&gt;,</span>
    <span class="n">load_full_iss</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">nominal_rollouts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cleanup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span>
</code></pre></div>

<p>Astrobee environment for MPC: Contains additional controller parameters and functions associated with MPC, on</p>
<p>top of the base Astrobee environment capability</p>
<h4 id="attributes_1">Attributes</h4>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>use_gui</td>
<td>bool</td>
<td>Whether or not to use the GUI as opposed to headless.</td>
<td>None</td>
</tr>
<tr>
<td>is_primary</td>
<td>bool</td>
<td>Whether or not this environment is the main simulation (True) or if it is one of the<br>vectorized environments for evaluating a rollout (False)</td>
<td>None</td>
</tr>
<tr>
<td>robot_pose</td>
<td>npt.ArrayLike</td>
<td>Starting position + XYZW quaternion pose of the Astrobee, shape (7,)</td>
<td>None</td>
</tr>
<tr>
<td>bag_name</td>
<td>str</td>
<td>Type of cargo bag to load. Defaults to "top_handle".</td>
<td>"top_handle"</td>
</tr>
<tr>
<td>bag_mass</td>
<td>float</td>
<td>Mass of the cargo bag, in kg. Defaults to 10</td>
<td>None</td>
</tr>
<tr>
<td>bag_type</td>
<td>type[CargoBag]</td>
<td>Class of cargo bag to use in the environment. Defaults to DeformableCargoBag</td>
<td>None</td>
</tr>
<tr>
<td>load_full_iss</td>
<td>bool</td>
<td>Whether to load the ISS (expensive, not necessarily required for rollouts) or<br>just work with the safe set information. Defaults to True (load the ISS)</td>
<td>None</td>
</tr>
<tr>
<td>nominal_rollouts</td>
<td>bool</td>
<td>If True, will roll-out a trajectory based on the nominal target.<br>If False, will sample a trajectory about the nominal target. Defaults to False.</td>
<td>None</td>
</tr>
<tr>
<td>cleanup</td>
<td>bool</td>
<td>Whether or not to delete all saved states when the simulation ends. Defaults to True.</td>
<td>True</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">AstrobeeMPCEnv</span><span class="p">(</span><span class="n">AstrobeeEnv</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Astrobee environment for MPC: Contains additional controller parameters and functions associated with MPC, on</span>

<span class="sd">    top of the base Astrobee environment capability</span>

<span class="sd">    Args:</span>

<span class="sd">        use_gui (bool): Whether or not to use the GUI as opposed to headless.</span>

<span class="sd">        is_primary (bool): Whether or not this environment is the main simulation (True) or if it is one of the</span>

<span class="sd">            vectorized environments for evaluating a rollout (False)</span>

<span class="sd">        robot_pose (npt.ArrayLike, optional): Starting position + XYZW quaternion pose of the Astrobee, shape (7,)</span>

<span class="sd">        bag_name (str, optional): Type of cargo bag to load. Defaults to &quot;top_handle&quot;.</span>

<span class="sd">        bag_mass (float): Mass of the cargo bag, in kg. Defaults to 10</span>

<span class="sd">        bag_type (type[CargoBag]): Class of cargo bag to use in the environment. Defaults to DeformableCargoBag</span>

<span class="sd">        load_full_iss (bool, optional): Whether to load the ISS (expensive, not necessarily required for rollouts) or</span>

<span class="sd">            just work with the safe set information. Defaults to True (load the ISS)</span>

<span class="sd">        nominal_rollouts (bool, optional): If True, will roll-out a trajectory based on the nominal target.</span>

<span class="sd">            If False, will sample a trajectory about the nominal target. Defaults to False.</span>

<span class="sd">        cleanup (bool, optional): Whether or not to delete all saved states when the simulation ends. Defaults to True.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="n">FlightStates</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>

<span class="w">        </span><span class="c1"># STARTING = &quot;starting&quot;</span>

<span class="w">        </span><span class="n">NOMINAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nominal&quot;</span>

<span class="w">        </span><span class="n">SLOWING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;slowing&quot;</span>

<span class="w">        </span><span class="n">STOPPING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;stopping&quot;</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span>

<span class="w">        </span><span class="n">use_gui</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">,</span>

<span class="w">        </span><span class="n">is_primary</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">,</span>

<span class="w">        </span><span class="n">robot_pose</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>

<span class="w">        </span><span class="n">bag_name</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;top_handle&quot;</span><span class="p">,</span>

<span class="w">        </span><span class="n">bag_mass</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>

<span class="w">        </span><span class="n">bag_type</span><span class="p">:</span><span class="w"> </span><span class="n">type</span><span class="p">[</span><span class="n">CargoBag</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeformableCargoBag</span><span class="p">,</span>

<span class="w">        </span><span class="n">load_full_iss</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span><span class="p">,</span>

<span class="w">        </span><span class="n">nominal_rollouts</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span><span class="p">,</span>

<span class="w">        </span><span class="n">cleanup</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span><span class="p">,</span>

<span class="w">    </span><span class="p">):</span>

<span class="w">        </span><span class="n">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>

<span class="w">            </span><span class="n">use_gui</span><span class="p">,</span><span class="w"> </span><span class="n">robot_pose</span><span class="p">,</span><span class="w"> </span><span class="n">bag_name</span><span class="p">,</span><span class="w"> </span><span class="n">bag_mass</span><span class="p">,</span><span class="w"> </span><span class="n">bag_type</span><span class="p">,</span><span class="w"> </span><span class="n">load_full_iss</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="c1"># TODO figure out how to handle controller parameters</span>

<span class="w">        </span><span class="c1"># Just fixing the gains here for now</span>

<span class="w">        </span><span class="c1"># TODO should these be functions of the bag mass???</span>

<span class="w">        </span><span class="n">kp</span><span class="p">,</span><span class="w"> </span><span class="n">kv</span><span class="p">,</span><span class="w"> </span><span class="n">kq</span><span class="p">,</span><span class="w"> </span><span class="n">kw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="w">  </span><span class="c1"># TODO make parameters</span>

<span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">position</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">position</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ForceTorqueController</span><span class="p">(</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">mass</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bag_mass</span><span class="p">,</span>

<span class="w">            </span><span class="c1"># self.robot.inertia,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">inertia</span>

<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">bag_mass</span>

<span class="w">            </span><span class="o">*</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>

<span class="w">            </span><span class="p">),</span><span class="w">  </span><span class="c1"># TODO parallel axis theorem for bag?? test this</span>

<span class="w">            </span><span class="n">kp</span><span class="p">,</span>

<span class="w">            </span><span class="n">kv</span><span class="p">,</span>

<span class="w">            </span><span class="n">kq</span><span class="p">,</span>

<span class="w">            </span><span class="n">kw</span><span class="p">,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>

<span class="w">            </span><span class="n">max_force</span><span class="o">=</span><span class="n">MAX_FORCE_MAGNITUDE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">  </span><span class="c1"># TODO REMOVE THIS SCALING FACTOR</span>

<span class="w">            </span><span class="n">max_torque</span><span class="o">=</span><span class="n">MAX_TORQUE_MAGNITUDE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>

<span class="w">            </span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Sampling parameters (TODO these need refinement)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">pos_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">orn_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">vel_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">accel_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">        </span><span class="c1"># Store last acceleration commands</span>

<span class="w">        </span><span class="c1"># Update through set_attr</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">last_accel_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">last_alpha_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">        </span><span class="c1"># Frequency at which we query our &quot;stay away from the walls&quot; cost function</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set_eval_freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w">  </span><span class="c1"># Hz</span>

<span class="w">        </span><span class="c1"># Keep track of any temporary debug visualizer IDs</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">debug_viz_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span>

<span class="w">        </span><span class="c1"># Keep track of whether we&#39;re stopping or in a nominal flight mode</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">NOMINAL</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">        </span><span class="c1"># (effectively the rollout duration, should be a constant) - TODO IMPROVE THIS</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">planning_duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>

<span class="w">        </span><span class="c1"># Store where we want the Astrobee to be at the end of the MPC run to determine if we are done</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">goal_pose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">        </span><span class="c1"># HACK - improve how this is handled</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_is_primary_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is_primary</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_is_debugging_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">is_primary</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">use_gui</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_nominal_rollouts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nominal_rollouts</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cleanup</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w">  </span><span class="c1"># Init</span>

<span class="w">    </span><span class="err">@</span><span class="n">property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">is_primary_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether this environment is running the primary planning/control simulation</span>

<span class="sd">        or is a separate (likely vectorized) environment for evaluating rollouts&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_is_primary_env</span>

<span class="w">    </span><span class="err">@</span><span class="n">property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">is_debugging_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether this is an environment launched in debug mode&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_is_debugging_env</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">set_arm_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">traj</span><span class="p">:</span><span class="w"> </span><span class="n">ArmTrajectory</span><span class="p">):</span><span class="w">  </span><span class="c1"># TODO IMPROVE THIS</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">traj</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">set_planning_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">):</span><span class="w">  </span><span class="c1"># TODO improve this</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">planning_duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">set_flight_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">FlightStates</span><span class="p">]):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the current flight state: for instance, whether we are in nominal operating mode, stopping, ...</span>

<span class="sd">        Args:</span>

<span class="sd">            state (Union[str, FlightStates]): A flight state or its string representation</span>

<span class="sd">                (i.e. &quot;nominal&quot;, &quot;stopping&quot;, ...)</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="c1"># TODO add check that it is valid</span>

<span class="w">        </span><span class="c1"># TODO should we store the state as the string or the Enum????</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">):</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="p">):</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;Flight state not recognized&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">set_target_state</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span>

<span class="w">        </span><span class="n">pos</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">orn</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">vel</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">omega</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">accel</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">alpha</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">duration</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">float</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the target dynamics state for planning/sampling trajectories and determining penalties</span>

<span class="sd">        Args:</span>

<span class="sd">            pos (npt.ArrayLike): Desired position, shape (3,)</span>

<span class="sd">            orn (npt.ArrayLike): Desired XYZW quaternion orientation, shape (4,)</span>

<span class="sd">            vel (npt.ArrayLike): Desired linear velocity, shape (3,)</span>

<span class="sd">            omega (npt.ArrayLike): Desired angular velocity, shape (3,)</span>

<span class="sd">            accel (npt.ArrayLike): Desired linear acceleration, shape (3,)</span>

<span class="sd">            alpha (npt.ArrayLike): Desired angular acceleration, shape (3,)</span>

<span class="sd">            duration (float): Amount of time to pass before achieving this desired state</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orn</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vel</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omega</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_accel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accel</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">target_duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">sample_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Samples a trajectory about the nominal target.</span>

<span class="sd">        - If the nominal_rollouts parameter is True for this environment, the final state of the trajectory will be</span>

<span class="sd">          exactly the nominal value (no noise added when sampling)</span>

<span class="sd">        - This should just be called in the vectorized rollout environments (not the main environment) since the main</span>

<span class="sd">          environment will use the best trajectory from the rollout envs</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="s2">&quot;Trajectory sampling should only occur in one of parallel environments for evaluation purposes&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="p">,</span><span class="w"> </span><span class="n">vel</span><span class="p">,</span><span class="w"> </span><span class="n">omega</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">dynamics_state</span>

<span class="w">        </span><span class="c1"># Time sampling parameters (TODO refine these, move them somewhere else)</span>

<span class="w">        </span><span class="n">time_stdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="c1"># Note: ensure that this is a positive value post-sampling</span>

<span class="w">        </span><span class="n">min_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="n">n_timesteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planning_duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span><span class="w">  </span><span class="c1"># Nominal</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">:</span>

<span class="w">            </span><span class="n">end_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="p">[</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_accel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_alpha</span><span class="p">,</span>

<span class="w">                </span><span class="p">]</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_nominal_rollouts</span>

<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="n">sample_state</span><span class="p">(</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">last_accel_cmd</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">last_alpha_cmd</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">pos_stdev</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">orn_stdev</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">vel_stdev</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_stdev</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">accel_stdev</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_stdev</span><span class="p">,</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">target_duration</span>

<span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">SLOWING</span><span class="p">:</span>

<span class="w">            </span><span class="n">end_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="p">[</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_accel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_alpha</span><span class="p">,</span>

<span class="w">                </span><span class="p">]</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_nominal_rollouts</span>

<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="n">sample_state</span><span class="p">(</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">last_accel_cmd</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">last_alpha_cmd</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">pos_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">orn_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">vel_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">accel_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_stdev</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_duration</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_nominal_rollouts</span>

<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_duration</span><span class="p">,</span><span class="w"> </span><span class="n">time_stdev</span><span class="p">),</span><span class="w"> </span><span class="n">min_time</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">STOPPING</span><span class="p">:</span>

<span class="w">            </span><span class="n">end_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">,</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">,</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">,</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">,</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_accel</span><span class="p">,</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">target_alpha</span><span class="p">,</span>

<span class="w">            </span><span class="p">]</span>

<span class="w">            </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">planning_duration</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_nominal_rollouts</span>

<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planning_duration</span><span class="p">,</span><span class="w"> </span><span class="n">time_stdev</span><span class="p">),</span><span class="w"> </span><span class="n">min_time</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">AttributeError</span><span class="p">(</span><span class="s2">&quot;Flight state not recognized&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">traj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_planner</span><span class="p">(</span>

<span class="w">            </span><span class="n">pos</span><span class="p">,</span>

<span class="w">            </span><span class="n">orn</span><span class="p">,</span>

<span class="w">            </span><span class="n">vel</span><span class="p">,</span>

<span class="w">            </span><span class="n">omega</span><span class="p">,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">last_accel_cmd</span><span class="p">,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">last_alpha_cmd</span><span class="p">,</span>

<span class="w">            </span><span class="o">*</span><span class="n">end_state</span><span class="p">,</span>

<span class="w">            </span><span class="n">duration</span><span class="p">,</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">traj</span><span class="o">.</span><span class="n">num_timesteps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_timesteps</span><span class="p">:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">traj</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># Traj is either too long or too short, so adjust it</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">traj</span><span class="o">.</span><span class="n">num_timesteps</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">n_timesteps</span><span class="p">:</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">traj</span><span class="o">.</span><span class="n">get_segment</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">n_timesteps</span><span class="p">)</span>

<span class="w">            </span><span class="k">else</span><span class="p">:</span><span class="w">  </span><span class="c1"># Less than</span>

<span class="w">                </span><span class="c1"># Create a trajectory at the stopped position for the remaining timesteps</span>

<span class="w">                </span><span class="n">remaining_timesteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_timesteps</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">traj</span><span class="o">.</span><span class="n">num_timesteps</span>

<span class="w">                </span><span class="n">stop_traj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Trajectory</span><span class="p">(</span>

<span class="w">                    </span><span class="n">traj</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">traj</span><span class="o">.</span><span class="n">quaternions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">remaining_timesteps</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)),</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">remaining_timesteps</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">concatenate_trajs</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span><span class="w"> </span><span class="n">stop_traj</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">sampled_end_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">quaternions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">linear_velocities</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">angular_velocities</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_get_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ObsType</span><span class="p">:</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span><span class="p">:</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">full_state</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">dynamics_state</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">None</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">step</span><span class="p">(</span>

<span class="w">        </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="p">:</span><span class="w"> </span><span class="n">ActType</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="p">[</span><span class="n">ObsType</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">float</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">,</span><span class="w"> </span><span class="n">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]:</span>

<span class="w">        </span><span class="c1"># Note: For MPC, this is less so a &quot;step&quot; than a &quot;rollout&quot; function. The trajectory should be sampled</span>

<span class="w">        </span><span class="c1">#       before calling this function</span>

<span class="w">        </span><span class="c1"># TODO use the action parameter to pass in a trajectory to follow?</span>

<span class="w">        </span><span class="n">terminated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span><span class="w">  </span><span class="c1"># init (If at the terminal state)</span>

<span class="w">        </span><span class="n">truncated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span><span class="w">  </span><span class="c1"># init (If stopping the sim before the terminal state)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;Trajectory has not been planned&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Follow the trajectory. NOTE: This is effectively the same as the follow_traj() function in the controller,</span>

<span class="w">        </span><span class="c1"># but accessing the loop directly allows us to do more with the data at each step</span>

<span class="w">        </span><span class="c1"># TODO decide how to handle the stopping criteria</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">num_timesteps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;Mismatched time info between base and arm trajs&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># If this is the primary simulation, we just follow the best trajectory we have</span>

<span class="w">        </span><span class="c1"># Rewrd for the primary simulation doesn&#39;t mean anything, so no computation needed</span>

<span class="w">        </span><span class="n">inertia_update_freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>

<span class="w">        </span><span class="n">steps_per_inertia_update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">round</span><span class="p">(</span>

<span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">timestep</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inertia_update_freq</span><span class="p">)</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">):</span>

<span class="w">                </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="p">,</span><span class="w"> </span><span class="n">lin_vel</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_current_state</span><span class="p">()</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>

<span class="w">                    </span><span class="n">pos</span><span class="p">,</span>

<span class="w">                    </span><span class="n">lin_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="n">orn</span><span class="p">,</span>

<span class="w">                    </span><span class="n">ang_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">linear_velocities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">linear_accels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">quaternions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">angular_velocities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">angular_accels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_joint_angles</span><span class="p">(</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="o">.</span><span class="n">joint_ids</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="c1"># TODO THIS KINDA SUCKS</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">steps_per_inertia_update</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">                    </span><span class="n">T_R2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">tmat</span>

<span class="w">                    </span><span class="n">T_B2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">tmat</span>

<span class="w">                    </span><span class="n">T_B2R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invert_transform_mat</span><span class="p">(</span><span class="n">T_R2W</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">T_B2W</span>

<span class="w">                    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T_B2R</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">inertia</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">mass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span>

<span class="w">                        </span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">            </span><span class="n">reward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># We are in a rollout environment</span>

<span class="w">            </span><span class="c1"># So, follow the trajectory, but also keep track of a bunch of things so that we can compute the reward</span>

<span class="w">            </span><span class="n">robot_safe_set_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">            </span><span class="n">bag_safe_set_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1"># init</span>

<span class="w">            </span><span class="n">stabilization_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="n">tracking_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="n">bag_vel_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="n">steps_per_safe_set_eval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">round</span><span class="p">(</span>

<span class="w">                </span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">timestep</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set_eval_freq</span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="c1"># TODO IMPROVE THIS</span>

<span class="w">            </span><span class="c1"># the thought here was that if we&#39;re stopping (or slowing) we care more about the overall positioning</span>

<span class="w">            </span><span class="c1"># rather than just staying in the middle of the modules</span>

<span class="w">            </span><span class="n">safe_set_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="mi">1</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">NOMINAL</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mf">0.1</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">):</span>

<span class="w">                </span><span class="c1"># Note: the traj log gets updated whenever we access the current state</span>

<span class="w">                </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">orn</span><span class="p">,</span><span class="w"> </span><span class="n">lin_vel</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_current_state</span><span class="p">()</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>

<span class="w">                    </span><span class="n">pos</span><span class="p">,</span>

<span class="w">                    </span><span class="n">lin_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="n">orn</span><span class="p">,</span>

<span class="w">                    </span><span class="n">ang_vel</span><span class="p">,</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">linear_velocities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">linear_accels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">quaternions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">angular_velocities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">angular_accels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_joint_angles</span><span class="p">(</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">arm_traj_plan</span><span class="o">.</span><span class="n">joint_ids</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="c1"># TODO THIS KINDA SUCKS</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">steps_per_inertia_update</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">                    </span><span class="n">T_R2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">tmat</span>

<span class="w">                    </span><span class="n">T_B2W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">tmat</span>

<span class="w">                    </span><span class="n">T_B2R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invert_transform_mat</span><span class="p">(</span><span class="n">T_R2W</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">T_B2W</span>

<span class="w">                    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T_B2R</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>

<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">inertia</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">mass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span>

<span class="w">                        </span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">                </span><span class="c1"># *** COST FUNCTION ***</span>

<span class="w">                </span><span class="c1"># Perform collision checking on every timestep</span>

<span class="w">                </span><span class="n">robot_bb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">bounding_box</span>

<span class="w">                </span><span class="n">bag_bb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">bounding_box</span>

<span class="w">                </span><span class="n">robot_is_safe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_box_containment</span><span class="p">(</span><span class="n">robot_bb</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="w">                </span><span class="n">bag_is_safe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_box_containment</span><span class="p">(</span><span class="n">bag_bb</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="w">                </span><span class="c1"># If either the robot or bag collided, stop the simulation and return an effectively infinite cost</span>

<span class="w">                </span><span class="c1"># (Very large but not infinity to maintain sorting order in the edge case that all rollouts collide)</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">robot_is_safe</span><span class="p">:</span>

<span class="w">                    </span><span class="n">robot_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">10000</span>

<span class="w">                    </span><span class="n">truncated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span>

<span class="w">                    </span><span class="c1"># break</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">bag_is_safe</span><span class="p">:</span>

<span class="w">                    </span><span class="n">bag_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">10000</span>

<span class="w">                    </span><span class="n">truncated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span>

<span class="w">                    </span><span class="c1"># break</span>

<span class="w">                </span><span class="c1"># These &quot;stay away from the walls&quot; costs are somewhat expensive to compute and don&#39;t necessarily need</span>

<span class="w">                </span><span class="c1"># to be done every timestep. TODO just use the local description of the safe set, not the full thing</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">steps_per_safe_set_eval</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">                    </span><span class="n">robot_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">safe_set_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">safe_set_cost</span><span class="p">(</span>

<span class="w">                        </span><span class="n">robot_bb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">                    </span><span class="n">robot_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">safe_set_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">safe_set_cost</span><span class="p">(</span>

<span class="w">                        </span><span class="n">robot_bb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">                    </span><span class="n">bag_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">safe_set_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">safe_set_cost</span><span class="p">(</span>

<span class="w">                        </span><span class="n">bag_bb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">                    </span><span class="n">bag_safe_set_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">safe_set_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">safe_set_cost</span><span class="p">(</span>

<span class="w">                        </span><span class="n">bag_bb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">safe_set</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

<span class="w">                    </span><span class="p">)</span>

<span class="w">            </span><span class="n">bag_pos</span><span class="p">,</span><span class="w"> </span><span class="n">bag_orn</span><span class="p">,</span><span class="w"> </span><span class="n">bag_vel</span><span class="p">,</span><span class="w"> </span><span class="n">bag_ang_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">dynamics_state</span>

<span class="w">            </span><span class="c1"># Penalizing bag velocities perpendicular to the robot&#39;s velocity at end of rollout</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">:</span>

<span class="w">                </span><span class="n">bag_vel_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span>

<span class="w">                    </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bag_vel</span><span class="p">)</span>

<span class="w">                    </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lin_vel</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lin_vel</span><span class="p">),</span><span class="w"> </span><span class="n">bag_vel</span><span class="p">)</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="c1"># End-of-rollout additional cost function evaluations</span>

<span class="w">            </span><span class="c1"># 1) Stabilize the motion of the bag with respect to the robot</span>

<span class="w">            </span><span class="c1"># 2) Position the robot so it&#39;s stopped at the goal pose</span>

<span class="w">            </span><span class="c1"># Both of these are only relevant when we&#39;re at the end of the nominal trajectory</span>

<span class="w">            </span><span class="c1"># TODO tune all of the scaling factors on the costs</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">STOPPING</span><span class="p">:</span>

<span class="w">                </span><span class="n">angular_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ang_vel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bag_ang_vel</span><span class="p">)</span>

<span class="w">                </span><span class="n">r_r2b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bag_pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pos</span><span class="w">  </span><span class="c1"># Vector from robot to bag</span>

<span class="w">                </span><span class="n">linear_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>

<span class="w">                    </span><span class="n">lin_vel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bag_vel</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ang_vel</span><span class="p">,</span><span class="w"> </span><span class="n">r_r2b</span><span class="p">)</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="n">stabilization_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">500</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">linear_term</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">angular_term</span><span class="p">)</span>

<span class="w">                </span><span class="c1"># TODO make this a separate function?</span>

<span class="w">                </span><span class="c1"># Adding back in a tracking cost component</span>

<span class="w">                </span><span class="c1"># If we are stopping then we know that the target state is the goal</span>

<span class="w">                </span><span class="n">pos_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">)</span>

<span class="w">                </span><span class="n">orn_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quaternion_dist</span><span class="p">(</span><span class="n">orn</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">target_orn</span><span class="p">)</span>

<span class="w">                </span><span class="n">vel_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lin_vel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">target_vel</span><span class="p">)</span>

<span class="w">                </span><span class="n">ang_vel_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ang_vel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">target_omega</span><span class="p">)</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_debugging_simulation</span><span class="p">:</span>

<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Position error: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pos_error</span><span class="p">)</span>

<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Orn error: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">orn_error</span><span class="p">)</span>

<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vel error: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vel_error</span><span class="p">)</span>

<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ang vel error: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ang_vel_error</span><span class="p">)</span>

<span class="w">                </span><span class="n">tracking_cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span>

<span class="w">                    </span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pos_error</span>

<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">orn_error</span>

<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vel_error</span>

<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ang_vel_error</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="k">else</span><span class="p">:</span>

<span class="w">                </span><span class="n">stabilization_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">                </span><span class="n">tracking_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_debugging_simulation</span><span class="p">:</span>

<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Robot safe set cost: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">robot_safe_set_cost</span><span class="p">)</span>

<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bag safe set cost: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bag_safe_set_cost</span><span class="p">)</span>

<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stabilization cost: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">stabilization_cost</span><span class="p">)</span>

<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracking cost: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tracking_cost</span><span class="p">)</span>

<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bag velocity cost: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bag_vel_cost</span><span class="p">)</span>

<span class="w">            </span><span class="n">reward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span>

<span class="w">                </span><span class="n">robot_safe_set_cost</span>

<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">bag_safe_set_cost</span>

<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">stabilization_cost</span>

<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">tracking_cost</span>

<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">bag_vel_cost</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Observe the robot/bag state in the main env, dummy value if in rollout env</span>

<span class="w">        </span><span class="n">observation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_get_obs</span><span class="p">()</span>

<span class="w">        </span><span class="c1"># Evaluate if we have stabilized the robot and the bag at the end of the trajectory</span>

<span class="w">        </span><span class="c1"># (main env only since that&#39;s what we care about and we don&#39;t want to waste compute)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">flight_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">FlightStates</span><span class="o">.</span><span class="n">STOPPING</span>

<span class="w">            </span><span class="ow">and</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span>

<span class="w">            </span><span class="ow">and</span><span class="w"> </span><span class="n">robot_and_bag_termination_criteria</span><span class="p">(</span>

<span class="w">                </span><span class="n">observation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">observation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">goal_pose</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="p">):</span>

<span class="w">            </span><span class="n">terminated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span>

<span class="w">        </span><span class="c1"># TODO: If we change the observation function to return the state of the robot and the bag,</span>

<span class="w">        </span><span class="c1"># we can determine the &quot;terminated&quot; parameter!</span>

<span class="w">        </span><span class="c1"># But note that we should only really do the observation in the main env</span>

<span class="w">        </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">observation</span><span class="p">,</span><span class="w"> </span><span class="n">reward</span><span class="p">,</span><span class="w"> </span><span class="n">terminated</span><span class="p">,</span><span class="w"> </span><span class="n">truncated</span><span class="p">,</span><span class="w"> </span><span class="n">info</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># Delete all of the previous saved states at the end of the simulation process</span>

<span class="w">            </span><span class="c1"># TODO: decide if each session should have its own directory?</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">AstrobeeMPCEnv</span><span class="o">.</span><span class="n">SAVE_STATE_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.bullet&quot;</span><span class="p">):</span>

<span class="w">                </span><span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">str</span><span class="p">:</span>

<span class="w">        </span><span class="c1"># Ensure that any simulations strictly for evaluating rollouts cannot save their state</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">is_primary_simulation</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">PermissionError</span><span class="p">(</span><span class="s2">&quot;Only the primary simulation can save the state&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">super</span><span class="p">()</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">get_robot_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the full state information for the Astrobee in the environment (Base pos/orn/vels, joint angles/vels)</span>

<span class="sd">        Returns:</span>

<span class="sd">            tuple[np.ndarray, ...]:</span>

<span class="sd">                np.ndarray: Position, shape (3,)</span>

<span class="sd">                np.ndarray: Orientation (XYZW quaternion), shape (4,)</span>

<span class="sd">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="sd">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="sd">                np.ndarray: Joint positions, shape (NUM_JOINTS,)</span>

<span class="sd">                np.ndarray: Joint velocities, shape (NUM_JOINTS,)</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">full_state</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">get_bag_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the dynamics state information for the bag in the environment (pos/orn/vels)</span>

<span class="sd">        Returns:</span>

<span class="sd">            tuple[np.ndarray, ...]:</span>

<span class="sd">                np.ndarray: Position, shape (3,)</span>

<span class="sd">                np.ndarray: XYZW quaternion orientation, shape (4,)</span>

<span class="sd">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="sd">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">dynamics_state</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">reset_robot_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="n">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fully resets the state of the Astrobee in the environment</span>

<span class="sd">        Args:</span>

<span class="sd">            state (tuple[np.ndarray, ...]): Full Astrobee state information containing:</span>

<span class="sd">                np.ndarray: Position, shape (3,)</span>

<span class="sd">                np.ndarray: Orientation (XYZW quaternion), shape (4,)</span>

<span class="sd">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="sd">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="sd">                np.ndarray: Joint positions, shape (NUM_JOINTS,)</span>

<span class="sd">                np.ndarray: Joint velocities, shape (NUM_JOINTS,)</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Astrobee</span><span class="o">.</span><span class="n">NUM_JOINTS</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">reset_full_state</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">reset_bag_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="n">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets the dynamics of the bag in the environment</span>

<span class="sd">        Args:</span>

<span class="sd">            state (tuple[np.ndarray, ...]): Dynamics info of the bag, containing:</span>

<span class="sd">                np.ndarray: Position, shape (3,)</span>

<span class="sd">                np.ndarray: Orientation (XYZW quaternion), shape (4,)</span>

<span class="sd">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="sd">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">bag</span><span class="o">.</span><span class="n">reset_dynamics</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">show_traj_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb nb-Type">int</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Displays the planned trajectory on the current pybullet client GUI (if enabled)</span>

<span class="sd">        Args:</span>

<span class="sd">            n (Optional[int]): Number of frames to plot, if plotting all of the frames is not desired.</span>

<span class="sd">                Defaults to None (plot all frames)</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;No trajectory available to visualize&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">debug_viz_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">traj_plan</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">unshow_traj_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes a displayed trajectory from the pybullet client GUI&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_viz_ids</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">            </span><span class="k">return</span>

<span class="w">        </span><span class="n">remove_debug_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_viz_ids</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">debug_viz_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span>
</code></pre></div>

</details>
<hr />
<h4 id="ancestors-in-mro_1">Ancestors (in MRO)</h4>
<ul>
<li>pyastrobee.core.environments.AstrobeeEnv</li>
<li>gymnasium.core.Env</li>
<li>typing.Generic</li>
</ul>
<h4 id="class-variables_1">Class variables</h4>
<div class="codehilite"><pre><span></span><code><span class="n">FlightStates</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">SAVE_STATE_DIR</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">SAVE_STATE_PATHS</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">metadata</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">render_mode</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">reward_range</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">spec</span>
</code></pre></div>

<h4 id="instance-variables_1">Instance variables</h4>
<div class="codehilite"><pre><span></span><code><span class="n">is_debugging_simulation</span>
</code></pre></div>

<p>Whether this is an environment launched in debug mode</p>
<div class="codehilite"><pre><span></span><code><span class="n">is_primary_simulation</span>
</code></pre></div>

<p>Whether this environment is running the primary planning/control simulation</p>
<p>or is a separate (likely vectorized) environment for evaluating rollouts</p>
<div class="codehilite"><pre><span></span><code><span class="n">np_random</span>
</code></pre></div>

<p>Returns the environment's internal :attr:<code>_np_random</code> that if not set will initialise with a random seed.</p>
<div class="codehilite"><pre><span></span><code><span class="n">unwrapped</span>
</code></pre></div>

<p>Returns the base non-wrapped environment.</p>
<h4 id="methods_1">Methods</h4>
<h4 id="close_1">close</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>After the user has finished using the environment, close contains the code necessary to "clean up" the environment.</p>
<p>This is critical for closing rendering windows, database or HTTP connections.
Calling <code>close</code> on an already closed environment has no effect and won't raise an error.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def close(self):

        self.client.disconnect()

        if self.is_primary_simulation and self._cleanup:

            # Delete all of the previous saved states at the end of the simulation process

            # TODO: decide if each session should have its own directory?

            for path in Path(AstrobeeMPCEnv.SAVE_STATE_DIR).glob(&quot;*.bullet&quot;):

                path.unlink()
</code></pre></div>

</details>
<h4 id="get_bag_state">get_bag_state</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_bag_state</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</code></pre></div>

<p>Returns the dynamics state information for the bag in the environment (pos/orn/vels)</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>tuple[np.ndarray, ...]</td>
<td>np.ndarray: Position, shape (3,)<br>np.ndarray: XYZW quaternion orientation, shape (4,)<br>np.ndarray: Linear velocity, shape (3,)<br>np.ndarray: Angular velocity, shape (3,)</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">get_bag_state</span><span class="p">(</span><span class="kr">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="p">...]</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Returns the dynamics state information for the bag in the environment (pos/orn/vels)</span>

<span class="s">        Returns:</span>

<span class="s">            tuple[np.ndarray, ...]:</span>

<span class="s">                np.ndarray: Position, shape (3,)</span>

<span class="s">                np.ndarray: XYZW quaternion orientation, shape (4,)</span>

<span class="s">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="s">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="n">bag</span><span class="p">.</span><span class="n">dynamics_state</span>
</code></pre></div>

</details>
<h4 id="get_robot_state">get_robot_state</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_robot_state</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</code></pre></div>

<p>Returns the full state information for the Astrobee in the environment (Base pos/orn/vels, joint angles/vels)</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>tuple[np.ndarray, ...]</td>
<td>np.ndarray: Position, shape (3,)<br>np.ndarray: Orientation (XYZW quaternion), shape (4,)<br>np.ndarray: Linear velocity, shape (3,)<br>np.ndarray: Angular velocity, shape (3,)<br>np.ndarray: Joint positions, shape (NUM_JOINTS,)<br>np.ndarray: Joint velocities, shape (NUM_JOINTS,)</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">get_robot_state</span><span class="p">(</span><span class="kr">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="p">...]</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Returns the full state information for the Astrobee in the environment (Base pos/orn/vels, joint angles/vels)</span>

<span class="s">        Returns:</span>

<span class="s">            tuple[np.ndarray, ...]:</span>

<span class="s">                np.ndarray: Position, shape (3,)</span>

<span class="s">                np.ndarray: Orientation (XYZW quaternion), shape (4,)</span>

<span class="s">                np.ndarray: Linear velocity, shape (3,)</span>

<span class="s">                np.ndarray: Angular velocity, shape (3,)</span>

<span class="s">                np.ndarray: Joint positions, shape (NUM_JOINTS,)</span>

<span class="s">                np.ndarray: Joint velocities, shape (NUM_JOINTS,)</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="n">robot</span><span class="p">.</span><span class="n">full_state</span>
</code></pre></div>

</details>
<h4 id="get_wrapper_attr_1">get_wrapper_attr</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_wrapper_attr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Any&#39;</span>
</code></pre></div>

<p>Gets the attribute <code>name</code> from the environment.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">get_wrapper_attr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">name</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">Any</span><span class="o">:</span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Gets the attribute `name` from the environment.</span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">name</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="render_1">render</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">render</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;RenderFrame | list[RenderFrame] | None&#39;</span>
</code></pre></div>

<p>Compute the render frames as specified by :attr:<code>render_mode</code> during the initialization of the environment.</p>
<p>The environment's :attr:<code>metadata</code> render modes (<code>env.metadata["render_modes"]</code>) should contain the possible
ways to implement the render modes. In addition, list versions for most render modes is achieved through
<code>gymnasium.make</code> which automatically applies a wrapper to collect rendered frames.</p>
<p>Note:
    As the :attr:<code>render_mode</code> is known during <code>__init__</code>, the objects used to render the environment state
    should be initialised in <code>__init__</code>.</p>
<p>By convention, if the :attr:<code>render_mode</code> is:</p>
<ul>
<li>None (default): no render is computed.</li>
<li>"human": The environment is continuously rendered in the current display or terminal, usually for human consumption.
  This rendering should occur during :meth:<code>step</code> and :meth:<code>render</code> doesn't need to be called. Returns <code>None</code>.</li>
<li>"rgb_array": Return a single frame representing the current state of the environment.
  A frame is a <code>np.ndarray</code> with shape <code>(x, y, 3)</code> representing RGB values for an x-by-y pixel image.</li>
<li>"ansi": Return a strings (<code>str</code>) or <code>StringIO.StringIO</code> containing a terminal-style text representation
  for each time step. The text can include newlines and ANSI escape sequences (e.g. for colors).</li>
<li>"rgb_array_list" and "ansi_list": List based version of render modes are possible (except Human) through the
  wrapper, :py:class:<code>gymnasium.wrappers.RenderCollection</code> that is automatically applied during <code>gymnasium.make(..., render_mode="rgb_array_list")</code>.
  The frames collected are popped after :meth:<code>render</code> is called or :meth:<code>reset</code>.</li>
</ul>
<p>Note:
    Make sure that your class's :attr:<code>metadata</code> <code>"render_modes"</code> key includes the list of supported modes.</p>
<p>.. versionchanged:: 0.25.0</p>
<div class="codehilite"><pre><span></span><code>The render function was changed to no longer accept parameters, rather these parameters should be specified
in the environment initialised, i.e., ``gymnasium.make(&quot;CartPole-v1&quot;, render_mode=&quot;human&quot;)``
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">RenderFrame</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">list</span><span class="err">[</span><span class="n">RenderFrame</span><span class="err">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">None</span><span class="o">:</span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Compute the render frames as specified by :attr:`render_mode` during the initialization of the environment.</span>

<span class="s2">        The environment&#39;s :attr:`metadata` render modes (`env.metadata[&quot;</span><span class="n">render_modes</span><span class="s2">&quot;]`) should contain the possible</span>

<span class="s2">        ways to implement the render modes. In addition, list versions for most render modes is achieved through</span>

<span class="s2">        `gymnasium.make` which automatically applies a wrapper to collect rendered frames.</span>

<span class="s2">        Note:</span>

<span class="s2">            As the :attr:`render_mode` is known during ``__init__``, the objects used to render the environment state</span>

<span class="s2">            should be initialised in ``__init__``.</span>

<span class="s2">        By convention, if the :attr:`render_mode` is:</span>

<span class="s2">        - None (default): no render is computed.</span>

<span class="s2">        - &quot;</span><span class="n">human</span><span class="s2">&quot;: The environment is continuously rendered in the current display or terminal, usually for human consumption.</span>

<span class="s2">          This rendering should occur during :meth:`step` and :meth:`render` doesn&#39;t need to be called. Returns ``None``.</span>

<span class="s2">        - &quot;</span><span class="n">rgb_array</span><span class="s2">&quot;: Return a single frame representing the current state of the environment.</span>

<span class="s2">          A frame is a ``np.ndarray`` with shape ``(x, y, 3)`` representing RGB values for an x-by-y pixel image.</span>

<span class="s2">        - &quot;</span><span class="n">ansi</span><span class="s2">&quot;: Return a strings (``str``) or ``StringIO.StringIO`` containing a terminal-style text representation</span>

<span class="s2">          for each time step. The text can include newlines and ANSI escape sequences (e.g. for colors).</span>

<span class="s2">        - &quot;</span><span class="n">rgb_array_list</span><span class="s2">&quot; and &quot;</span><span class="n">ansi_list</span><span class="s2">&quot;: List based version of render modes are possible (except Human) through the</span>

<span class="s2">          wrapper, :py:class:`gymnasium.wrappers.RenderCollection` that is automatically applied during ``gymnasium.make(..., render_mode=&quot;</span><span class="n">rgb_array_list</span><span class="s2">&quot;)``.</span>

<span class="s2">          The frames collected are popped after :meth:`render` is called or :meth:`reset`.</span>

<span class="s2">        Note:</span>

<span class="s2">            Make sure that your class&#39;s :attr:`metadata` ``&quot;</span><span class="n">render_modes</span><span class="s2">&quot;`` key includes the list of supported modes.</span>

<span class="s2">        .. versionchanged:: 0.25.0</span>

<span class="s2">            The render function was changed to no longer accept parameters, rather these parameters should be specified</span>

<span class="s2">            in the environment initialised, i.e., ``gymnasium.make(&quot;</span><span class="n">CartPole</span><span class="o">-</span><span class="n">v1</span><span class="s2">&quot;, render_mode=&quot;</span><span class="n">human</span><span class="s2">&quot;)``</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="n">raise</span><span class="w"> </span><span class="n">NotImplementedError</span>
</code></pre></div>

</details>
<h4 id="reset_1">reset</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">reset</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">~</span><span class="n">ObsType</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>
</code></pre></div>

<p>Resets the environment to an initial internal state, returning an initial observation and info.</p>
<p>This method generates a new starting state often with some randomness to ensure that the agent explores the
state space and learns a generalised policy about the environment. This randomness can be controlled
with the <code>seed</code> parameter otherwise if the environment already has a random number generator and
:meth:<code>reset</code> is called with <code>seed=None</code>, the RNG is not reset.</p>
<p>Therefore, :meth:<code>reset</code> should (in the typical use case) be called with a seed right after initialization and then never again.</p>
<p>For Custom environments, the first line of :meth:<code>reset</code> should be <code>super().reset(seed=seed)</code> which implements
the seeding correctly.</p>
<p>.. versionchanged:: v0.25</p>
<div class="codehilite"><pre><span></span><code><span class="n">The</span><span class="w"> </span><span class="n n-Quoted">``</span><span class="n">return_info</span><span class="n n-Quoted">``</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">removed</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">returned</span><span class="p">.</span>
</code></pre></div>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>seed</td>
<td>optional int</td>
<td>The seed that is used to initialize the environment's PRNG (<code>np_random</code>).<br>If the environment does not already have a PRNG and <code>seed=None</code> (the default option) is passed,<br>a seed will be chosen from some source of entropy (e.g. timestamp or /dev/urandom).<br>However, if the environment already has a PRNG and <code>seed=None</code> is passed, the PRNG will <em>not</em> be reset.<br>If you pass an integer, the PRNG will be reset even if it already exists.<br>Usually, you want to pass an integer <em>right after the environment has been initialized and then never again</em>.<br>Please refer to the minimal example above to see this paradigm in action.</td>
<td>None</td>
</tr>
<tr>
<td>options</td>
<td>optional dict</td>
<td>Additional information to specify how the environment is reset (optional,<br>depending on the specific environment)</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>observation (ObsType): Observation of the initial state. This will be an element of :attr:<code>observation_space</code><br>    (typically a numpy array) and is analogous to the observation returned by :meth:<code>step</code>.<br>info (dictionary):  This dictionary contains auxiliary information complementing <code>observation</code>. It should be analogous to<br>    the <code>info</code> returned by :meth:<code>step</code>.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">reset</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">seed</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"> </span><span class="nl">options</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">dict[str, Any</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">ObsType, dict[str, Any</span><span class="o">]</span><span class="err">]:</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Implementation</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="n">reset</span><span class="p">()</span><span class="err">:</span><span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="n">docstring</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Gym</span><span class="w"> </span><span class="n">states</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">reset</span><span class="p">()</span><span class="w"> </span><span class="k">method</span>

<span class="w">        </span><span class="n">super</span><span class="p">().</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_obs</span><span class="p">(),</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_info</span><span class="p">()</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Initial</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="n">observation</span>
</code></pre></div>

</details>
<h4 id="reset_bag_state">reset_bag_state</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">reset_bag_state</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Resets the dynamics of the bag in the environment</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>state</td>
<td>tuple[np.ndarray, ...]</td>
<td>Dynamics info of the bag, containing:<br>np.ndarray: Position, shape (3,)<br>np.ndarray: Orientation (XYZW quaternion), shape (4,)<br>np.ndarray: Linear velocity, shape (3,)<br>np.ndarray: Angular velocity, shape (3,)</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def reset_bag_state(self, state: tuple[np.ndarray, ...]) -&gt; None:

        &quot;&quot;&quot;Resets the dynamics of the bag in the environment

        Args:

            state (tuple[np.ndarray, ...]): Dynamics info of the bag, containing:

                np.ndarray: Position, shape (3,)

                np.ndarray: Orientation (XYZW quaternion), shape (4,)

                np.ndarray: Linear velocity, shape (3,)

                np.ndarray: Angular velocity, shape (3,)

        &quot;&quot;&quot;

        assert len(state) == 4

        assert len(state[0]) == 3

        assert len(state[1]) == 4

        assert len(state[2]) == 3

        assert len(state[3]) == 3

        self.bag.reset_dynamics(*state)
</code></pre></div>

</details>
<h4 id="reset_robot_state">reset_robot_state</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">reset_robot_state</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Fully resets the state of the Astrobee in the environment</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>state</td>
<td>tuple[np.ndarray, ...]</td>
<td>Full Astrobee state information containing:<br>np.ndarray: Position, shape (3,)<br>np.ndarray: Orientation (XYZW quaternion), shape (4,)<br>np.ndarray: Linear velocity, shape (3,)<br>np.ndarray: Angular velocity, shape (3,)<br>np.ndarray: Joint positions, shape (NUM_JOINTS,)<br>np.ndarray: Joint velocities, shape (NUM_JOINTS,)</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def reset_robot_state(self, state: tuple[np.ndarray, ...]) -&gt; None:

        &quot;&quot;&quot;Fully resets the state of the Astrobee in the environment

        Args:

            state (tuple[np.ndarray, ...]): Full Astrobee state information containing:

                np.ndarray: Position, shape (3,)

                np.ndarray: Orientation (XYZW quaternion), shape (4,)

                np.ndarray: Linear velocity, shape (3,)

                np.ndarray: Angular velocity, shape (3,)

                np.ndarray: Joint positions, shape (NUM_JOINTS,)

                np.ndarray: Joint velocities, shape (NUM_JOINTS,)

        &quot;&quot;&quot;

        assert len(state) == 6

        assert len(state[0]) == 3

        assert len(state[1]) == 4

        assert len(state[2]) == 3

        assert len(state[3]) == 3

        assert len(state[4]) == Astrobee.NUM_JOINTS

        assert len(state[5]) == Astrobee.NUM_JOINTS

        self.robot.reset_full_state(*state)
</code></pre></div>

</details>
<h4 id="restore_state_1">restore_state</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">restore_state</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Restores the simulation to a saved state file</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>filename</td>
<td>str</td>
<td>Path to a .bullet saved state within the saved state directory</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">restore_state</span><span class="p">(</span><span class="kr">self</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Restores the simulation to a saved state file</span>

<span class="s">        Args:</span>

<span class="s">            filename (str): Path to a .bullet saved state within the saved state directory</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="n">_check_state_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">restoreState</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="sample_trajectory">sample_trajectory</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">sample_trajectory</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Samples a trajectory about the nominal target.</p>
<ul>
<li>If the nominal_rollouts parameter is True for this environment, the final state of the trajectory will be
  exactly the nominal value (no noise added when sampling)</li>
<li>This should just be called in the vectorized rollout environments (not the main environment) since the main
  environment will use the best trajectory from the rollout envs</li>
</ul>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def sample_trajectory(self) -&gt; None:

        &quot;&quot;&quot;Samples a trajectory about the nominal target.

        <span class="k">-</span> If the nominal_rollouts parameter is True for this environment, the final state of the trajectory will be

          exactly the nominal value (no noise added when sampling)

        <span class="k">-</span> This should just be called in the vectorized rollout environments (not the main environment) since the main

          environment will use the best trajectory from the rollout envs

        &quot;&quot;&quot;

        if self.is_primary_simulation:

            raise ValueError(

                &quot;Trajectory sampling should only occur in one of parallel environments for evaluation purposes&quot;

            )

        pos, orn, vel, omega = self.robot.dynamics_state

        # Time sampling parameters (TODO refine these, move them somewhere else)

        time_stdev = 1

        # Note: ensure that this is a positive value post-sampling

        min_time = 1

        n_timesteps = round(self.planning_duration / self.dt)  # Nominal

        if self.flight_state == self.FlightStates.NOMINAL:

            end_state = (

                [

                    self.target_pos,

                    self.target_orn,

                    self.target_vel,

                    self.target_omega,

                    self.target_accel,

                    self.target_alpha,

                ]

                if self._nominal_rollouts

                else sample_state(

                    self.target_pos,

                    self.target_orn,

                    self.target_vel,

                    self.target_omega,

                    self.last_accel_cmd,

                    self.last_alpha_cmd,

                    self.pos_stdev,

                    self.orn_stdev,

                    self.vel_stdev,

                    self.ang_vel_stdev,

                    self.accel_stdev,

                    self.alpha_stdev,

                )

            )

            duration = self.target_duration

        elif self.flight_state == self.FlightStates.SLOWING:

            end_state = (

                [

                    self.target_pos,

                    self.target_orn,

                    self.target_vel,

                    self.target_omega,

                    self.target_accel,

                    self.target_alpha,

                ]

                if self._nominal_rollouts

                else sample_state(

                    self.target_pos,

                    self.target_orn,

                    self.target_vel,

                    self.target_omega,

                    self.last_accel_cmd,

                    self.last_alpha_cmd,

                    self.pos_stdev / 3,

                    self.orn_stdev / 3,

                    self.vel_stdev / 3,

                    self.ang_vel_stdev / 3,

                    self.accel_stdev / 3,

                    self.alpha_stdev / 3,

                )

            )

            duration = (

                self.target_duration

                if self._nominal_rollouts

                else np.maximum(

                    np.random.normal(self.target_duration, time_stdev), min_time

                )

            )

        elif self.flight_state == self.FlightStates.STOPPING:

            end_state = [

                self.target_pos,

                self.target_orn,

                self.target_vel,

                self.target_omega,

                self.target_accel,

                self.target_alpha,

            ]

            duration = (

                self.planning_duration

                if self._nominal_rollouts

                else np.maximum(

                    np.random.normal(self.planning_duration, time_stdev), min_time

                )

            )

        else:

            raise AttributeError(&quot;Flight state not recognized&quot;)

        traj = local_planner(

            pos,

            orn,

            vel,

            omega,

            self.last_accel_cmd,

            self.last_alpha_cmd,

            <span class="gs">*end_state,</span>

<span class="gs">            duration,</span>

<span class="gs">            self.dt,</span>

<span class="gs">        )</span>

<span class="gs">        if traj.num_timesteps == n_timesteps:</span>

<span class="gs">            self.traj_plan = traj</span>

<span class="gs">        else:</span>

<span class="gs">            # Traj is either too long or too short, so adjust it</span>

<span class="gs">            if traj.num_timesteps &gt; n_timesteps:</span>

<span class="gs">                self.traj_plan = traj.get_segment(0, n_timesteps)</span>

<span class="gs">            else:  # Less than</span>

<span class="gs">                # Create a trajectory at the stopped position for the remaining timesteps</span>

<span class="gs">                remaining_timesteps = n_timesteps - traj.num_timesteps</span>

<span class="gs">                stop_traj = Trajectory(</span>

<span class="gs">                    traj.positions[-1] *</span> np.ones((remaining_timesteps, 1)),

                    traj.quaternions[-1] <span class="gs">* np.ones((remaining_timesteps, 1)),</span>

<span class="gs">                    np.zeros((remaining_timesteps, 3)),</span>

<span class="gs">                    np.zeros((remaining_timesteps, 3)),</span>

<span class="gs">                    np.zeros((remaining_timesteps, 3)),</span>

<span class="gs">                    np.zeros((remaining_timesteps, 3)),</span>

<span class="gs">                    np.arange(remaining_timesteps) *</span> self.dt,

                )

                self.traj_plan = concatenate_trajs(traj, stop_traj)

        self.sampled_end_state = (

            self.traj_plan.positions[-1],

            self.traj_plan.quaternions[-1],

            self.traj_plan.linear_velocities[-1],

            self.traj_plan.angular_velocities[-1],

        )
</code></pre></div>

</details>
<h4 id="save_state_1">save_state</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</code></pre></div>

<p>Saves the current simulation state to disk</p>
<ul>
<li>Note: saved states are not currently overwritten (could lead to issues with parallel environments?). But,
  these can be cleared out at the end of the simulation period</li>
</ul>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>str</td>
<td>Path to the saved state file</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">save_state</span><span class="p">(</span><span class="kr">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">str</span><span class="o">:</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Ensure</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="kr">any</span><span class="w"> </span><span class="n">simulations</span><span class="w"> </span><span class="n">strictly</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">evaluating</span><span class="w"> </span><span class="n">rollouts</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">state</span>

<span class="w">        </span><span class="nf">if</span><span class="w"> </span><span class="kr">not</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="n">is_primary_simulation</span><span class="o">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">PermissionError</span><span class="p">(</span><span class="s">&quot;Only the primary simulation can save the state&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="n">super</span><span class="p">().</span><span class="n">save_state</span><span class="p">()</span>
</code></pre></div>

</details>
<h4 id="send_client_command_1">send_client_command</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">send_client_command</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span>
</code></pre></div>

<p>Send a command to the environment's pybullet client</p>
<p>For instance, we can use pybullet.getBasePositionAndOrientation with this as
send_client_command("getBasePositionAndOrientation", body_id)</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Any</td>
<td>The return from the Pybullet command</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def send_client_command(self, <span class="gs">*args, *</span>*kwargs) -&gt; Any:

        &quot;&quot;&quot;Send a command to the environment&#39;s pybullet client

        For instance, we can use pybullet.getBasePositionAndOrientation with this as

        send_client_command(&quot;getBasePositionAndOrientation&quot;, body_id)

        Returns:

            Any: The return from the Pybullet command

        &quot;&quot;&quot;

        attr = getattr(self.client, args[0])

        if isinstance(attr, Callable):

            return attr(*args[1:], **kwargs)

        return attr
</code></pre></div>

</details>
<h4 id="set_arm_traj">set_arm_traj</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">set_arm_traj</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">traj</span><span class="p">:</span> <span class="n">pyastrobee</span><span class="o">.</span><span class="n">trajectories</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">ArmTrajectory</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def set_arm_traj(self, traj: ArmTrajectory):  # TODO IMPROVE THIS

        self.arm_traj_plan = traj
</code></pre></div>

</details>
<h4 id="set_flight_state">set_flight_state</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">set_flight_state</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pyastrobee</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">environments</span><span class="o">.</span><span class="n">AstrobeeMPCEnv</span><span class="o">.</span><span class="n">FlightStates</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<p>Set the current flight state: for instance, whether we are in nominal operating mode, stopping, ...</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>state</td>
<td>Union[str, FlightStates]</td>
<td>A flight state or its string representation<br>(i.e. "nominal", "stopping", ...)</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def set_flight_state(self, state: Union[str, FlightStates]):

        &quot;&quot;&quot;Set the current flight state: for instance, whether we are in nominal operating mode, stopping, ...

        Args:

            state (Union[str, FlightStates]): A flight state or its string representation

                (i.e. &quot;nominal&quot;, &quot;stopping&quot;, ...)

        &quot;&quot;&quot;

        # TODO add check that it is valid

        # TODO should we store the state as the string or the Enum????

        if isinstance(state, str):

            self.flight_state = self.FlightStates(state)

        elif isinstance(state, self.FlightStates):

            self.flight_state = state

        else:

            raise ValueError(&quot;Flight state not recognized&quot;)
</code></pre></div>

</details>
<h4 id="set_planning_duration">set_planning_duration</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">set_planning_duration</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">duration</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def set_planning_duration(self, duration):  # TODO improve this

        self.planning_duration = duration
</code></pre></div>

</details>
<h4 id="set_target_state">set_target_state</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">set_target_state</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pos</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">orn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">vel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">omega</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">accel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Set the target dynamics state for planning/sampling trajectories and determining penalties</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>pos</td>
<td>npt.ArrayLike</td>
<td>Desired position, shape (3,)</td>
<td>None</td>
</tr>
<tr>
<td>orn</td>
<td>npt.ArrayLike</td>
<td>Desired XYZW quaternion orientation, shape (4,)</td>
<td>None</td>
</tr>
<tr>
<td>vel</td>
<td>npt.ArrayLike</td>
<td>Desired linear velocity, shape (3,)</td>
<td>None</td>
</tr>
<tr>
<td>omega</td>
<td>npt.ArrayLike</td>
<td>Desired angular velocity, shape (3,)</td>
<td>None</td>
</tr>
<tr>
<td>accel</td>
<td>npt.ArrayLike</td>
<td>Desired linear acceleration, shape (3,)</td>
<td>None</td>
</tr>
<tr>
<td>alpha</td>
<td>npt.ArrayLike</td>
<td>Desired angular acceleration, shape (3,)</td>
<td>None</td>
</tr>
<tr>
<td>duration</td>
<td>float</td>
<td>Amount of time to pass before achieving this desired state</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">set_target_state</span><span class="p">(</span>

<span class="w">        </span><span class="kr">self</span><span class="p">,</span>

<span class="w">        </span><span class="n">pos</span><span class="o">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">orn</span><span class="o">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">vel</span><span class="o">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">omega</span><span class="o">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">accel</span><span class="o">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">alpha</span><span class="o">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">float</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Set the target dynamics state for planning/sampling trajectories and determining penalties</span>

<span class="s">        Args:</span>

<span class="s">            pos (npt.ArrayLike): Desired position, shape (3,)</span>

<span class="s">            orn (npt.ArrayLike): Desired XYZW quaternion orientation, shape (4,)</span>

<span class="s">            vel (npt.ArrayLike): Desired linear velocity, shape (3,)</span>

<span class="s">            omega (npt.ArrayLike): Desired angular velocity, shape (3,)</span>

<span class="s">            accel (npt.ArrayLike): Desired linear acceleration, shape (3,)</span>

<span class="s">            alpha (npt.ArrayLike): Desired angular acceleration, shape (3,)</span>

<span class="s">            duration (float): Amount of time to pass before achieving this desired state</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">target_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">target_orn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orn</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">target_vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vel</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">target_omega</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omega</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">target_accel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accel</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">target_alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">target_duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration</span>
</code></pre></div>

</details>
<h4 id="show_traj_plan">show_traj_plan</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">show_traj_plan</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Displays the planned trajectory on the current pybullet client GUI (if enabled)</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>Optional[int]</td>
<td>Number of frames to plot, if plotting all of the frames is not desired.<br>Defaults to None (plot all frames)</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">show_traj_plan</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">n</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Displays the planned trajectory on the current pybullet client GUI (if enabled)</span>

<span class="ss">        Args:</span>

<span class="ss">            n (Optional[int]): Number of frames to plot, if plotting all of the frames is not desired.</span>

<span class="ss">                Defaults to None (plot all frames)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">traj_plan</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;No trajectory available to visualize&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">debug_viz_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">traj_plan</span><span class="p">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="step_1">step</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">action</span><span class="p">:</span> <span class="o">~</span><span class="n">ActType</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">~</span><span class="n">ObsType</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>
</code></pre></div>

<p>Run one timestep of the environment's dynamics using the agent actions.</p>
<p>When the end of an episode is reached (<code>terminated or truncated</code>), it is necessary to call :meth:<code>reset</code> to
reset this environment's state for the next episode.</p>
<p>.. versionchanged:: 0.26</p>
<div class="codehilite"><pre><span></span><code><span class="n">The</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="k">changed</span><span class="w"> </span><span class="n">removing</span><span class="w"> </span><span class="n n-Quoted">``</span><span class="n">done</span><span class="n n-Quoted">``</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">favor</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n n-Quoted">``</span><span class="k">terminated</span><span class="n n-Quoted">``</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n n-Quoted">``</span><span class="n">truncated</span><span class="n n-Quoted">``</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">clearer</span>
<span class="k">to</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">had</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">truncated</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">reinforcement</span><span class="w"> </span><span class="n">learning</span>
<span class="n">bootstrapping</span><span class="w"> </span><span class="n">algorithms</span><span class="p">.</span>
</code></pre></div>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>action</td>
<td>ActType</td>
<td>an action provided by the agent to update the environment state.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>observation (ObsType): An element of the environment's :attr:<code>observation_space</code> as the next observation due to the agent actions.<br>    An example is a numpy array containing the positions and velocities of the pole in CartPole.<br>reward (SupportsFloat): The reward as a result of taking the action.<br>terminated (bool): Whether the agent reaches the terminal state (as defined under the MDP of the task)<br>    which can be positive or negative. An example is reaching the goal state or moving into the lava from<br>    the Sutton and Barton, Gridworld. If true, the user needs to call :meth:<code>reset</code>.<br>truncated (bool): Whether the truncation condition outside the scope of the MDP is satisfied.<br>    Typically, this is a timelimit, but could also be used to indicate an agent physically going out of bounds.<br>    Can be used to end the episode prematurely before a terminal state is reached.<br>    If true, the user needs to call :meth:<code>reset</code>.<br>info (dict): Contains auxiliary diagnostic information (helpful for debugging, learning, and logging).<br>    This might, for instance, contain: metrics that describe the agent's performance state, variables that are<br>    hidden from observations, or individual reward terms that are combined to produce the total reward.<br>    In OpenAI Gym &lt;v26, it contains "TimeLimit.truncated" to distinguish truncation and termination,<br>    however this is deprecated in favour of returning terminated and truncated variables.<br>done (bool): (Deprecated) A boolean value for if the episode has ended, in which case further :meth:<code>step</code> calls will<br>    return undefined results. This was removed in OpenAI Gym v26 in favor of terminated and truncated attributes.<br>    A done signal may be emitted for different reasons: Maybe the task underlying the environment was solved successfully,<br>    a certain timelimit was exceeded, or the physics simulation has entered an invalid state.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def step(

        self, action: ActType

    ) -&gt; tuple[ObsType, float, bool, bool, dict[str, Any]]:

        # Note: For MPC, this is less so a &quot;step&quot; than a &quot;rollout&quot; function. The trajectory should be sampled

        #       before calling this function

        # TODO use the action parameter to pass in a trajectory to follow?

        terminated = False  # init (If at the terminal state)

        truncated = False  # init (If stopping the sim before the terminal state)

        if self.traj_plan is None:

            raise ValueError(&quot;Trajectory has not been planned&quot;)

        # Follow the trajectory. NOTE: This is effectively the same as the follow_traj() function in the controller,

        # but accessing the loop directly allows us to do more with the data at each step

        # TODO decide how to handle the stopping criteria

        if not self.traj_plan.num_timesteps == self.arm_traj_plan.num_timesteps:

            raise ValueError(&quot;Mismatched time info between base and arm trajs&quot;)

        # If this is the primary simulation, we just follow the best trajectory we have

        # Rewrd for the primary simulation doesn&#39;t mean anything, so no computation needed

        inertia_update_freq = 5

        steps_per_inertia_update = round(

            1 / (self.traj_plan.timestep <span class="gs">* inertia_update_freq)</span>

<span class="gs">        )</span>

<span class="gs">        if self.is_primary_simulation:</span>

<span class="gs">            for i in range(self.traj_plan.num_timesteps):</span>

<span class="gs">                pos, orn, lin_vel, ang_vel = self.controller.get_current_state()</span>

<span class="gs">                self.controller.step(</span>

<span class="gs">                    pos,</span>

<span class="gs">                    lin_vel,</span>

<span class="gs">                    orn,</span>

<span class="gs">                    ang_vel,</span>

<span class="gs">                    self.traj_plan.positions[i, :],</span>

<span class="gs">                    self.traj_plan.linear_velocities[i, :],</span>

<span class="gs">                    self.traj_plan.linear_accels[i, :],</span>

<span class="gs">                    self.traj_plan.quaternions[i, :],</span>

<span class="gs">                    self.traj_plan.angular_velocities[i, :],</span>

<span class="gs">                    self.traj_plan.angular_accels[i, :],</span>

<span class="gs">                )</span>

<span class="gs">                self.robot.set_joint_angles(</span>

<span class="gs">                    self.arm_traj_plan.angles[i, :], self.arm_traj_plan.joint_ids</span>

<span class="gs">                )</span>

<span class="gs">                # TODO THIS KINDA SUCKS</span>

<span class="gs">                if i % steps_per_inertia_update == 0:</span>

<span class="gs">                    T_R2W = self.robot.tmat</span>

<span class="gs">                    T_B2W = self.bag.tmat</span>

<span class="gs">                    T_B2R = invert_transform_mat(T_R2W) @ T_B2W</span>

<span class="gs">                    p = T_B2R[:3, 3]</span>

<span class="gs">                    self.controller.inertia = self.robot.inertia + self.bag.mass *</span> (

                        np.dot(p, p) <span class="gs">* np.eye(3) - np.outer(p, p)</span>

<span class="gs">                    )</span>

<span class="gs">            reward = 0</span>

<span class="gs">        else:</span>

<span class="gs">            # We are in a rollout environment</span>

<span class="gs">            # So, follow the trajectory, but also keep track of a bunch of things so that we can compute the reward</span>

<span class="gs">            robot_safe_set_cost = 0  # init</span>

<span class="gs">            bag_safe_set_cost = 0  # init</span>

<span class="gs">            stabilization_cost = 0</span>

<span class="gs">            tracking_cost = 0</span>

<span class="gs">            bag_vel_cost = 0</span>

<span class="gs">            steps_per_safe_set_eval = round(</span>

<span class="gs">                1 / (self.traj_plan.timestep *</span> self.safe_set_eval_freq)

            )

            # TODO IMPROVE THIS

            # the thought here was that if we&#39;re stopping (or slowing) we care more about the overall positioning

            # rather than just staying in the middle of the modules

            safe_set_weight = (

                1 if self.flight_state == self.FlightStates.NOMINAL else 0.1

            )

            for i in range(self.traj_plan.num_timesteps):

                # Note: the traj log gets updated whenever we access the current state

                pos, orn, lin_vel, ang_vel = self.controller.get_current_state()

                self.controller.step(

                    pos,

                    lin_vel,

                    orn,

                    ang_vel,

                    self.traj_plan.positions[i, :],

                    self.traj_plan.linear_velocities[i, :],

                    self.traj_plan.linear_accels[i, :],

                    self.traj_plan.quaternions[i, :],

                    self.traj_plan.angular_velocities[i, :],

                    self.traj_plan.angular_accels[i, :],

                )

                self.robot.set_joint_angles(

                    self.arm_traj_plan.angles[i, :], self.arm_traj_plan.joint_ids

                )

                # TODO THIS KINDA SUCKS

                if i % steps_per_inertia_update == 0:

                    T_R2W = self.robot.tmat

                    T_B2W = self.bag.tmat

                    T_B2R = invert_transform_mat(T_R2W) @ T_B2W

                    p = T_B2R[:3, 3]

                    self.controller.inertia = self.robot.inertia + self.bag.mass <span class="gs">* (</span>

<span class="gs">                        np.dot(p, p) *</span> np.eye(3) - np.outer(p, p)

                    )

                # *** COST FUNCTION ***

                # Perform collision checking on every timestep

                robot_bb = self.robot.bounding_box

                bag_bb = self.bag.bounding_box

                robot_is_safe = check_box_containment(robot_bb, self.safe_set.values())

                bag_is_safe = check_box_containment(bag_bb, self.safe_set.values())

                # If either the robot or bag collided, stop the simulation and return an effectively infinite cost

                # (Very large but not infinity to maintain sorting order in the edge case that all rollouts collide)

                if not robot_is_safe:

                    robot_safe_set_cost += 10000

                    truncated = True

                    # break

                if not bag_is_safe:

                    bag_safe_set_cost += 10000

                    truncated = True

                    # break

                # These &quot;stay away from the walls&quot; costs are somewhat expensive to compute and don&#39;t necessarily need

                # to be done every timestep. TODO just use the local description of the safe set, not the full thing

                if i % steps_per_safe_set_eval == 0:

                    robot_safe_set_cost += safe_set_weight <span class="gs">* safe_set_cost(</span>

<span class="gs">                        robot_bb[0], self.safe_set.values()</span>

<span class="gs">                    )</span>

<span class="gs">                    robot_safe_set_cost += safe_set_weight *</span> safe_set_cost(

                        robot_bb[1], self.safe_set.values()

                    )

                    bag_safe_set_cost += safe_set_weight <span class="gs">* safe_set_cost(</span>

<span class="gs">                        bag_bb[0], self.safe_set.values()</span>

<span class="gs">                    )</span>

<span class="gs">                    bag_safe_set_cost += safe_set_weight *</span> safe_set_cost(

                        bag_bb[1], self.safe_set.values()

                    )

            bag_pos, bag_orn, bag_vel, bag_ang_vel = self.bag.dynamics_state

            # Penalizing bag velocities perpendicular to the robot&#39;s velocity at end of rollout

            if self.flight_state == self.FlightStates.NOMINAL:

                bag_vel_cost = 300 <span class="gs">* (</span>

<span class="gs">                    np.linalg.norm(bag_vel)</span>

<span class="gs">                    - np.dot(lin_vel / np.linalg.norm(lin_vel), bag_vel)</span>

<span class="gs">                )</span>

<span class="gs">            # End-of-rollout additional cost function evaluations</span>

<span class="gs">            # 1) Stabilize the motion of the bag with respect to the robot</span>

<span class="gs">            # 2) Position the robot so it&#39;s stopped at the goal pose</span>

<span class="gs">            # Both of these are only relevant when we&#39;re at the end of the nominal trajectory</span>

<span class="gs">            # TODO tune all of the scaling factors on the costs</span>

<span class="gs">            if self.flight_state == self.FlightStates.STOPPING:</span>

<span class="gs">                angular_term = np.linalg.norm(ang_vel - bag_ang_vel)</span>

<span class="gs">                r_r2b = bag_pos - pos  # Vector from robot to bag</span>

<span class="gs">                linear_term = np.linalg.norm(</span>

<span class="gs">                    lin_vel - bag_vel + np.cross(ang_vel, r_r2b)</span>

<span class="gs">                )</span>

<span class="gs">                stabilization_cost += 500 *</span> (linear_term + angular_term)

                # TODO make this a separate function?

                # Adding back in a tracking cost component

                # If we are stopping then we know that the target state is the goal

                pos_error = np.linalg.norm(pos - self.target_pos)

                orn_error = quaternion_dist(orn, self.target_orn)

                vel_error = np.linalg.norm(lin_vel - self.target_vel)

                ang_vel_error = np.linalg.norm(ang_vel - self.target_omega)

                if self.is_debugging_simulation:

                    print(&quot;Position error: &quot;, pos_error)

                    print(&quot;Orn error: &quot;, orn_error)

                    print(&quot;Vel error: &quot;, vel_error)

                    print(&quot;Ang vel error: &quot;, ang_vel_error)

                tracking_cost += (

                    200 <span class="gs">* pos_error</span>

<span class="gs">                    + 100 *</span> orn_error

                    + 200 <span class="gs">* vel_error</span>

<span class="gs">                    + 100 *</span> ang_vel_error

                )

            else:

                stabilization_cost = 0

                tracking_cost = 0

            if self.is_debugging_simulation:

                print(&quot;Robot safe set cost: &quot;, robot_safe_set_cost)

                print(&quot;Bag safe set cost: &quot;, bag_safe_set_cost)

                print(&quot;Stabilization cost: &quot;, stabilization_cost)

                print(&quot;Tracking cost: &quot;, tracking_cost)

                print(&quot;Bag velocity cost: &quot;, bag_vel_cost)

            reward = -1 * (

                robot_safe_set_cost

                + bag_safe_set_cost

                + stabilization_cost

                + tracking_cost

                + bag_vel_cost

            )

        # Observe the robot/bag state in the main env, dummy value if in rollout env

        observation = self._get_obs()

        # Evaluate if we have stabilized the robot and the bag at the end of the trajectory

        # (main env only since that&#39;s what we care about and we don&#39;t want to waste compute)

        if (

            self.flight_state == self.FlightStates.STOPPING

            and self.is_primary_simulation

            and robot_and_bag_termination_criteria(

                observation[0], observation[1], self.goal_pose

            )

        ):

            terminated = True

        # TODO: If we change the observation function to return the state of the robot and the bag,

        # we can determine the &quot;terminated&quot; parameter!

        # But note that we should only really do the observation in the main env

        info = self._get_info()

        return observation, reward, terminated, truncated, info
</code></pre></div>

</details>
<h4 id="step_simulation_1">step_simulation</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">step_simulation</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>Single pybullet simulation step</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def step_simulation(self):

        &quot;&quot;&quot;Single pybullet simulation step&quot;&quot;&quot;

        self.client.stepSimulation()
</code></pre></div>

</details>
<h4 id="unshow_traj_plan">unshow_traj_plan</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">unshow_traj_plan</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Removes a displayed trajectory from the pybullet client GUI</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">unshow_traj_plan</span><span class="p">(</span><span class="kr">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;Removes a displayed trajectory from the pybullet client GUI&quot;&quot;&quot;</span>

<span class="w">        </span><span class="nf">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="kr">self</span><span class="p">.</span><span class="n">debug_viz_ids</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span>

<span class="w">            </span><span class="kr">return</span>

<span class="w">        </span><span class="n">remove_debug_objects</span><span class="p">(</span><span class="kr">self</span><span class="p">.</span><span class="n">debug_viz_ids</span><span class="p">,</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>

<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="n">debug_viz_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span>
</code></pre></div>

</details>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        
<footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../deformable_bag/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Deformable Bag" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                Deformable Bag
              </div>
            </div>
          </a>
        
        
          
          <a href="../hybrid_bag/" class="md-footer__link md-footer__link--next" aria-label="Next: Hybrid Bag" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Hybrid Bag
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
            
            Powered by
            <a href="http://timothycrosley.github.io/portray">portray.</a>
            You too can
            <a href="http://timothycrosley.github.io/portray">
              portray</a>
            your Python project well using automatic documentation.
          </div>
        
      </div>
    </div>
  </footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>