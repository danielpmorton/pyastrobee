
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.4">
    
    
      
        <title>Pid - pyastrobee</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.80dcb947.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue-grey" data-md-color-accent="pink">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-pyastrobeecontrolpid" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="pyastrobee" class="md-header__button md-logo" aria-label="pyastrobee" data-md-component="logo">
      
  <img src="../../../../images/favicon_large.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pyastrobee
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pid
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/danielpmorton/pyastrobee" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    pyastrobee
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="pyastrobee" class="md-nav__button md-logo" aria-label="pyastrobee" data-md-component="logo">
      
  <img src="../../../../images/favicon_large.png" alt="logo">

    </a>
    pyastrobee
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/danielpmorton/pyastrobee" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    pyastrobee
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/additional_installs/" class="md-nav__link">
        Additional Installs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/bag_dynamics/" class="md-nav__link">
        Bag Dynamics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/getting_started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/loading_iss_meshes/" class="md-nav__link">
        Loading Iss Meshes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/meshing/" class="md-nav__link">
        Meshing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/nasa_sim/" class="md-nav__link">
        Nasa Sim
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/pybullet_tips/" class="md-nav__link">
        Pybullet Tips
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/retexturing/" class="md-nav__link">
        Retexturing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/tet_meshing/" class="md-nav__link">
        Tet Meshing
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14" type="checkbox" id="__nav_14" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_14">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1" type="checkbox" id="__nav_14_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_14_1">
          Pyastrobee
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pyastrobee" data-md-level="2">
        <label class="md-nav__title" for="__nav_14_1">
          <span class="md-nav__icon md-icon"></span>
          Pyastrobee
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_2" type="checkbox" id="__nav_14_1_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_14_1_2">
          Config
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Config" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_2">
          <span class="md-nav__icon md-icon"></span>
          Config
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/astrobee_geom/" class="md-nav__link">
        Astrobee Geom
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/astrobee_motion/" class="md-nav__link">
        Astrobee Motion
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/astrobee_transforms/" class="md-nav__link">
        Astrobee Transforms
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/bag_properties/" class="md-nav__link">
        Bag Properties
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/iss_paths/" class="md-nav__link">
        Iss Paths
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../config/iss_safe_boxes/" class="md-nav__link">
        Iss Safe Boxes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_3" type="checkbox" id="__nav_14_1_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_14_1_3">
          Control
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Control" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_3">
          <span class="md-nav__icon md-icon"></span>
          Control
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../attitude_dynamics/" class="md-nav__link">
        Attitude Dynamics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../controller/" class="md-nav__link">
        Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cost_functions/" class="md-nav__link">
        Cost Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dlqr_test/" class="md-nav__link">
        Dlqr Test
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../force_torque_control/" class="md-nav__link">
        Force Torque Control
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../keyboard_controller/" class="md-nav__link">
        Keyboard Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mpc/" class="md-nav__link">
        Mpc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../multi_robot/" class="md-nav__link">
        Multi Robot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../operational_space_control/" class="md-nav__link">
        Operational Space Control
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../parallel_mpc/" class="md-nav__link">
        Parallel Mpc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../physics_models/" class="md-nav__link">
        Physics Models
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Pid
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Pid
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plot_controller_history" class="md-nav__link">
    plot_controller_history
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pid" class="md-nav__link">
    PID
  </a>
  
    <nav class="md-nav" aria-label="PID">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instance-variables" class="md-nav__link">
    Instance variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset" class="md-nav__link">
    reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_gains" class="md-nav__link">
    set_gains
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update" class="md-nav__link">
    update
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_4" type="checkbox" id="__nav_14_1_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_14_1_4">
          Core
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Core" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_4">
          <span class="md-nav__icon md-icon"></span>
          Core
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/abstract_bag/" class="md-nav__link">
        Abstract Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/astrobee/" class="md-nav__link">
        Astrobee
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/composite_bag/" class="md-nav__link">
        Composite Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/constraint_bag/" class="md-nav__link">
        Constraint Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/deformable_bag/" class="md-nav__link">
        Deformable Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/environments/" class="md-nav__link">
        Environments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/hybrid_bag/" class="md-nav__link">
        Hybrid Bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/iss/" class="md-nav__link">
        Iss
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/rigid_bag/" class="md-nav__link">
        Rigid Bag
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_5" type="checkbox" id="__nav_14_1_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_14_1_5">
          Trajectories
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Trajectories" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_5">
          <span class="md-nav__icon md-icon"></span>
          Trajectories
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/arm_planner/" class="md-nav__link">
        Arm Planner
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/bezier/" class="md-nav__link">
        Bezier
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/bezier_slerp/" class="md-nav__link">
        Bezier Slerp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/box_paths/" class="md-nav__link">
        Box Paths
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/curve_utils/" class="md-nav__link">
        Curve Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/decasteljau_slerp/" class="md-nav__link">
        Decasteljau Slerp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/face_forward/" class="md-nav__link">
        Face Forward
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/multi_robot_trajs/" class="md-nav__link">
        Multi Robot Trajs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/planner/" class="md-nav__link">
        Planner
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/polynomials/" class="md-nav__link">
        Polynomials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/quaternion_interpolation/" class="md-nav__link">
        Quaternion Interpolation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/sampling/" class="md-nav__link">
        Sampling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/simple_trajectories/" class="md-nav__link">
        Simple Trajectories
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/splines/" class="md-nav__link">
        Splines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/timing/" class="md-nav__link">
        Timing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/trajectory/" class="md-nav__link">
        Trajectory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectories/variable_time_curves/" class="md-nav__link">
        Variable Time Curves
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_6" type="checkbox" id="__nav_14_1_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_14_1_6">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_6">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/algos/" class="md-nav__link">
        Algos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/bag_frame/" class="md-nav__link">
        Bag Frame
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/boxes/" class="md-nav__link">
        Boxes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/bullet_utils/" class="md-nav__link">
        Bullet Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/camera_utils/" class="md-nav__link">
        Camera Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/coordinates/" class="md-nav__link">
        Coordinates
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/debug_visualizer/" class="md-nav__link">
        Debug Visualizer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/dynamics/" class="md-nav__link">
        Dynamics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/math_utils/" class="md-nav__link">
        Math Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/mesh_utils/" class="md-nav__link">
        Mesh Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/plotting/" class="md-nav__link">
        Plotting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/poses/" class="md-nav__link">
        Poses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/process_camera/" class="md-nav__link">
        Process Camera
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/python_utils/" class="md-nav__link">
        Python Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/quaternion_class/" class="md-nav__link">
        Quaternion Class
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/quaternion_derivatives/" class="md-nav__link">
        Quaternion Derivatives
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/quaternions/" class="md-nav__link">
        Quaternions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/rotations/" class="md-nav__link">
        Rotations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/transformations/" class="md-nav__link">
        Transformations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/video_concatenation/" class="md-nav__link">
        Video Concatenation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_7" type="checkbox" id="__nav_14_1_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_14_1_7">
          Vision
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Vision" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_7">
          <span class="md-nav__icon md-icon"></span>
          Vision
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vision/camera/" class="md-nav__link">
        Camera
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vision/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plot_controller_history" class="md-nav__link">
    plot_controller_history
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pid" class="md-nav__link">
    PID
  </a>
  
    <nav class="md-nav" aria-label="PID">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instance-variables" class="md-nav__link">
    Instance variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset" class="md-nav__link">
    reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_gains" class="md-nav__link">
    set_gains
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update" class="md-nav__link">
    update
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/danielpmorton/pyastrobee/edit/main/reference/pyastrobee/control/pid.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="module-pyastrobeecontrolpid">Module pyastrobee.control.pid</h1>
<p>An extended version of a PID controller compatible with multivariate systems</p>
<p>Based on pid.cpp (c) 2008, Willow Garage, Inc. (BSD License)
as well as Nathan Sprague's Python translation</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="sd">&quot;&quot;&quot;An extended version of a PID controller compatible with multivariate systems</span>

<span class="sd">Based on pid.cpp (c) 2008, Willow Garage, Inc. (BSD License)</span>

<span class="sd">as well as Nathan Sprague&#39;s Python translation</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># TODO decide if negative gains could actually be possible in the coupled case</span>

<span class="c1"># TODO determine how to handle coupled gains in the integral case</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">numpy.typing</span> <span class="k">as</span> <span class="nn">npt</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">pyastrobee.utils.math_utils</span> <span class="kn">import</span> <span class="n">is_diagonal</span><span class="p">,</span> <span class="n">safe_divide</span>

<span class="kn">from</span> <span class="nn">pyastrobee.utils.plotting</span> <span class="kn">import</span> <span class="n">num_subplots_to_shape</span>

<span class="k">class</span> <span class="nc">PID</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extended version of a PID controller compatible with multivariate systems</span>

<span class="sd">    This class implements the standard pid equation:</span>

<span class="sd">    $command = p_{term} + i_{term} + d_{term} $</span>

<span class="sd">    where:</span>

<span class="sd">    $ p_{term} = p_{gain} * p_{error} $</span>

<span class="sd">    $ i_{term} = i_{gain} * i_{error} $</span>

<span class="sd">    $ d_{term} = d_{gain} * d_{error} $</span>

<span class="sd">    $ i_{error} = i_{error} + p_{error} * dt $</span>

<span class="sd">    $ d_{error} = (p_{error} - p_{error last}) / dt $</span>

<span class="sd">    given:</span>

<span class="sd">    $ p_{error} = p_{target} - p_{state} $.</span>

<span class="sd">    - For a SISO system, pass in the gains as scalars</span>

<span class="sd">    - For a decoupled MIMO system, pass in the gains as lists, 1d arrays, or diagonal matrices</span>

<span class="sd">    - For a general MIMO system, pass in the gains as matrices</span>

<span class="sd">    - Integral limits are scalar for SISO, 1d array for MIMO.</span>

<span class="sd">    Args:</span>

<span class="sd">        p_gain (npt.ArrayLike): Proportional gain(s).</span>

<span class="sd">        i_gain (npt.ArrayLike): Integral gain(s).</span>

<span class="sd">        d_gain (npt.ArrayLike): Derivative gain(s).</span>

<span class="sd">        i_min (Optional[npt.ArrayLike]): Minimum value(s) for the integral term(s).</span>

<span class="sd">            Defaults to None, in which case the integral term(s) will be unbounded below</span>

<span class="sd">        i_max (Optional[npt.ArrayLike]): Maximum value(s) for the integral term(s).</span>

<span class="sd">            Defaults to None, in which case the integral term(s) will be unbounded above</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>

        <span class="bp">self</span><span class="p">,</span>

        <span class="n">p_gain</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

        <span class="n">i_gain</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

        <span class="n">d_gain</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

        <span class="n">i_min</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">i_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="p">):</span>

        <span class="c1"># Use the proportional gain as our baseline for comparison</span>

        <span class="c1"># Calculate some shapes/sizes to help distinguish between scalar/array/matrix methods</span>

        <span class="n">reference_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">atleast_1d</span><span class="p">(</span><span class="n">p_gain</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gain_shape</span> <span class="o">=</span> <span class="n">reference_gain</span><span class="o">.</span><span class="kp">shape</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gain_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">using_gain_matrices</span> <span class="o">=</span> <span class="n">reference_gain</span><span class="o">.</span><span class="kp">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_gains</span><span class="p">(</span><span class="n">p_gain</span><span class="p">,</span> <span class="n">i_gain</span><span class="p">,</span> <span class="n">d_gain</span><span class="p">,</span> <span class="n">i_min</span><span class="p">,</span> <span class="n">i_max</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the state of the PID controller&quot;&quot;&quot;</span>

        <span class="c1"># Save position state for derivative state calculation</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_p_error_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_p_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># Proportional error.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_d_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># Derivative error.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_i_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># Integator error.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cmd</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># Command to send.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_last_time</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Used for automatic calculation of dt.</span>

    <span class="k">def</span> <span class="nf">set_gains</span><span class="p">(</span>

        <span class="bp">self</span><span class="p">,</span>

        <span class="n">p_gain</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

        <span class="n">i_gain</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

        <span class="n">d_gain</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>

        <span class="n">i_min</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">i_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the PID gains for the controller.</span>

<span class="sd">        Gains are scalar for SISO, 1d array for decoupled MIMO, matrix for general MIMO</span>

<span class="sd">        Integral limits are scalar for SISO, 1d array for MIMO.</span>

<span class="sd">        Args:</span>

<span class="sd">            p_gain (npt.ArrayLike): Proportional gain(s).</span>

<span class="sd">            i_gain (npt.ArrayLike): Integral gain(s).</span>

<span class="sd">            d_gain (npt.ArrayLike): Derivative gain(s).</span>

<span class="sd">            i_min (Optional[npt.ArrayLike]): Minimum value(s) for the integral term(s).</span>

<span class="sd">                Defaults to None, in which case the integral term(s) will be unbounded below</span>

<span class="sd">            i_max (Optional[npt.ArrayLike]): Maximum value(s) for the integral term(s).</span>

<span class="sd">                Defaults to None, in which case the integral term(s) will be unbounded above</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Call the setter functions, which will auto-validate the inputs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p_gain</span> <span class="o">=</span> <span class="n">p_gain</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">i_gain</span> <span class="o">=</span> <span class="n">i_gain</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">d_gain</span> <span class="o">=</span> <span class="n">d_gain</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">i_min</span> <span class="o">=</span> <span class="n">i_min</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">i_max</span> <span class="o">=</span> <span class="n">i_max</span>

    <span class="nd">@property</span>

    <span class="k">def</span> <span class="nf">p_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Proportional gain(s)&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_gain</span>

    <span class="nd">@property</span>

    <span class="k">def</span> <span class="nf">i_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Integral gain(s)&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_gain</span>

    <span class="nd">@property</span>

    <span class="k">def</span> <span class="nf">d_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Derivative gain(s)&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_gain</span>

    <span class="nd">@property</span>

    <span class="k">def</span> <span class="nf">i_max</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Maximum value(s) of the integral term(s)&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_max</span>

    <span class="nd">@property</span>

    <span class="k">def</span> <span class="nf">i_min</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Minimum value(s) of the integral term(s)&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_min</span>

    <span class="k">def</span> <span class="nf">_validate_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gain</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensures that the gain(s) are the correct shape and are nonnegative (raises an error otherwise)</span>

<span class="sd">        Args:</span>

<span class="sd">            gain (npt.ArrayLike): P, I, or D gain(s)</span>

<span class="sd">        Returns:</span>

<span class="sd">            np.ndarray: Validated gain(s)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">atleast_1d</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gain</span><span class="o">.</span><span class="kp">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gain_shape</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>

                <span class="sa">f</span><span class="s2">&quot;Shape mismatch: Expected gain to have shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_gain_shape</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">gain</span><span class="o">.</span><span class="kp">shape</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="kp">any</span><span class="p">(</span><span class="n">gain</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Negative gains will cause instability.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">{</span><span class="n">gain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gain</span>

    <span class="k">def</span> <span class="nf">_validate_integral_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensures that the integral term limit(s) are the correct shape (raises an error otherwise)</span>

<span class="sd">        Args:</span>

<span class="sd">            lim (npt.ArrayLike): Limit(s) (minimum or maximum) on the integral term(s)</span>

<span class="sd">        Returns:</span>

<span class="sd">            np.ndarray: Validated limit(s)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">atleast_1d</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>

                <span class="sa">f</span><span class="s2">&quot;Invalid integral limit.</span><span class="se">\n</span><span class="s2">Expected an array of length </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">lim</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="p">)</span>

        <span class="k">return</span> <span class="n">lim</span>

    <span class="nd">@p_gain</span><span class="o">.</span><span class="n">setter</span>

    <span class="k">def</span> <span class="nf">p_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gain</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">):</span>

        <span class="n">gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_gain</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_p_gain</span> <span class="o">=</span> <span class="n">gain</span>

    <span class="nd">@i_gain</span><span class="o">.</span><span class="n">setter</span>

    <span class="k">def</span> <span class="nf">i_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gain</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">):</span>

        <span class="n">gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_gain</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_gain_matrices</span><span class="p">:</span>

            <span class="c1"># Extra logic to ensure that the gain matrix is diagonal (decoupled) because</span>

            <span class="c1"># determining the integral saturation for this case requires some more work</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_diagonal</span><span class="p">(</span><span class="n">gain</span><span class="p">):</span>

                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>

                    <span class="s2">&quot;Coupling between the integral gains is not currently supported&quot;</span>

                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_i_gain</span> <span class="o">=</span> <span class="n">gain</span>

    <span class="nd">@d_gain</span><span class="o">.</span><span class="n">setter</span>

    <span class="k">def</span> <span class="nf">d_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gain</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">):</span>

        <span class="n">gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_gain</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_d_gain</span> <span class="o">=</span> <span class="n">gain</span>

    <span class="nd">@i_max</span><span class="o">.</span><span class="n">setter</span>

    <span class="k">def</span> <span class="nf">i_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]):</span>

        <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">lim</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="kp">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_integral_limits</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_i_max</span> <span class="o">=</span> <span class="n">lim</span>

    <span class="nd">@i_min</span><span class="o">.</span><span class="n">setter</span>

    <span class="k">def</span> <span class="nf">i_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]):</span>

        <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">lim</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="kp">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_integral_limits</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_i_min</span> <span class="o">=</span> <span class="n">lim</span>

    <span class="nd">@property</span>

    <span class="k">def</span> <span class="nf">p_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Proportional error(s) (Read-only)&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_error</span>

    <span class="nd">@property</span>

    <span class="k">def</span> <span class="nf">i_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Integral error(s) (Read-only)&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_error</span>

    <span class="nd">@property</span>

    <span class="k">def</span> <span class="nf">d_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Derivative error(s) (Read-only)&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_error</span>

    <span class="nd">@property</span>

    <span class="k">def</span> <span class="nf">cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read-only access to the latest command.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;String representation of the current state of the controller.&quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;p_gain:  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_gain</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;i_gain:  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i_gain</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;d_gain:  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_gain</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;i_min:   &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i_min</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;i_max:   &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i_max</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;p_error: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_error</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;i_error: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i_error</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;d_error: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_error</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;cmd:     &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span>

        <span class="bp">self</span><span class="p">,</span> <span class="n">p_error</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the PID controller state</span>

<span class="sd">        Args:</span>

<span class="sd">            p_error (npt.ArrayLike): Error since last iteration (target - state)</span>

<span class="sd">            dt (Optional[float]): Change in time since the last iteration, in seconds. Defaults to None,</span>

<span class="sd">                in which case the system clock will be used to determine the delta</span>

<span class="sd">        Returns:</span>

<span class="sd">            npt.ArrayLike: PID controller output. Array if we have a MIMO system, float if SISO</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Validate error input</span>

        <span class="n">p_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">atleast_1d</span><span class="p">(</span><span class="n">p_error</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_error</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>

                <span class="sa">f</span><span class="s2">&quot;Invalid error term.</span><span class="se">\n</span><span class="s2">Expected an array of length </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">p_error</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_p_error</span> <span class="o">=</span> <span class="n">p_error</span>

        <span class="c1"># Validate dt input</span>

        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_last_time</span> <span class="o">=</span> <span class="n">cur_time</span>

                <span class="c1"># TODO decide why they put this line here (below)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_p_error_last</span> <span class="o">=</span> <span class="n">p_error</span>

            <span class="n">dt</span> <span class="o">=</span> <span class="n">cur_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_time</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_last_time</span> <span class="o">=</span> <span class="n">cur_time</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="kp">isnan</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="kp">isinf</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Proportional component</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_gain_matrices</span><span class="p">:</span>

            <span class="n">p_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_gain</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_error</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">p_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_gain</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_error</span>

        <span class="c1"># Integral component</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_i_error</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_error</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_gain_matrices</span><span class="p">:</span>

            <span class="n">i_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_gain</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_error</span>

            <span class="n">i_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">clip</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_max</span><span class="p">)</span>

            <span class="n">i_gain_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_gain</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i_error</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span> <span class="n">i_gain_diag</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="s2">&quot;original&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">i_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_gain</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_error</span>

            <span class="c1"># Saturate the integral term to prevent it from getting too large</span>

            <span class="n">i_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">clip</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_max</span><span class="p">)</span>

            <span class="c1"># Update the integral error based on the saturated value, using safe division where gain is nonzero</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_i_error</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_gain</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="s2">&quot;original&quot;</span><span class="p">)</span>

        <span class="c1"># Derivative component</span>

        <span class="c1"># If the timestep is 0, we can&#39;t calculate the derivative term, so set it to 0</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_d_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_d_error</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p_error</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_error_last</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_gain_matrices</span><span class="p">:</span>

            <span class="n">d_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_gain</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_error</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">d_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_gain</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_error</span>

        <span class="c1"># Store the proportional errors for calculating the derivative term in the next iteration</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_p_error_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_error</span>

        <span class="c1"># Calculate the PID control command</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cmd</span> <span class="o">=</span> <span class="n">p_term</span> <span class="o">+</span> <span class="n">i_term</span> <span class="o">+</span> <span class="n">d_term</span>

        <span class="c1"># Unpack the np array if we are dealing with a singleton dimension</span>

        <span class="c1"># TODO decide if this is the right choice here</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd</span>

<span class="k">def</span> <span class="nf">plot_controller_history</span><span class="p">(</span>

    <span class="n">history</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>

    <span class="n">target</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>

    <span class="n">p_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="n">i_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="n">d_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots the state history of variables controlled by a PID controller</span>

<span class="sd">    Args:</span>

<span class="sd">        history (np.ndarray): History of the variables through the duration of the control process,</span>

<span class="sd">            in an array of shape (num_variables, num_timesteps)</span>

<span class="sd">        target (Union[npt.ArrayLike, float]): Desired value(s) for the controlled variables</span>

<span class="sd">        p_gain (Union[npt.ArrayLike, float, None], optional): Proportional gain(s).</span>

<span class="sd">            Include this to print the gain value(s) onto the subplots. Defaults to None.</span>

<span class="sd">        i_gain (Union[npt.ArrayLike, float, None], optional): Integral gain(s). Defaults to None.</span>

<span class="sd">            Include this to print the gain value(s) onto the subplots. Defaults to None.</span>

<span class="sd">        d_gain (Union[npt.ArrayLike, float, None], optional): Derivative gain(s). Defaults to None.</span>

<span class="sd">            Include this to print the gain value(s) onto the subplots. Defaults to None.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Ensure the dimensions of the arrays so that indexing works properly</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">atleast_2d</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

    <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">atleast_1d</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p_gain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">p_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">atleast_1d</span><span class="p">(</span><span class="n">p_gain</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i_gain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">i_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">atleast_1d</span><span class="p">(</span><span class="n">i_gain</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">d_gain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">d_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">atleast_1d</span><span class="p">(</span><span class="n">d_gain</span><span class="p">)</span>

    <span class="n">n</span><span class="p">,</span> <span class="n">nt</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="kp">shape</span>

    <span class="n">fig_shape</span> <span class="o">=</span> <span class="n">num_subplots_to_shape</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="c1"># Plot the history of each variable on its own subplot</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="o">*</span><span class="n">fig_shape</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">timesteps</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="kp">ones</span><span class="p">(</span><span class="n">nt</span><span class="p">),</span> <span class="s2">&quot;k--&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="s2">&quot;b&quot;</span><span class="p">)</span>

        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Var. </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># If the P/I/D gains are provided, include info about the gains for that</span>

        <span class="c1"># control variable in the bottom right corner of the respective subplot</span>

        <span class="n">pid_info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">p_gain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">pid_info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;P: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">p_gain</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">i_gain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">pid_info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;I: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">i_gain</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">d_gain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">pid_info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;D: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">d_gain</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>

            <span class="mf">0.98</span><span class="p">,</span>

            <span class="mf">0.02</span><span class="p">,</span>

            <span class="n">pid_info</span><span class="p">,</span>

            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>

            <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>

            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># Quick check that it&#39;s working</span>

    <span class="c1"># See test/test_pid for proper test cases</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scalar example with auto-timestep&quot;</span><span class="p">)</span>

    <span class="n">controller</span> <span class="o">=</span> <span class="n">PID</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>

    <span class="n">controller</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>

    <span class="n">controller</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Array example with fixed timestep&quot;</span><span class="p">)</span>

    <span class="n">controller</span> <span class="o">=</span> <span class="n">PID</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>

    <span class="n">controller</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>

    <span class="n">controller</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
</code></pre></div>

</details>
<h2 id="functions">Functions</h2>
<h3 id="plot_controller_history">plot_controller_history</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_controller_history</span><span class="p">(</span>
    <span class="n">history</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">p_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">i_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">d_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<p>Plots the state history of variables controlled by a PID controller</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>history</td>
<td>np.ndarray</td>
<td>History of the variables through the duration of the control process,<br>in an array of shape (num_variables, num_timesteps)</td>
<td>None</td>
</tr>
<tr>
<td>target</td>
<td>Union[npt.ArrayLike, float]</td>
<td>Desired value(s) for the controlled variables</td>
<td>None</td>
</tr>
<tr>
<td>p_gain</td>
<td>Union[npt.ArrayLike, float, None]</td>
<td>Proportional gain(s).<br>Include this to print the gain value(s) onto the subplots. Defaults to None.</td>
<td>None</td>
</tr>
<tr>
<td>i_gain</td>
<td>Union[npt.ArrayLike, float, None]</td>
<td>Integral gain(s). Defaults to None.<br>Include this to print the gain value(s) onto the subplots. Defaults to None.</td>
<td>None</td>
</tr>
<tr>
<td>d_gain</td>
<td>Union[npt.ArrayLike, float, None]</td>
<td>Derivative gain(s). Defaults to None.<br>Include this to print the gain value(s) onto the subplots. Defaults to None.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">plot_controller_history</span><span class="p">(</span>

<span class="w">    </span><span class="nl">history</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span>

<span class="w">    </span><span class="nl">target</span><span class="p">:</span><span class="w"> </span><span class="ow">Union</span><span class="o">[</span><span class="n">npt.ArrayLike, float</span><span class="o">]</span><span class="p">,</span>

<span class="w">    </span><span class="nl">p_gain</span><span class="p">:</span><span class="w"> </span><span class="ow">Union</span><span class="o">[</span><span class="n">npt.ArrayLike, float, None</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="nl">i_gain</span><span class="p">:</span><span class="w"> </span><span class="ow">Union</span><span class="o">[</span><span class="n">npt.ArrayLike, float, None</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="nl">d_gain</span><span class="p">:</span><span class="w"> </span><span class="ow">Union</span><span class="o">[</span><span class="n">npt.ArrayLike, float, None</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="p">)</span><span class="err">:</span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;Plots the state history of variables controlled by a PID controller</span>

<span class="ss">    Args:</span>

<span class="ss">        history (np.ndarray): History of the variables through the duration of the control process,</span>

<span class="ss">            in an array of shape (num_variables, num_timesteps)</span>

<span class="ss">        target (Union[npt.ArrayLike, float]): Desired value(s) for the controlled variables</span>

<span class="ss">        p_gain (Union[npt.ArrayLike, float, None], optional): Proportional gain(s).</span>

<span class="ss">            Include this to print the gain value(s) onto the subplots. Defaults to None.</span>

<span class="ss">        i_gain (Union[npt.ArrayLike, float, None], optional): Integral gain(s). Defaults to None.</span>

<span class="ss">            Include this to print the gain value(s) onto the subplots. Defaults to None.</span>

<span class="ss">        d_gain (Union[npt.ArrayLike, float, None], optional): Derivative gain(s). Defaults to None.</span>

<span class="ss">            Include this to print the gain value(s) onto the subplots. Defaults to None.</span>

<span class="ss">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Ensure</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dimensions</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">arrays</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">indexing</span><span class="w"> </span><span class="n">works</span><span class="w"> </span><span class="n">properly</span>

<span class="w">    </span><span class="n">history</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

<span class="w">    </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">p_gain</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">        </span><span class="n">p_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">p_gain</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i_gain</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">        </span><span class="n">i_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">i_gain</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">d_gain</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">        </span><span class="n">d_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">d_gain</span><span class="p">)</span>

<span class="w">    </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">nt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">history</span><span class="p">.</span><span class="n">shape</span>

<span class="w">    </span><span class="n">fig_shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_subplots_to_shape</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="w">    </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Plot</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">history</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">variable</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">own</span><span class="w"> </span><span class="n">subplot</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="o">*</span><span class="n">fig_shape</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">        </span><span class="n">timesteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nt</span><span class="p">),</span><span class="w"> </span><span class="ss">&quot;k--&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span><span class="w"> </span><span class="n">history</span><span class="o">[</span><span class="n">i, :</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;b&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="ss">&quot;Var. {i+1}&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">P</span><span class="o">/</span><span class="n">I</span><span class="o">/</span><span class="n">D</span><span class="w"> </span><span class="n">gains</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">provided</span><span class="p">,</span><span class="w"> </span><span class="k">include</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gains</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">that</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="k">variable</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">bottom</span><span class="w"> </span><span class="nf">right</span><span class="w"> </span><span class="n">corner</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">respective</span><span class="w"> </span><span class="n">subplot</span>

<span class="w">        </span><span class="n">pid_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">p_gain</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">pid_info</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">f</span><span class="ss">&quot;P: {round(p_gain[i], 3)}\n&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">i_gain</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">pid_info</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">f</span><span class="ss">&quot;I: {round(i_gain[i], 3)}\n&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">d_gain</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">pid_info</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">f</span><span class="ss">&quot;D: {round(d_gain[i], 3)}&quot;</span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="nc">text</span><span class="p">(</span>

<span class="w">            </span><span class="mf">0.98</span><span class="p">,</span>

<span class="w">            </span><span class="mf">0.02</span><span class="p">,</span>

<span class="w">            </span><span class="n">pid_info</span><span class="p">,</span>

<span class="w">            </span><span class="n">horizontalalignment</span><span class="o">=</span><span class="ss">&quot;right&quot;</span><span class="p">,</span>

<span class="w">            </span><span class="n">verticalalignment</span><span class="o">=</span><span class="ss">&quot;bottom&quot;</span><span class="p">,</span>

<span class="w">            </span><span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="p">.</span><span class="n">transAxes</span><span class="p">,</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

<span class="w">    </span><span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

</details>
<h2 id="classes">Classes</h2>
<h3 id="pid">PID</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PID</span><span class="p">(</span>
    <span class="n">p_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">i_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">d_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">i_min</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">i_max</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<p>An extended version of a PID controller compatible with multivariate systems</p>
<p>This class implements the standard pid equation:</p>
<p>$command = p_{term} + i_{term} + d_{term} $</p>
<p>where:</p>
<p>$ p_{term} = p_{gain} * p_{error} $
$ i_{term} = i_{gain} * i_{error} $
$ d_{term} = d_{gain} * d_{error} $
$ i_{error} = i_{error} + p_{error} * dt $
$ d_{error} = (p_{error} - p_{error last}) / dt $</p>
<p>given:</p>
<p>$ p_{error} = p_{target} - p_{state} $.</p>
<ul>
<li>For a SISO system, pass in the gains as scalars</li>
<li>For a decoupled MIMO system, pass in the gains as lists, 1d arrays, or diagonal matrices</li>
<li>For a general MIMO system, pass in the gains as matrices</li>
<li>Integral limits are scalar for SISO, 1d array for MIMO.</li>
</ul>
<h4 id="attributes">Attributes</h4>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>p_gain</td>
<td>npt.ArrayLike</td>
<td>Proportional gain(s).</td>
<td>None</td>
</tr>
<tr>
<td>i_gain</td>
<td>npt.ArrayLike</td>
<td>Integral gain(s).</td>
<td>None</td>
</tr>
<tr>
<td>d_gain</td>
<td>npt.ArrayLike</td>
<td>Derivative gain(s).</td>
<td>None</td>
</tr>
<tr>
<td>i_min</td>
<td>Optional[npt.ArrayLike]</td>
<td>Minimum value(s) for the integral term(s).<br>Defaults to None, in which case the integral term(s) will be unbounded below</td>
<td>None</td>
</tr>
<tr>
<td>i_max</td>
<td>Optional[npt.ArrayLike]</td>
<td>Maximum value(s) for the integral term(s).<br>Defaults to None, in which case the integral term(s) will be unbounded above</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nl">PID</span><span class="p">:</span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;An extended version of a PID controller compatible with multivariate systems</span>

<span class="ss">    This class implements the standard pid equation:</span>

<span class="ss">    $command = p_{term} + i_{term} + d_{term} $</span>

<span class="ss">    where:</span>

<span class="ss">    $ p_{term} = p_{gain} * p_{error} $</span>

<span class="ss">    $ i_{term} = i_{gain} * i_{error} $</span>

<span class="ss">    $ d_{term} = d_{gain} * d_{error} $</span>

<span class="ss">    $ i_{error} = i_{error} + p_{error} * dt $</span>

<span class="ss">    $ d_{error} = (p_{error} - p_{error last}) / dt $</span>

<span class="ss">    given:</span>

<span class="ss">    $ p_{error} = p_{target} - p_{state} $.</span>

<span class="ss">    - For a SISO system, pass in the gains as scalars</span>

<span class="ss">    - For a decoupled MIMO system, pass in the gains as lists, 1d arrays, or diagonal matrices</span>

<span class="ss">    - For a general MIMO system, pass in the gains as matrices</span>

<span class="ss">    - Integral limits are scalar for SISO, 1d array for MIMO.</span>

<span class="ss">    Args:</span>

<span class="ss">        p_gain (npt.ArrayLike): Proportional gain(s).</span>

<span class="ss">        i_gain (npt.ArrayLike): Integral gain(s).</span>

<span class="ss">        d_gain (npt.ArrayLike): Derivative gain(s).</span>

<span class="ss">        i_min (Optional[npt.ArrayLike]): Minimum value(s) for the integral term(s).</span>

<span class="ss">            Defaults to None, in which case the integral term(s) will be unbounded below</span>

<span class="ss">        i_max (Optional[npt.ArrayLike]): Maximum value(s) for the integral term(s).</span>

<span class="ss">            Defaults to None, in which case the integral term(s) will be unbounded above</span>

<span class="ss">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">p_gain</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">i_gain</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">d_gain</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">i_min</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">npt.ArrayLike</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">i_max</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">npt.ArrayLike</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">proportional</span><span class="w"> </span><span class="n">gain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">baseline</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">comparison</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="ow">some</span><span class="w"> </span><span class="n">shapes</span><span class="o">/</span><span class="n">sizes</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">help</span><span class="w"> </span><span class="n">distinguish</span><span class="w"> </span><span class="ow">between</span><span class="w"> </span><span class="n">scalar</span><span class="o">/</span><span class="k">array</span><span class="o">/</span><span class="n">matrix</span><span class="w"> </span><span class="n">methods</span>

<span class="w">        </span><span class="n">reference_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">p_gain</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_gain_shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reference_gain</span><span class="p">.</span><span class="n">shape</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_gain_shape</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">using_gain_matrices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reference_gain</span><span class="p">.</span><span class="n">ndim</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">set_gains</span><span class="p">(</span><span class="n">p_gain</span><span class="p">,</span><span class="w"> </span><span class="n">i_gain</span><span class="p">,</span><span class="w"> </span><span class="n">d_gain</span><span class="p">,</span><span class="w"> </span><span class="n">i_min</span><span class="p">,</span><span class="w"> </span><span class="n">i_max</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">reset</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Reset the state of the PID controller&quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Save</span><span class="w"> </span><span class="k">position</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">derivative</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="n">calculation</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Proportional</span><span class="w"> </span><span class="n">error</span><span class="p">.</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_d_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Derivative</span><span class="w"> </span><span class="n">error</span><span class="p">.</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Integator</span><span class="w"> </span><span class="n">error</span><span class="p">.</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">send</span><span class="p">.</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">automatic</span><span class="w"> </span><span class="n">calculation</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">dt</span><span class="p">.</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">set_gains</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">p_gain</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">i_gain</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">d_gain</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span>

<span class="w">        </span><span class="nl">i_min</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">npt.ArrayLike</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">i_max</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">npt.ArrayLike</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Sets the PID gains for the controller.</span>

<span class="ss">        Gains are scalar for SISO, 1d array for decoupled MIMO, matrix for general MIMO</span>

<span class="ss">        Integral limits are scalar for SISO, 1d array for MIMO.</span>

<span class="ss">        Args:</span>

<span class="ss">            p_gain (npt.ArrayLike): Proportional gain(s).</span>

<span class="ss">            i_gain (npt.ArrayLike): Integral gain(s).</span>

<span class="ss">            d_gain (npt.ArrayLike): Derivative gain(s).</span>

<span class="ss">            i_min (Optional[npt.ArrayLike]): Minimum value(s) for the integral term(s).</span>

<span class="ss">                Defaults to None, in which case the integral term(s) will be unbounded below</span>

<span class="ss">            i_max (Optional[npt.ArrayLike]): Maximum value(s) for the integral term(s).</span>

<span class="ss">                Defaults to None, in which case the integral term(s) will be unbounded above</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Call</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">setter</span><span class="w"> </span><span class="n">functions</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="n">validate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">inputs</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">p_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_gain</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">i_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i_gain</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">d_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_gain</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">i_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i_min</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">i_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i_max</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">p_gain</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Proportional gain(s)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_gain</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">i_gain</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Integral gain(s)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_gain</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">d_gain</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Derivative gain(s)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_d_gain</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">i_max</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Maximum value(s) of the integral term(s)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_max</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">i_min</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Minimum value(s) of the integral term(s)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_min</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_validate_gain</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">gain</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Ensures that the gain(s) are the correct shape and are nonnegative (raises an error otherwise)</span>

<span class="ss">        Args:</span>

<span class="ss">            gain (npt.ArrayLike): P, I, or D gain(s)</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Validated gain(s)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">gain</span><span class="p">.</span><span class="n">shape</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">_gain_shape</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="n">f</span><span class="ss">&quot;Shape mismatch: Expected gain to have shape {self._gain_shape}, got {gain.shape}&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="ow">any</span><span class="p">(</span><span class="n">gain</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="err">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Negative gains will cause instability.\nGot: {gain}&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">gain</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_validate_integral_limits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">lim</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Ensures that the integral term limit(s) are the correct shape (raises an error otherwise)</span>

<span class="ss">        Args:</span>

<span class="ss">            lim (npt.ArrayLike): Limit(s) (minimum or maximum) on the integral term(s)</span>

<span class="ss">        Returns:</span>

<span class="ss">            np.ndarray: Validated limit(s)</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">n</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="n">f</span><span class="ss">&quot;Invalid integral limit.\nExpected an array of length {self.n}, got {lim}&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">lim</span>

<span class="w">    </span><span class="nv">@p_gain</span><span class="p">.</span><span class="n">setter</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">p_gain</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">gain</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="n">gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_validate_gain</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_p_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gain</span>

<span class="w">    </span><span class="nv">@i_gain</span><span class="p">.</span><span class="n">setter</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">i_gain</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">gain</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="n">gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_validate_gain</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">using_gain_matrices</span><span class="p">:</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">Extra</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">ensure</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gain</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">diagonal</span><span class="w"> </span><span class="p">(</span><span class="n">decoupled</span><span class="p">)</span><span class="w"> </span><span class="n">because</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">determining</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">integral</span><span class="w"> </span><span class="n">saturation</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="ow">some</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="k">work</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">is_diagonal</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span><span class="err">:</span>

<span class="w">                </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                    </span><span class="ss">&quot;Coupling between the integral gains is not currently supported&quot;</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_i_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gain</span>

<span class="w">    </span><span class="nv">@d_gain</span><span class="p">.</span><span class="n">setter</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">d_gain</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">gain</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="n">gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_validate_gain</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_d_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gain</span>

<span class="w">    </span><span class="nv">@i_max</span><span class="p">.</span><span class="n">setter</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">i_max</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">lim</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">npt.ArrayLike</span><span class="o">]</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">lim</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">float</span><span class="p">(</span><span class="ss">&quot;inf&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_validate_integral_limits</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_i_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lim</span>

<span class="w">    </span><span class="nv">@i_min</span><span class="p">.</span><span class="n">setter</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">i_min</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">lim</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">npt.ArrayLike</span><span class="o">]</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">lim</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">float</span><span class="p">(</span><span class="ss">&quot;-inf&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_validate_integral_limits</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_i_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lim</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">p_error</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Proportional error(s) (Read-only)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">i_error</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Integral error(s) (Read-only)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">d_error</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Derivative error(s) (Read-only)&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_d_error</span>

<span class="w">    </span><span class="nv">@property</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">cmd</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Read-only access to the latest command.&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_cmd</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__str__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;String representation of the current state of the controller.&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;&quot;</span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="ss">&quot;p_gain:  &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">p_gain</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="ss">&quot;i_gain:  &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">i_gain</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="ss">&quot;d_gain:  &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">d_gain</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="ss">&quot;i_min:   &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">i_min</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="ss">&quot;i_max:   &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">i_max</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="ss">&quot;p_error: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">p_error</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="ss">&quot;i_error: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">i_error</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="ss">&quot;d_error: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">d_error</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="ss">&quot;cmd:     &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">result</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">update</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">p_error</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span><span class="w"> </span><span class="nl">dt</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="nl">ArrayLike</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Update the PID controller state</span>

<span class="ss">        Args:</span>

<span class="ss">            p_error (npt.ArrayLike): Error since last iteration (target - state)</span>

<span class="ss">            dt (Optional[float]): Change in time since the last iteration, in seconds. Defaults to None,</span>

<span class="ss">                in which case the system clock will be used to determine the delta</span>

<span class="ss">        Returns:</span>

<span class="ss">            npt.ArrayLike: PID controller output. Array if we have a MIMO system, float if SISO</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Validate</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="k">input</span>

<span class="w">        </span><span class="n">p_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">p_error</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">p_error</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">n</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="n">f</span><span class="ss">&quot;Invalid error term.\nExpected an array of length {self.n}, got {p_error}&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_error</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Validate</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="k">input</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">cur_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">time</span><span class="p">.</span><span class="nc">time</span><span class="p">()</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_last_time</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">_last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_time</span>

<span class="w">                </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">decide</span><span class="w"> </span><span class="n">why</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="p">(</span><span class="n">below</span><span class="p">)</span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_error</span>

<span class="w">            </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_last_time</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_time</span>

<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">math</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">math</span><span class="p">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Proportional</span><span class="w"> </span><span class="n">component</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">using_gain_matrices</span><span class="p">:</span>

<span class="w">            </span><span class="n">p_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_gain</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">p_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_gain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Integral</span><span class="w"> </span><span class="n">component</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">using_gain_matrices</span><span class="p">:</span>

<span class="w">            </span><span class="n">i_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_gain</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span>

<span class="w">            </span><span class="n">i_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_min</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_max</span><span class="p">)</span>

<span class="w">            </span><span class="n">i_gain_diag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">diag</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_i_gain</span><span class="p">)</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">safe_divide</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span><span class="w"> </span><span class="n">i_gain_diag</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="ss">&quot;original&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">i_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_gain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">Saturate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">integral</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">prevent</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">getting</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="k">large</span>

<span class="w">            </span><span class="n">i_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_min</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_max</span><span class="p">)</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="k">Update</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">integral</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">saturated</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">safe</span><span class="w"> </span><span class="n">division</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">gain</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">nonzero</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">safe_divide</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_gain</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="ss">&quot;original&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Derivative</span><span class="w"> </span><span class="n">component</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">timestep</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="err">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">calculate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">derivative</span><span class="w"> </span><span class="n">term</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nf">abs</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1e-8</span><span class="err">:</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_d_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_d_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error_last</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dt</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">using_gain_matrices</span><span class="p">:</span>

<span class="w">            </span><span class="n">d_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_d_gain</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_d_error</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">d_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_d_gain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_d_error</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">proportional</span><span class="w"> </span><span class="n">errors</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">calculating</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">derivative</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="n">iteration</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">PID</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="n">command</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_term</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i_term</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d_term</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Unpack</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">np</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">dealing</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">singleton</span><span class="w"> </span><span class="n">dimension</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">decide</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nf">right</span><span class="w"> </span><span class="n">choice</span><span class="w"> </span><span class="n">here</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_cmd</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_cmd</span>
</code></pre></div>

</details>
<hr />
<h4 id="instance-variables">Instance variables</h4>
<div class="codehilite"><pre><span></span><code><span class="n">cmd</span>
</code></pre></div>

<p>Read-only access to the latest command.</p>
<div class="codehilite"><pre><span></span><code><span class="n">d_error</span>
</code></pre></div>

<p>Derivative error(s) (Read-only)</p>
<div class="codehilite"><pre><span></span><code><span class="n">d_gain</span>
</code></pre></div>

<p>Derivative gain(s)</p>
<div class="codehilite"><pre><span></span><code><span class="n">i_error</span>
</code></pre></div>

<p>Integral error(s) (Read-only)</p>
<div class="codehilite"><pre><span></span><code><span class="n">i_gain</span>
</code></pre></div>

<p>Integral gain(s)</p>
<div class="codehilite"><pre><span></span><code><span class="n">i_max</span>
</code></pre></div>

<p>Maximum value(s) of the integral term(s)</p>
<div class="codehilite"><pre><span></span><code><span class="n">i_min</span>
</code></pre></div>

<p>Minimum value(s) of the integral term(s)</p>
<div class="codehilite"><pre><span></span><code><span class="n">p_error</span>
</code></pre></div>

<p>Proportional error(s) (Read-only)</p>
<div class="codehilite"><pre><span></span><code><span class="n">p_gain</span>
</code></pre></div>

<p>Proportional gain(s)</p>
<h4 id="methods">Methods</h4>
<h4 id="reset">reset</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">reset</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>Reset the state of the PID controller</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def reset(self):

        &quot;&quot;&quot;Reset the state of the PID controller&quot;&quot;&quot;

        # Save position state for derivative state calculation

        self._p_error_last = np.zeros(self.n)

        self._p_error = np.zeros(self.n)  # Proportional error.

        self._d_error = np.zeros(self.n)  # Derivative error.

        self._i_error = np.zeros(self.n)  # Integator error.

        self._cmd = 0 if self.n == 1 else np.zeros(self.n)  # Command to send.

        self._last_time = None  # Used for automatic calculation of dt.
</code></pre></div>

</details>
<h4 id="set_gains">set_gains</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">set_gains</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">p_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">i_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">d_gain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">i_min</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">i_max</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<p>Sets the PID gains for the controller.</p>
<p>Gains are scalar for SISO, 1d array for decoupled MIMO, matrix for general MIMO
Integral limits are scalar for SISO, 1d array for MIMO.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>p_gain</td>
<td>npt.ArrayLike</td>
<td>Proportional gain(s).</td>
<td>None</td>
</tr>
<tr>
<td>i_gain</td>
<td>npt.ArrayLike</td>
<td>Integral gain(s).</td>
<td>None</td>
</tr>
<tr>
<td>d_gain</td>
<td>npt.ArrayLike</td>
<td>Derivative gain(s).</td>
<td>None</td>
</tr>
<tr>
<td>i_min</td>
<td>Optional[npt.ArrayLike]</td>
<td>Minimum value(s) for the integral term(s).<br>Defaults to None, in which case the integral term(s) will be unbounded below</td>
<td>None</td>
</tr>
<tr>
<td>i_max</td>
<td>Optional[npt.ArrayLike]</td>
<td>Maximum value(s) for the integral term(s).<br>Defaults to None, in which case the integral term(s) will be unbounded above</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def set_gains(

        self,

        p_gain: npt.ArrayLike,

        i_gain: npt.ArrayLike,

        d_gain: npt.ArrayLike,

        i_min: Optional[npt.ArrayLike] = None,

        i_max: Optional[npt.ArrayLike] = None,

    ):

        &quot;&quot;&quot;Sets the PID gains for the controller.

        Gains are scalar for SISO, 1d array for decoupled MIMO, matrix for general MIMO

        Integral limits are scalar for SISO, 1d array for MIMO.

        Args:

            p_gain (npt.ArrayLike): Proportional gain(s).

            i_gain (npt.ArrayLike): Integral gain(s).

            d_gain (npt.ArrayLike): Derivative gain(s).

            i_min (Optional[npt.ArrayLike]): Minimum value(s) for the integral term(s).

                Defaults to None, in which case the integral term(s) will be unbounded below

            i_max (Optional[npt.ArrayLike]): Maximum value(s) for the integral term(s).

                Defaults to None, in which case the integral term(s) will be unbounded above

        &quot;&quot;&quot;

        # Call the setter functions, which will auto-validate the inputs

        self.p_gain = p_gain

        self.i_gain = i_gain

        self.d_gain = d_gain

        self.i_min = i_min

        self.i_max = i_max
</code></pre></div>

</details>
<h4 id="update">update</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">p_error</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]],</span>
    <span class="n">dt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_array_like</span><span class="o">.</span><span class="n">_SupportsArray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">_nested_sequence</span><span class="o">.</span><span class="n">_NestedSequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]]</span>
</code></pre></div>

<p>Update the PID controller state</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>p_error</td>
<td>npt.ArrayLike</td>
<td>Error since last iteration (target - state)</td>
<td>None</td>
</tr>
<tr>
<td>dt</td>
<td>Optional[float]</td>
<td>Change in time since the last iteration, in seconds. Defaults to None,<br>in which case the system clock will be used to determine the delta</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>npt.ArrayLike</td>
<td>PID controller output. Array if we have a MIMO system, float if SISO</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">update</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">p_error</span><span class="p">:</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="n">ArrayLike</span><span class="p">,</span><span class="w"> </span><span class="nl">dt</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">npt</span><span class="p">.</span><span class="nl">ArrayLike</span><span class="p">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Update the PID controller state</span>

<span class="ss">        Args:</span>

<span class="ss">            p_error (npt.ArrayLike): Error since last iteration (target - state)</span>

<span class="ss">            dt (Optional[float]): Change in time since the last iteration, in seconds. Defaults to None,</span>

<span class="ss">                in which case the system clock will be used to determine the delta</span>

<span class="ss">        Returns:</span>

<span class="ss">            npt.ArrayLike: PID controller output. Array if we have a MIMO system, float if SISO</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Validate</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="k">input</span>

<span class="w">        </span><span class="n">p_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">p_error</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">p_error</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">n</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="n">f</span><span class="ss">&quot;Invalid error term.\nExpected an array of length {self.n}, got {p_error}&quot;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_error</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Validate</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="k">input</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">cur_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">time</span><span class="p">.</span><span class="nc">time</span><span class="p">()</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_last_time</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">_last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_time</span>

<span class="w">                </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">decide</span><span class="w"> </span><span class="n">why</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="p">(</span><span class="n">below</span><span class="p">)</span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_error</span>

<span class="w">            </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_last_time</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_time</span>

<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">math</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">math</span><span class="p">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Proportional</span><span class="w"> </span><span class="n">component</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">using_gain_matrices</span><span class="p">:</span>

<span class="w">            </span><span class="n">p_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_gain</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">p_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_gain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Integral</span><span class="w"> </span><span class="n">component</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">using_gain_matrices</span><span class="p">:</span>

<span class="w">            </span><span class="n">i_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_gain</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span>

<span class="w">            </span><span class="n">i_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_min</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_max</span><span class="p">)</span>

<span class="w">            </span><span class="n">i_gain_diag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">diag</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_i_gain</span><span class="p">)</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">safe_divide</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span><span class="w"> </span><span class="n">i_gain_diag</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="ss">&quot;original&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">i_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_gain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">Saturate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">integral</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">prevent</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">getting</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="k">large</span>

<span class="w">            </span><span class="n">i_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_min</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_max</span><span class="p">)</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="k">Update</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">integral</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">saturated</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">safe</span><span class="w"> </span><span class="n">division</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">gain</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">nonzero</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_i_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">safe_divide</span><span class="p">(</span><span class="n">i_term</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_i_gain</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="ss">&quot;original&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Derivative</span><span class="w"> </span><span class="n">component</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">timestep</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="err">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">calculate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">derivative</span><span class="w"> </span><span class="n">term</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nf">abs</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1e-8</span><span class="err">:</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_d_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_d_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error_last</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dt</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nl">using_gain_matrices</span><span class="p">:</span>

<span class="w">            </span><span class="n">d_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_d_gain</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_d_error</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">d_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_d_gain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_d_error</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">proportional</span><span class="w"> </span><span class="n">errors</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">calculating</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">derivative</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="n">iteration</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_p_error</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">PID</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="n">command</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_term</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i_term</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d_term</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Unpack</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">np</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">dealing</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">singleton</span><span class="w"> </span><span class="n">dimension</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">decide</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nf">right</span><span class="w"> </span><span class="n">choice</span><span class="w"> </span><span class="n">here</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_cmd</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_cmd</span>
</code></pre></div>

</details>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        
<footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../physics_models/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Physics Models" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                Physics Models
              </div>
            </div>
          </a>
        
        
          
          <a href="../../core/abstract_bag/" class="md-footer__link md-footer__link--next" aria-label="Next: Abstract Bag" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Abstract Bag
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
            
            Powered by
            <a href="http://timothycrosley.github.io/portray">portray.</a>
            You too can
            <a href="http://timothycrosley.github.io/portray">
              portray</a>
            your Python project well using automatic documentation.
          </div>
        
      </div>
    </div>
  </footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>